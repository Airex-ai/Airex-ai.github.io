<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="Airex Yu">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2023/02/20/tensorrt/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="TensorRTTensorRTæ˜¯ä»€ä¹ˆTensorRTæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„æ·±åº¦å­¦ä¹ æ¨ç†ï¼ˆInferenceï¼‰ä¼˜åŒ–å™¨ï¼Œå¯ä»¥ä¸ºæ·±åº¦å­¦ä¹ åº”ç”¨æä¾›ä½å»¶è¿Ÿã€é«˜ååç‡çš„éƒ¨ç½²æ¨ç†ã€‚TensorRTå¯ç”¨äºå¯¹è¶…å¤§è§„æ¨¡æ•°æ®ä¸­å¿ƒã€åµŒå…¥å¼å¹³å°æˆ–è‡ªåŠ¨é©¾é©¶å¹³å°è¿›è¡Œæ¨ç†åŠ é€Ÿã€‚TensorRTç°å·²èƒ½æ”¯æŒTensorFlowã€Caffeã€Mxnetã€Pytorchç­‰å‡ ä¹æ‰€æœ‰çš„æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œå°†TensorRTå’ŒNVIDIAçš„GPUç»“åˆèµ·æ¥">
<meta property="og:type" content="article">
<meta property="og:title" content="TensorRT">
<meta property="og:url" content="http://example.com/2023/02/20/TensorRT/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="TensorRTTensorRTæ˜¯ä»€ä¹ˆTensorRTæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„æ·±åº¦å­¦ä¹ æ¨ç†ï¼ˆInferenceï¼‰ä¼˜åŒ–å™¨ï¼Œå¯ä»¥ä¸ºæ·±åº¦å­¦ä¹ åº”ç”¨æä¾›ä½å»¶è¿Ÿã€é«˜ååç‡çš„éƒ¨ç½²æ¨ç†ã€‚TensorRTå¯ç”¨äºå¯¹è¶…å¤§è§„æ¨¡æ•°æ®ä¸­å¿ƒã€åµŒå…¥å¼å¹³å°æˆ–è‡ªåŠ¨é©¾é©¶å¹³å°è¿›è¡Œæ¨ç†åŠ é€Ÿã€‚TensorRTç°å·²èƒ½æ”¯æŒTensorFlowã€Caffeã€Mxnetã€Pytorchç­‰å‡ ä¹æ‰€æœ‰çš„æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œå°†TensorRTå’ŒNVIDIAçš„GPUç»“åˆèµ·æ¥">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221202104187-168493652323424.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221200627437-168493652323425.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221200708531-168493652323426.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221203344296-168493652323427.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221151604138-168493652323428.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221210110614-168493652323429.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221210123906-168493652323430.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221151952678-168493652323431.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221154127768-168493652323432.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221155924683-168493652323433.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221162707928-168493652323434.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230224092537580-168493652323435.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230224093014841-168493652323436.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230224094858275-168493652323437.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230224095026719-168493652323438.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230224095059801-168493652323439.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230224095136553-168493652323541.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230224095222434-168493652323540.png">
<meta property="og:image" content="https://github.com/HeKun-NVIDIA/TensorRT-Developer_Guide_in_Chinese/raw/main/7.TensorRT%E4%B8%AD%E7%9A%84INT8/q-dq-placement6.png">
<meta property="og:image" content="https://github.com/HeKun-NVIDIA/TensorRT-Developer_Guide_in_Chinese/raw/main/7.TensorRT%E4%B8%AD%E7%9A%84INT8/sub-optimal.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230224100753426-168493652323542.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230224104755566-168493652323543.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230220094750628-16849365232331.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230220101057791-16849365232332.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230220103617774-16849365232333.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221082244538-16849365232334.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221082316063-16849365232335.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221082544827-16849365232336.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221083048073-16849365232337.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221085107849-16769406687161-16849365232338.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221090526167-16849365232339.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221090939235-168493652323310.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221092555385-168493652323411.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221092623949-168493652323412.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221092806781-168493652323413.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221095444973-168493652323414.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221095945685-168493652323415.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221105750138-168493652323416.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221110212885-168493652323417.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221141202162-168493652323418.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221141607655-168493652323419.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221141916977-168493652323420.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221142034328-168493652323421.png">
<meta property="og:image" content="http://example.com/2023/02/20/TensorRT/image-20230221142046759-168493652323422.png">
<meta property="og:image" content="http://example.com/image-20230221142725737-168493652323423.png">
<meta property="article:published_time" content="2023-02-20T05:39:03.000Z">
<meta property="article:modified_time" content="2023-05-30T14:00:08.184Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="ONNX">
<meta property="article:tag" content="TensorRT">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2023/02/20/TensorRT/image-20230221202104187-168493652323424.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/%E9%B1%BC.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/%E9%B1%BC.svg">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/%E9%B1%BC.svg">
    <!--- Page Info-->
    
    <title>
        
            TensorRT -
        
        Airex-Daily
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/assets/fonts.css">

    <!--- Font Part-->
    
    
    
        <link href="" rel="stylesheet">
    
    
        <link href="" rel="stylesheet">
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    let Global = window.Global || {};
    Global.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN"};
    Global.theme_config = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":true,"lazyload":true,"recommendation":{"enable":false,"title":"æ¨èé˜…è¯»","limit":3,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null},"global":{"fonts":{"chinese":{"enable":true,"family":null,"url":null},"english":{"enable":true,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"busuanzi_counter":{"enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"pjax":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fix","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-rry6gw.png"},"title":"ä¼¸æ‰‹ä¹Ÿæ¡ä¸ä½å½©è™¹ğŸŒˆ","subtitle":{"text":["â€”â€”æˆ‘æœŸå¾…"],"hitokoto":{"enable":true,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":true,"links":{"github":"https://github.com/Airex-ai","instagram":null,"zhihu":null,"twitter":null,"email":"airex.yu@foxmail.com"}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":"https://music.163.com/song?id=1501530173&userid=253099352","cover":null}]},"mermaid":{"enable":true,"version":"9.3.0"}},"version":"2.1.5","navbar":{"auto_hide":true,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"About":{"icon":"fa-regular fa-user","submenus":{"Github":"https://github.com/Airex-ai?tab=repositories"}},"éšè®°":{"icon":"fa-solid fa-tree-palm","path":"/masonry/"}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"}}},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}}};
    Global.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"};
    Global.data_config = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="main-content-container">

        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Airex-Daily
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        é¦–é¡µ
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/archives"  >
                                    
                                        
                                            <i class="fa-regular fa-archive"></i>
                                        
                                        å½’æ¡£
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-regular fa-user"></i>
                                        
                                        å…³äº&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://github.com/Airex-ai?tab=repositories">GITHUB
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/masonry/"  >
                                    
                                        
                                            <i class="fa-solid fa-tree-palm"></i>
                                        
                                        éšè®°
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer">
        <ul class="drawer-navbar-list">
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                é¦–é¡µ
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/archives"  >
                             
                                
                                    <i class="fa-regular fa-archive"></i>
                                
                                å½’æ¡£
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-regular fa-user"></i>
                                
                                å…³äº&nbsp;<i class="fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://github.com/Airex-ai?tab=repositories">GITHUB</a>
                            </li>
                        
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/masonry/"  >
                             
                                
                                    <i class="fa-solid fa-tree-palm"></i>
                                
                                éšè®°
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
             
                <div class="article-title">         
                    <img src="/images/TensorRT.png" alt="TensorRT" />
                    <h1 class="article-title-cover">TensorRT</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/images/%E5%A4%B4%E5%83%8F.JPG">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Airex Yu</span>
                            
                                <span class="author-label">Lv3</span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2023-02-20 13:39:03</span>
        <span class="mobile">2023-02-20 13:39</span>
        <span class="hover-info">åˆ›å»º</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2023-05-30 22:08</span>
            <span class="mobile">2023-05-30 22</span>
            <span class="hover-info">æ›´æ–°</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">æ·±åº¦å­¦ä¹ </a>&nbsp;
                    </li>
                
                    <li>
                        &gt; <a href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E5%8A%A0%E9%80%9F/">æ¨¡å‹è®­ç»ƒåŠ é€Ÿ</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/ONNX/">ONNX</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/TensorRT/">TensorRT</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <h1 id="TensorRT"><a href="#TensorRT" class="headerlink" title="TensorRT"></a>TensorRT</h1><h2 id="TensorRTæ˜¯ä»€ä¹ˆ"><a href="#TensorRTæ˜¯ä»€ä¹ˆ" class="headerlink" title="TensorRTæ˜¯ä»€ä¹ˆ"></a>TensorRTæ˜¯ä»€ä¹ˆ</h2><p>TensorRTæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„æ·±åº¦å­¦ä¹ æ¨ç†ï¼ˆInferenceï¼‰ä¼˜åŒ–å™¨ï¼Œå¯ä»¥ä¸ºæ·±åº¦å­¦ä¹ åº”ç”¨æä¾›ä½å»¶è¿Ÿã€é«˜ååç‡çš„éƒ¨ç½²æ¨ç†ã€‚TensorRTå¯ç”¨äºå¯¹è¶…å¤§è§„æ¨¡æ•°æ®ä¸­å¿ƒã€åµŒå…¥å¼å¹³å°æˆ–è‡ªåŠ¨é©¾é©¶å¹³å°è¿›è¡Œæ¨ç†åŠ é€Ÿã€‚TensorRTç°å·²èƒ½æ”¯æŒTensorFlowã€Caffeã€Mxnetã€Pytorchç­‰å‡ ä¹æ‰€æœ‰çš„æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œå°†TensorRTå’ŒNVIDIAçš„GPUç»“åˆèµ·æ¥ï¼Œèƒ½åœ¨å‡ ä¹æ‰€æœ‰çš„æ¡†æ¶ä¸­è¿›è¡Œå¿«é€Ÿå’Œé«˜æ•ˆçš„éƒ¨ç½²æ¨ç†ã€‚</p>
<p>TensorRTå¯ä»¥å¯¹ç½‘ç»œè¿›è¡Œå‹ç¼©ã€ä¼˜åŒ–ä»¥åŠè¿è¡Œæ—¶éƒ¨ç½²ï¼Œå¹¶ä¸”æ²¡æœ‰æ¡†æ¶çš„å¼€é”€ã€‚TensorRTé€šè¿‡combines layersï¼Œkernelä¼˜åŒ–é€‰æ‹©ï¼Œä»¥åŠæ ¹æ®æŒ‡å®šçš„ç²¾åº¦æ‰§è¡Œå½’ä¸€åŒ–å’Œè½¬æ¢æˆæœ€ä¼˜çš„matrix mathæ–¹æ³•ï¼Œæ”¹å–„ç½‘ç»œçš„å»¶è¿Ÿã€ååé‡ä»¥åŠæ•ˆç‡ã€‚<strong>TensorRTå¯ä»¥ç›´æ¥ä»è¿™äº›æ·±åº¦å­¦ä¹ æ¡†æ¶ä¸­è·å–æ·±åº¦å­¦ä¹ æ¨¡å‹çš„å®šä¹‰å’Œæƒé‡</strong>ã€‚</p>
<p>ä¸€èˆ¬çš„æ·±åº¦å­¦ä¹ é¡¹ç›®ï¼Œè®­ç»ƒæ—¶ä¸ºäº†åŠ å¿«é€Ÿåº¦ï¼Œä¼šä½¿ç”¨<strong>å¤šGPUåˆ†å¸ƒå¼è®­ç»ƒ</strong>ã€‚ä½†åœ¨éƒ¨ç½²æ¨ç†æ—¶ï¼Œä¸ºäº†é™ä½æˆæœ¬ï¼Œå¾€å¾€ä½¿ç”¨å•ä¸ªGPUæœºå™¨ç”šè‡³åµŒå…¥å¼å¹³å°ï¼ˆæ¯”å¦‚ NVIDIA Jetsonï¼‰è¿›è¡Œéƒ¨ç½²ï¼Œéƒ¨ç½²ç«¯ä¹Ÿè¦æœ‰ä¸è®­ç»ƒæ—¶ç›¸åŒçš„æ·±åº¦å­¦ä¹ ç¯å¢ƒï¼Œå¦‚caffeï¼ŒTensorFlowç­‰ã€‚<strong>å¯ä»¥è®¤ä¸ºtensorRTæ˜¯ä¸€ä¸ªåªæœ‰å‰å‘ä¼ æ’­çš„æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œè¿™ä¸ªæ¡†æ¶å¯ä»¥å°† Caffeï¼ŒTensorFlowçš„ç½‘ç»œæ¨¡å‹è§£æï¼Œç„¶åä¸tensorRTä¸­å¯¹åº”çš„å±‚è¿›è¡Œä¸€ä¸€æ˜ å°„ï¼ŒæŠŠå…¶ä»–æ¡†æ¶çš„æ¨¡å‹ç»Ÿä¸€å…¨éƒ¨ è½¬æ¢åˆ°tensorRTä¸­ï¼Œç„¶ååœ¨tensorRTä¸­å¯ä»¥é’ˆå¯¹NVIDIAè‡ªå®¶GPUå®æ–½ä¼˜åŒ–ç­–ç•¥ï¼Œå¹¶è¿›è¡Œéƒ¨ç½²åŠ é€Ÿã€‚</strong></p>
<p>ç›®å‰TensorRT4.0 å‡ ä¹å¯ä»¥æ”¯æŒæ‰€æœ‰å¸¸ç”¨çš„æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œ<strong>å¯¹äºcaffeå’ŒTensorFlowæ¥è¯´ï¼ŒtensorRTå¯ä»¥ç›´æ¥è§£æä»–ä»¬çš„ç½‘ç»œæ¨¡å‹</strong>ï¼›å¯¹äºcaffe2ï¼Œpytorchï¼Œmxnetï¼Œchainerï¼ŒCNTKç­‰æ¡†æ¶åˆ™æ˜¯é¦–å…ˆè¦å°†æ¨¡å‹è½¬ä¸º ONNX çš„é€šç”¨æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œç„¶åå¯¹ONNXæ¨¡å‹åšè§£æã€‚è€Œtensorflowå’ŒMATLABå·²ç»å°†TensorRTé›†æˆåˆ°æ¡†æ¶ä¸­å»äº†ã€‚</p>
<p><strong>tensorRTä¸­æœ‰ä¸€ä¸ª Plugin å±‚ï¼Œè¿™ä¸ªå±‚æä¾›äº† API å¯ä»¥ç”±ç”¨æˆ·è‡ªå·±å®šä¹‰tensorRTä¸æ”¯æŒçš„å±‚</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221202104187-168493652323424.png"
                      class="" title="image-20230221202104187"
                >



<h2 id="è®­ç»ƒå’Œæ¨ç†"><a href="#è®­ç»ƒå’Œæ¨ç†" class="headerlink" title="è®­ç»ƒå’Œæ¨ç†"></a>è®­ç»ƒå’Œæ¨ç†</h2><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221200627437-168493652323425.png"
                      class="" title="image-20230221200627437"
                >

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221200708531-168493652323426.png"
                      class="" title="image-20230221200708531"
                >

<ul>
<li>è®­ç»ƒï¼ˆtrainingï¼‰åŒ…å«äº†<strong>å‰å‘ä¼ æ’­å’Œåå‘ä¼ æ’­</strong>ä¸¤ä¸ªé˜¶æ®µï¼Œé’ˆå¯¹çš„æ˜¯è®­ç»ƒé›†ã€‚è®­ç»ƒæ—¶é€šè¿‡è¯¯å·®åå‘ä¼ æ’­æ¥ä¸æ–­ä¿®æ”¹ç½‘ç»œæƒå€¼ï¼ˆweightsï¼‰ã€‚</li>
<li>æ¨ç†ï¼ˆinferenceï¼‰åªåŒ…å«å‰å‘ä¼ æ’­ä¸€ä¸ªé˜¶æ®µï¼Œé’ˆå¯¹çš„æ˜¯é™¤äº†è®­ç»ƒé›†ä¹‹å¤–çš„æ–°æ•°æ®ã€‚å¯ä»¥æ˜¯æµ‹è¯•é›†ï¼Œä½†ä¸å®Œå…¨æ˜¯ï¼Œæ›´å¤šçš„æ˜¯æ•´ä¸ªæ•°æ®é›†ä¹‹å¤–çš„æ•°æ®ã€‚å…¶å®å°±æ˜¯é’ˆå¯¹æ–°æ•°æ®è¿›è¡Œé¢„æµ‹ï¼Œé¢„æµ‹æ—¶ï¼Œé€Ÿåº¦æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„å› ç´ ã€‚</li>
</ul>
<h2 id="TensorRTåŠ é€ŸåŸç†"><a href="#TensorRTåŠ é€ŸåŸç†" class="headerlink" title="TensorRTåŠ é€ŸåŸç†"></a>TensorRTåŠ é€ŸåŸç†</h2><p>åŠ é€ŸåŸç†æ¯”è¾ƒå¤æ‚ï¼Œå®ƒå°†ä¼šæ ¹æ®æ˜¾å¡æ¥ä¼˜åŒ–ç®—å­ï¼Œä»¥èµ·åˆ°åŠ é€Ÿä½œç”¨ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ã€‚ç®€å•çš„æ¥è¯´ï¼Œå°±æ˜¯ç±»ä¼¼äºä½ å‡ºä¸€ä¸ªå…¬å¼1+1+1ï¼Œè€Œä½ çš„æ˜¾å¡æ”¯æŒä¹˜æ³•ï¼Œç›´æ¥ç»™ä½ æŠŠè¿™ä¸ªå…¬å¼ä¼˜åŒ–æˆäº†1*3ï¼Œä¸€æ­¥ç®—å®Œï¼Œæ‰€ä»¥è‡ªç„¶æ›´å¿«ã€‚å½“ç„¶è¿™ä¸ªåŠ é€Ÿç¨‹åº¦å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºä½ çš„<strong>æ˜¾å¡ç®—åŠ›</strong>è¿˜æœ‰<strong>æ¨¡å‹ç»“æ„å¤æ‚ç¨‹åº¦</strong>ï¼Œä¹Ÿæœ‰å¯èƒ½å› ä¸ºæ²¡æœ‰ä¼˜åŒ–çš„åœ°æ–¹ï¼Œä»è€Œæ²¡æœ‰å¤šå¤§çš„æå‡</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221203344296-168493652323427.png"
                      class="" title="image-20230221203344296"
                >

<h3 id="å±‚é—´èåˆæˆ–å¼ é‡èåˆï¼ˆLayer-amp-Tensor-Fusionï¼‰"><a href="#å±‚é—´èåˆæˆ–å¼ é‡èåˆï¼ˆLayer-amp-Tensor-Fusionï¼‰" class="headerlink" title="å±‚é—´èåˆæˆ–å¼ é‡èåˆï¼ˆLayer&amp;Tensor Fusionï¼‰"></a>å±‚é—´èåˆæˆ–å¼ é‡èåˆï¼ˆLayer&amp;Tensor Fusionï¼‰</h3><p>å¦‚ä¸‹å›¾å·¦ä¾§æ˜¯GoogLeNetInceptionæ¨¡å—çš„è®¡ç®—å›¾ã€‚è¿™ä¸ªç»“æ„ä¸­æœ‰å¾ˆå¤šå±‚ï¼Œåœ¨éƒ¨ç½²æ¨¡å‹æ¨ç†æ—¶ï¼Œè¿™æ¯ä¸€å±‚çš„è¿ç®—æ“ä½œéƒ½æ˜¯ç”±GPUå®Œæˆçš„ï¼Œä½†å®é™…ä¸Šæ˜¯<strong>GPUé€šè¿‡å¯åŠ¨ä¸åŒçš„CUDAï¼ˆCompute unified device architectureï¼‰æ ¸å¿ƒæ¥å®Œæˆè®¡ç®—çš„</strong>ï¼ŒCUDAæ ¸å¿ƒè®¡ç®—å¼ é‡çš„é€Ÿåº¦æ˜¯å¾ˆå¿«çš„ï¼Œ<strong>ä½†æ˜¯å¾€å¾€å¤§é‡çš„æ—¶é—´æ˜¯æµªè´¹åœ¨CUDAæ ¸å¿ƒçš„å¯åŠ¨å’Œå¯¹æ¯ä¸€å±‚è¾“å…¥&#x2F;è¾“å‡ºå¼ é‡çš„<code>è¯»å†™</code>æ“ä½œä¸Šé¢</strong>ï¼Œè¿™é€ æˆäº†å†…å­˜å¸¦å®½çš„ç“¶é¢ˆå’ŒGPUèµ„æºçš„æµªè´¹ã€‚TensorRTé€šè¿‡å¯¹å±‚é—´çš„æ¨ªå‘æˆ–çºµå‘åˆå¹¶ï¼ˆåˆå¹¶åçš„ç»“æ„ç§°ä¸ºCBRï¼Œæ„æŒ‡ <strong>convolution, bias, and ReLU layers are fused to form a single layer</strong>ï¼‰ï¼Œä½¿å¾—å±‚çš„æ•°é‡å¤§å¤§å‡å°‘ã€‚<strong>çºµå‘åˆå¹¶å¯ä»¥æŠŠå·ç§¯ã€åç½®å’Œæ¿€æ´»å±‚åˆå¹¶æˆä¸€ä¸ªCBRç»“æ„ï¼Œåªå ç”¨ä¸€ä¸ªCUDAæ ¸å¿ƒã€‚æ¨ªå‘åˆå¹¶å¯ä»¥æŠŠç»“æ„ç›¸åŒï¼Œä½†æ˜¯æƒå€¼ä¸åŒçš„å±‚åˆå¹¶æˆä¸€ä¸ªæ›´å®½çš„å±‚ï¼Œä¹Ÿåªå ç”¨ä¸€ä¸ªCUDAæ ¸å¿ƒã€‚</strong>åˆå¹¶ä¹‹åçš„è®¡ç®—å›¾ï¼ˆå›¾4å³ä¾§ï¼‰çš„å±‚æ¬¡æ›´å°‘äº†ï¼Œå ç”¨çš„CUDAæ ¸å¿ƒæ•°ä¹Ÿå°‘äº†ï¼Œå› æ­¤æ•´ä¸ªæ¨¡å‹ç»“æ„ä¼šæ›´å°ï¼Œæ›´å¿«ï¼Œæ›´é«˜æ•ˆã€‚</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221151604138-168493652323428.png"
                      class="" title="image-20230221151604138"
                >



<h3 id="æ•°æ®ç²¾åº¦æ ¡å‡†"><a href="#æ•°æ®ç²¾åº¦æ ¡å‡†" class="headerlink" title="æ•°æ®ç²¾åº¦æ ¡å‡†"></a><strong>æ•°æ®ç²¾åº¦æ ¡å‡†</strong></h3><p><strong>å¤§éƒ¨åˆ†æ·±åº¦å­¦ä¹ æ¡†æ¶åœ¨è®­ç»ƒç¥ç»ç½‘ç»œæ—¶ç½‘ç»œä¸­çš„å¼ é‡ï¼ˆTensorï¼‰éƒ½æ˜¯32ä½æµ®ç‚¹æ•°çš„ç²¾åº¦ï¼ˆFull 32-bit precisionï¼ŒFP32ï¼‰ï¼Œä¸€æ—¦ç½‘ç»œè®­ç»ƒå®Œæˆï¼Œåœ¨éƒ¨ç½²æ¨ç†çš„è¿‡ç¨‹ä¸­ç”±äºä¸éœ€è¦åå‘ä¼ æ’­ï¼ˆå¯ä»¥ç†è§£æˆï¼Œè®­ç»ƒæ—¶åå‘ä¼ æ’­æ•°æ®éœ€è¦æ›´é«˜çš„ç²¾åº¦ï¼‰ï¼Œå®Œå…¨å¯ä»¥é€‚å½“é™ä½æ•°æ®ç²¾åº¦ï¼Œæ¯”å¦‚é™ä¸ºFP16æˆ–INT8çš„ç²¾åº¦ã€‚</strong>æ›´ä½çš„æ•°æ®ç²¾åº¦å°†ä¼šä½¿å¾—å†…å­˜å ç”¨å’Œå»¶è¿Ÿæ›´ä½ï¼Œæ¨¡å‹ä½“ç§¯æ›´å°ã€‚</p>
<p>å¦‚ä¸‹è¡¨ä¸ºä¸åŒç²¾åº¦çš„åŠ¨æ€èŒƒå›´ï¼š</p>
<table>
<thead>
<tr>
<th align="left">Precision</th>
<th align="left">Dynamic Range</th>
</tr>
</thead>
<tbody><tr>
<td align="left">FP32</td>
<td align="left">âˆ’3.4Ã—1038 +3.4Ã—1038âˆ’3.4Ã—1038 +3.4Ã—1038</td>
</tr>
<tr>
<td align="left">FP16</td>
<td align="left">âˆ’65504 +65504âˆ’65504 +65504</td>
</tr>
<tr>
<td align="left">INT8</td>
<td align="left">âˆ’128 +127âˆ’128 +127</td>
</tr>
</tbody></table>
<p>INT8åªæœ‰256ä¸ªä¸åŒçš„æ•°å€¼ï¼Œä½¿ç”¨INT8æ¥è¡¨ç¤º FP32ç²¾åº¦çš„æ•°å€¼ï¼Œè‚¯å®šä¼šä¸¢å¤±ä¿¡æ¯ï¼Œé€ æˆæ€§èƒ½ä¸‹é™ã€‚<strong>ä¸è¿‡TensorRTä¼šæä¾›å®Œå…¨è‡ªåŠ¨åŒ–çš„æ ¡å‡†ï¼ˆCalibration ï¼‰è¿‡ç¨‹ï¼Œä¼šä»¥æœ€å¥½çš„åŒ¹é…æ€§èƒ½å°†FP32ç²¾åº¦çš„æ•°æ®é™ä½ä¸ºINT8ç²¾åº¦ï¼Œæœ€å°åŒ–æ€§èƒ½æŸå¤±ã€‚</strong>å…³äºæ ¡å‡†è¿‡ç¨‹ï¼Œåé¢ä¼šä¸“é—¨åšä¸€ä¸ªæ¢ç©¶ã€‚</p>
<h3 id="Kernel-Auto-Tuning"><a href="#Kernel-Auto-Tuning" class="headerlink" title="Kernel Auto-Tuning"></a><strong>Kernel Auto-Tuning</strong></h3><p>ç½‘ç»œæ¨¡å‹åœ¨æ¨ç†è®¡ç®—æ—¶ï¼Œæ˜¯è°ƒç”¨GPUçš„CUDAæ ¸è¿›è¡Œè®¡ç®—çš„ã€‚TensorRTå¯ä»¥é’ˆå¯¹ä¸åŒçš„ç®—æ³•ï¼Œä¸åŒçš„ç½‘ç»œæ¨¡å‹ï¼Œä¸åŒçš„GPUå¹³å°ï¼Œè¿›è¡Œ CUDAæ ¸çš„è°ƒæ•´ï¼Œä»¥ä¿è¯å½“å‰æ¨¡å‹åœ¨ç‰¹å®šå¹³å°ä¸Šä»¥æœ€ä¼˜æ€§èƒ½è®¡ç®—ã€‚</p>
<h3 id="Dynamic-Tensor-Memory"><a href="#Dynamic-Tensor-Memory" class="headerlink" title="Dynamic Tensor Memory"></a><strong>Dynamic Tensor Memory</strong></h3><p>åœ¨æ¯ä¸ªtensorçš„ä½¿ç”¨æœŸé—´ï¼ŒTensorRTä¼šä¸ºå…¶æŒ‡å®šæ˜¾å­˜ï¼Œé¿å…æ˜¾å­˜é‡å¤ç”³è¯·ï¼Œå‡å°‘å†…å­˜å ç”¨å’Œæé«˜é‡å¤ä½¿ç”¨æ•ˆç‡ã€‚</p>
<h3 id="Multi-Stream-Execution"><a href="#Multi-Stream-Execution" class="headerlink" title="Multi-Stream Execution"></a><strong>Multi-Stream Execution</strong></h3><p>å¯æ‰©å±•è®¾è®¡ï¼Œå¯å¹¶è¡Œå¤„ç†å¤šä¸ªè¾“å…¥æµ</p>
<h2 id="TensorRTä½¿ç”¨æµç¨‹"><a href="#TensorRTä½¿ç”¨æµç¨‹" class="headerlink" title="TensorRTä½¿ç”¨æµç¨‹"></a>TensorRTä½¿ç”¨æµç¨‹</h2><p>TensorRTä½¿ç”¨æµç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š<strong>é¢„å¤„ç†é˜¶æ®µå’Œæ¨ç†é˜¶æ®µ</strong></p>
<p><strong>é¢„å¤„ç†</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221210110614-168493652323429.png"
                      class="" title="image-20230221210110614"
                >

<p><strong>æ¨ç†</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221210123906-168493652323430.png"
                      class="" title="image-20230221210123906"
                >

<ol>
<li>å¯¼å‡ºç½‘ç»œå®šä¹‰ä»¥åŠç›¸å…³æƒé‡</li>
<li>è§£æç½‘ç»œå®šä¹‰ä»¥åŠç›¸å…³æƒé‡</li>
<li>æ ¹æ®æ˜¾å¡ç®—å­æ„é€ å‡ºæœ€ä¼˜æ‰§è¡Œè®¡åˆ’</li>
<li>å°†æ‰§è¡Œè®¡åˆ’åºåˆ—åŒ–å­˜å‚¨ï¼ˆ<strong>é¢„å¤„ç†ç»“æŸ</strong>ï¼‰</li>
<li>ååºåˆ—åŒ–æ‰§è¡Œä»»åŠ¡ï¼ˆ<strong>æ¨ç†å¼€å§‹</strong>ï¼‰</li>
<li>è¿›è¡Œæ¨ç†</li>
</ol>
<p><strong>æ³¨æ„ï¼štensorRTå®é™…ä¸Šå’Œç¡¬ä»¶ç»‘å®šï¼Œåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­ï¼Œè‹¥ç¡¬ä»¶å’Œè½¯ä»¶å‘ç”Ÿäº†æ”¹å˜ï¼Œè¿™ä¸€æ­¥å°±è¦é‡æ–°è¿›è¡Œ</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221151952678-168493652323431.png"
                      class="" title="image-20230221151952678"
                >

<h1 id="å¯¼å‡ºONNXæ¨¡å‹"><a href="#å¯¼å‡ºONNXæ¨¡å‹" class="headerlink" title="å¯¼å‡ºONNXæ¨¡å‹"></a>å¯¼å‡ºONNXæ¨¡å‹</h1><p>è¿™ä¸€æ­¥ä¸»è¦æ˜¯ä¸ºäº†å°†æ·±åº¦å­¦ä¹ æ¨¡å‹çš„ç»“æ„å’Œå‚æ•°å¯¼å‡ºæ¥ã€‚</p>
<p>ONNXä¸åƒPytorchå’ŒTensorFlowé‚£æ ·ï¼Œéœ€è¦å®‰è£…æ¡†æ¶è¿è¡Œçš„ä¾èµ–åŒ…ï¼ŒTensorRTå¯ä»¥ç›´æ¥ä»ONNXæ–‡ä»¶ä¸­è¯»å–ç½‘ç»œå®šä¹‰å’Œæƒé‡ä¿¡æ¯ã€‚é™¤æ­¤ä¹‹å¤–ã€‚<strong>ONNXæ›´åƒæ˜¯â€œé€šç”¨è¯­è¨€â€ï¼Œæ˜¯ä¸ºäº†æè¿°ç½‘ç»œç»“æ„å’Œç›¸å…³æƒé‡è€Œç”Ÿã€‚</strong>è¿˜æœ‰ä¸“é—¨çš„å·¥å…·å¯ä»¥ç›´æŸ¥çœ‹onnxæ–‡ä»¶ã€‚å› æ­¤ï¼Œå¯ä»¥å…ˆå°†æ·±åº¦å­¦ä¹ æ¨¡å‹å¯¼å‡ºONNXæ–‡ä»¶ï¼Œé€šè¿‡ONNXæ–‡ä»¶éƒ¨ç½²</p>
<p>æŸ¥çœ‹ONNXæ–‡ä»¶çš„å·¥å…· <code> https://lutzroeder.github.io/netron/</code>  <strong>netronçš„åœ¨çº¿å·¥å…·</strong></p>
<h2 id="å¯¼å‡ºonnxæ–‡ä»¶"><a href="#å¯¼å‡ºonnxæ–‡ä»¶" class="headerlink" title="å¯¼å‡ºonnxæ–‡ä»¶"></a>å¯¼å‡ºonnxæ–‡ä»¶</h2><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ„é€ æ¨¡å‹å®ä¾‹</span></span><br><span class="line"> model = HRNet() </span><br><span class="line"><span class="comment"># ååºåˆ—åŒ–æƒé‡å‚æ•° </span></span><br><span class="line">model.load_state_dict(torch.load(self.weight_path),strict=<span class="literal">False</span>) </span><br><span class="line">model.<span class="built_in">eval</span>() </span><br><span class="line"><span class="comment"># å®šä¹‰è¾“å…¥åç§°ï¼Œlistç»“æ„ï¼Œå¯èƒ½æœ‰å¤šä¸ªè¾“å…¥ </span></span><br><span class="line">input_names = [<span class="string">&#x27;input&#x27;</span>] </span><br><span class="line"><span class="comment"># å®šä¹‰è¾“å‡ºåç§°ï¼Œlistç»“æ„ï¼Œå¯èƒ½æœ‰å¤šä¸ªè¾“å‡º </span></span><br><span class="line">output_names = [<span class="string">&#x27;output&#x27;</span>] </span><br><span class="line"><span class="comment"># æ„é€ è¾“å…¥ç”¨ä»¥éªŒè¯onnxæ¨¡å‹çš„æ­£ç¡®æ€§ </span></span><br><span class="line"><span class="built_in">input</span> = torch.rand(<span class="number">1</span>, <span class="number">3</span>, <span class="number">384</span>, <span class="number">288</span>) </span><br><span class="line"><span class="comment"># å¯¼å‡º </span></span><br><span class="line">torch.onnx.export(model, <span class="built_in">input</span>, output_path,</span><br><span class="line">                          export_params=<span class="literal">True</span>,                          </span><br><span class="line">                          opset_version=<span class="number">11</span>,                          </span><br><span class="line">                          do_constant_folding=<span class="literal">True</span>,                          </span><br><span class="line">                          input_names=input_names,                          </span><br><span class="line">                          output_names=output_names)</span><br></pre></td></tr></table></figure></div>

<p>å‚æ•°ä»‹ç»ï¼š</p>
<ul>
<li>modelä¸ºpytorchæ¨¡å‹å®ä¾‹</li>
<li>inputä¸ºæµ‹è¯•è¾“å…¥æ•°æ®ï¼ˆå½¢çŠ¶å¿…é¡»è¦å’Œæ¨¡å‹è¾“å…¥ä¸€è‡´ï¼Œä½†æ˜¯æ•°å€¼å¯ä»¥æ˜¯éšæœºçš„ï¼‰</li>
<li>output_pathä¸ºå¯¼å‡ºè·¯å¾„ï¼Œxxx.onnx</li>
<li>export_paramsä¸ºæ˜¯å¦å¯¼å‡ºå‚æ•°æƒé‡ï¼Œå¿…ç„¶æ˜¯True</li>
<li>opset_version&#x3D;11 å‘è¡Œç‰ˆæœ¬ï¼Œ11å°±å¯ä»¥äº†</li>
<li><strong>do_constant_foldingæ˜¯å¦å¯¹å¸¸é‡è¿›è¡ŒæŠ˜å ï¼ŒTrueå°±å¯ä»¥äº†</strong></li>
<li>input_namesæ˜¯æ¨¡å‹è¾“å…¥çš„åç§°ï¼Œlistç±»å‹ï¼Œå› ä¸ºæ¨¡å‹å¯èƒ½æœ‰å¤šä¸ªè¾“å…¥</li>
<li>output_namesåŒä¸Šï¼Œåªä¸è¿‡è¿™æ˜¯é’ˆå¯¹è¾“å‡ºçš„</li>
</ul>
<h1 id="TensorRTæ¨ç†é˜¶æ®µ"><a href="#TensorRTæ¨ç†é˜¶æ®µ" class="headerlink" title="TensorRTæ¨ç†é˜¶æ®µ"></a>TensorRTæ¨ç†é˜¶æ®µ</h1><p>æ ¹æ®onnxæ–‡ä»¶æ‰€æè¿°çš„æ¨¡å‹ç»“æ„å’Œæƒé‡å’Œå½“å‰çš„è½¯ç¡¬ä»¶ç¯å¢ƒç”Ÿæˆå¯¹åº”çš„æ‰§è¡Œè®¡åˆ’ã€‚</p>
<p>è¿™ä¸€æ­¥æ—¶é—´æ¯”è¾ƒé•¿ï¼Œæ‰€ä»¥éœ€è¦åºåˆ—åŒ–æ‰§è¡Œæ–‡ä»¶ï¼Œ<strong>ç”Ÿæˆxxx.engine</strong>æ–‡ä»¶æŒä¹…åŒ–ä¿å­˜</p>
<h2 id="trtexec-exeå®ç°é¢„æ¨ç†ï¼ˆæ¨èï¼‰"><a href="#trtexec-exeå®ç°é¢„æ¨ç†ï¼ˆæ¨èï¼‰" class="headerlink" title="trtexec.exeå®ç°é¢„æ¨ç†ï¼ˆæ¨èï¼‰"></a>trtexec.exeå®ç°é¢„æ¨ç†ï¼ˆæ¨èï¼‰</h2><p>ä½¿ç”¨trtexec.exeå®ç°é¢„æ¨ç†éœ€è¦ç³»ç»Ÿå®‰è£…å¥½cudatoolkitå’Œcudnnï¼Œå¦åˆ™æ— æ³•æ­£å¸¸è¿è¡Œ</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221154127768-168493652323432.png"
                      class="" title="image-20230221154127768"
                >

<p>æœç´¢è¿è¡Œcmdï¼Œå¹¶ä¸”cdåˆ°æ­¤ç›®å½•ä¸‹ï¼Œå¹¶ä¸”å°†éœ€è¦éƒ¨ç½²çš„onnxæ–‡ä»¶å¤åˆ¶åˆ°æ­¤ç›®å½•ä¸‹</p>
<p>è¾“å…¥ä»¥ä¸‹æŒ‡ä»¤ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trtexec --onnx=xxx.onnx --saveEngine=xxx.engine --fp16</span><br></pre></td></tr></table></figure></div>

<p>â€“fp16å¼€å¯ float16ç²¾åº¦çš„æ¨ç†ï¼ˆæ¨èæ­¤æ¨¡å¼ï¼Œä¸€æ–¹é¢èƒ½å¤ŸåŠ é€Ÿï¼Œå¦ä¸€æ–¹é¢ç²¾åº¦ä¸‹é™æ¯”è¾ƒå°ï¼‰</p>
<p>â€“int8 å¼€å¯ int8ç²¾åº¦çš„æ¨ç†ï¼ˆä¸å¤ªæ¨èï¼Œè™½ç„¶æ›´å¿«ï¼Œä½†æ˜¯ç²¾åº¦ä¸‹é™å¤ªå‰å®³äº†ï¼‰</p>
<p>â€“onnx onnxè·¯å¾„</p>
<p>â€“saveEngineæ‰§è¡Œè®¡åˆ’ï¼ˆæ¨ç†å¼•æ“ï¼‰åºåˆ—åŒ–åœ°å€</p>
<h2 id="pythonä»£ç å®ç°é¢„æ¨ç†"><a href="#pythonä»£ç å®ç°é¢„æ¨ç†" class="headerlink" title="pythonä»£ç å®ç°é¢„æ¨ç†"></a>pythonä»£ç å®ç°é¢„æ¨ç†</h2><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯¼å…¥å¿…ç”¨ä¾èµ– </span></span><br><span class="line"><span class="keyword">import</span> tensorrt <span class="keyword">as</span> trt </span><br><span class="line"><span class="comment"># åˆ›å»ºloggerï¼šæ—¥å¿—è®°å½•å™¨ </span></span><br><span class="line">logger = trt.Logger(trt.Logger.WARNING) </span><br><span class="line"><span class="comment"># åˆ›å»ºæ„å»ºå™¨builder </span></span><br><span class="line">builder = trt.Builder(logger) </span><br><span class="line"><span class="comment"># é¢„åˆ›å»ºç½‘ç»œ     ç©ºç½‘ç»œ</span></span><br><span class="line">network = builder.create_network(<span class="number">1</span> &amp;lt;&amp;lt; <span class="built_in">int</span>(trt.NetworkDefinitionCreationFlag.EXPLICIT_BATCH)) </span><br><span class="line"><span class="comment"># åŠ è½½onnxè§£æå™¨ </span></span><br><span class="line">parser = trt.OnnxParser(network, logger) </span><br><span class="line">success = parser.parse_from_file(onnx_path) </span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(parser.num_errors):</span><br><span class="line">  <span class="built_in">print</span>(parser.get_error(idx))</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> success:  <span class="keyword">pass</span>  <span class="comment"># Error handling code here </span></span><br><span class="line"> <span class="comment"># builderé…ç½®    builderè§£æå™¨å°†onnxæ–‡ä»¶è§£ææˆç½‘ç»œï¼Œå¹¶é…ç½®ç½‘ç»œ</span></span><br><span class="line">config = builder.create_builder_config()</span><br><span class="line"><span class="comment"># åˆ†é…æ˜¾å­˜ä½œä¸ºå·¥ä½œåŒºé—´ï¼Œä¸€èˆ¬å»ºè®®ä¸ºæ˜¾å­˜ä¸€åŠçš„å¤§å° </span></span><br><span class="line">config.max_workspace_size = <span class="number">1</span> &amp;lt;&amp;lt; <span class="number">30</span>  <span class="comment"># 1 Mi </span></span><br><span class="line">serialized_engine = builder.build_serialized_network(network, config) </span><br><span class="line"><span class="comment"># åºåˆ—åŒ–ç”Ÿæˆengineæ–‡ä»¶ </span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(engine_path, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">   f.write(serialized_engine)</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">&quot;generate file success!&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<h1 id="TensorRtéƒ¨ç½²é˜¶æ®µ"><a href="#TensorRtéƒ¨ç½²é˜¶æ®µ" class="headerlink" title="TensorRtéƒ¨ç½²é˜¶æ®µ"></a>TensorRtéƒ¨ç½²é˜¶æ®µ</h1><p>åœ¨æœ¬é˜¶æ®µï¼Œéœ€è¦ä½¿ç”¨ä»£ç å®ç°åŠ è½½æ‰§è¡Œè®¡åˆ’æ–‡ä»¶ï¼ˆxxx.engineï¼‰</p>
<p>å…¶ä¸­input&#x2F;outputä¸ºä½ çš„è¾“å…¥æ•°æ®ï¼Œh_input&#x2F;h_outputä¸º<strong>é”é¡µå†…å­˜</strong>ï¼ˆéé”é¡µå†…å­˜ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯å»ºè®®ç”¨é”é¡µå†…å­˜é˜²æ­¢è¢«ç³»ç»Ÿé¡µé¢ç½®æ¢åˆ°å¤–å­˜ä¸­ï¼‰ï¼Œd_input&#x2F;d_outputä¸ºæ˜¾å­˜  </p>
<p>é”é¡µå†…å­˜ï¼šç¡¬ä»¶å¤–è®¾ç›´æ¥è®¿é—®CPUå†…å­˜ï¼Œä»è€Œé¿å…è¿‡å¤šçš„å¤åˆ¶æ“ä½œã€‚CPUä¹Ÿå¯ä»¥è®¿é—®ä¸Šè¿°é”é¡µå†…å­˜ï¼Œä½†æ˜¯æ­¤å†…å­˜æ˜¯ä¸èƒ½ç§»åŠ¨æˆ–æ¢é¡µåˆ°ç£ç›˜ä¸Šçš„ã€‚å¦å¤–ï¼Œ<strong>åœ¨GPUä¸Šåˆ†é…çš„å†…å­˜é»˜è®¤éƒ½æ˜¯é”é¡µå†…å­˜ï¼Œè¿™åªæ˜¯å› ä¸ºGPUä¸æ”¯æŒå°†å†…å­˜äº¤æ¢åˆ°ç£ç›˜ä¸Šã€‚</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221155924683-168493652323433.png"
                      class="" title="image-20230221155924683"
                >

<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯¼å…¥å¿…ç”¨ä¾èµ–</span></span><br><span class="line"><span class="keyword">import</span> tensorrt <span class="keyword">as</span> trt</span><br><span class="line"><span class="keyword">import</span> pycuda.autoinit  <span class="comment">#è´Ÿè´£æ•°æ®åˆå§‹åŒ–ï¼Œå†…å­˜ç®¡ç†ï¼Œé”€æ¯ç­‰</span></span><br><span class="line"><span class="keyword">import</span> pycuda.driver <span class="keyword">as</span> cuda  <span class="comment">#GPU CPUä¹‹é—´çš„æ•°æ®ä¼ è¾“</span></span><br><span class="line"><span class="comment"># åˆ›å»ºloggerï¼šæ—¥å¿—è®°å½•å™¨</span></span><br><span class="line">logger = trt.Logger(trt.Logger.WARNING)</span><br><span class="line"><span class="comment"># åˆ›å»ºruntimeå¹¶ååºåˆ—åŒ–ç”Ÿæˆengine</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(â€œsample.engineâ€, â€œrbâ€) <span class="keyword">as</span> f, trt.Runtime(logger) <span class="keyword">as</span> runtime:</span><br><span class="line">    engine = runtime.deserialize_cuda_engine(f.read())</span><br><span class="line"><span class="comment"># åˆ†é…CPUé”é¡µå†…å­˜å’ŒGPUæ˜¾å­˜   		åˆ†é…é”é¡µå†…å­˜å’Œæ˜¾å­˜åªéœ€è¦ä¸€æ¬¡</span></span><br><span class="line">h_input = cuda.pagelocked_empty(trt.volume(context.get_binding_shape(<span class="number">0</span>)), dtype=np.float32)</span><br><span class="line">h_output = cuda.pagelocked_empty(trt.volume(context.get_binding_shape(<span class="number">1</span>)), dtype=np.float32)</span><br><span class="line">d_input = cuda.mem_alloc(h_input.nbytes)</span><br><span class="line">d_output = cuda.mem_alloc(h_output.nbytes)</span><br><span class="line"><span class="comment"># åˆ›å»ºcudaæµ</span></span><br><span class="line">stream = cuda.Stream()</span><br><span class="line"><span class="comment"># åˆ›å»ºcontextå¹¶è¿›è¡Œæ¨ç†</span></span><br><span class="line"><span class="keyword">with</span> engine.create_execution_context() <span class="keyword">as</span> context:</span><br><span class="line">    <span class="comment"># å°†è¾“å…¥æ•°æ®ä»é”é¡µå†…å­˜æ‹·è´åˆ°æ˜¾å­˜</span></span><br><span class="line">    cuda.memcpy_htod_async(d_input, h_input, stream)</span><br><span class="line">    <span class="comment"># è¿›è¡Œæ¨ç†</span></span><br><span class="line">    context.execute_async_v2(bindings=[<span class="built_in">int</span>(d_input), <span class="built_in">int</span>(d_output)], stream_handle=stream.handle)</span><br><span class="line">    <span class="comment"># å°†è¾“å‡ºç»“æœä»æ˜¾å­˜æ‹·è´åˆ°é”é¡µå†…å­˜</span></span><br><span class="line">    cuda.memcpy_dtoh_async(h_output, d_output, stream)</span><br><span class="line">    <span class="comment"># åŒæ­¥æµ</span></span><br><span class="line">    stream.synchronize()</span><br><span class="line">    <span class="comment"># è¿”å›ä¸»å†…å­˜çš„è¾“å‡ºç»“æœ. è¯¥æ•°æ®ç­‰åŒäºåŸå§‹æ¨¡å‹çš„è¾“å‡ºæ•°æ®</span></span><br><span class="line">    <span class="keyword">return</span> h_output</span><br></pre></td></tr></table></figure></div>

<p>å†…å­˜å’Œæ˜¾å­˜åªåˆ†é…ä¸€æ¬¡ï¼Œæ‰€ä»¥å°†ä»£ç è¿›è¡Œå°è£…</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ„é€ ä½ è‡ªå·±çš„è¾“å…¥æ•°æ® </span></span><br><span class="line"><span class="built_in">input</span> = np.randn(<span class="number">1</span>, <span class="number">3</span>, <span class="number">384</span>, <span class="number">288</span>) </span><br><span class="line"><span class="comment"># æ‹·è´åˆ°é”é¡µå†…å­˜ </span></span><br><span class="line">np.copyto(h_input, <span class="built_in">input</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„é€ ä½ è‡ªå·±çš„è¾“å…¥æ•°æ® </span></span><br><span class="line"><span class="built_in">input</span> = np.randn(<span class="number">1</span>, <span class="number">3</span>, <span class="number">384</span>, <span class="number">288</span>) </span><br><span class="line"><span class="comment"># æ‹·è´åˆ°é”é¡µå†…å­˜ </span></span><br><span class="line">np.copyto(h_input, <span class="built_in">input</span>)</span><br></pre></td></tr></table></figure></div>

<h1 id="TensorRTå®ç°batchæ‰¹å¤„ç†"><a href="#TensorRTå®ç°batchæ‰¹å¤„ç†" class="headerlink" title="TensorRTå®ç°batchæ‰¹å¤„ç†"></a>TensorRTå®ç°batchæ‰¹å¤„ç†</h1><p>å°†å¤šä¸ªè¾“å…¥æ•°æ®æ„é€ ä¸ºä¸€ä¸ªbatchï¼Œä¸€æ¬¡æ€§è¾“å…¥æ·±åº¦å­¦ä¹ æ¨¡å‹å¹¶è¿›è¡Œé¢„æµ‹ï¼Œå¹¶è·å¾—å¯¹åº”çš„ç»“æœã€‚</p>
<h2 id="å¯¼å‡ºONNX"><a href="#å¯¼å‡ºONNX" class="headerlink" title="å¯¼å‡ºONNX"></a>å¯¼å‡ºONNX</h2><p>æˆ‘ä»¬åœ¨å¯¼å‡ºæ¨¡å‹çš„æ—¶å€™ï¼Œéœ€è¦å°†æ¨¡å‹è¾“å…¥çš„batchå‚æ•°å£°æ˜ä¸ºåŠ¨æ€å‚æ•°ï¼Œä¾‹å¦‚ï¼Œhrnetçš„è¾“å…¥æ•°æ®ç»´åº¦ä¸º(1, 3 , 384, 288)ï¼Œç¬¬ä¸€ä¸ªç»´åº¦ä¸ºbatchçš„å¤§å°ï¼Œç¬¬äºŒä¸ªç»´åº¦ä¸ºRGBä¸‰ä¸ªè‰²å½©é€šé“ï¼Œç¬¬ä¸‰ä¸ªç»´åº¦ä¸ºå›¾ç‰‡çš„é«˜ï¼Œç¬¬å››ä¸ªç»´åº¦ä¸ºå›¾ç‰‡çš„å®½ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬åœ¨å¯¼å‡ºonnxæ¨¡å‹æ—¶ï¼Œ<strong>éœ€è¦å°†ç¬¬ä¸€ä¸ªç»´åº¦çš„å‚æ•°å£°æ˜ä¸ºåŠ¨æ€å‚æ•°</strong>ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰è¾“å…¥åç§°ï¼Œlistç»“æ„ï¼Œå¯èƒ½æœ‰å¤šä¸ªè¾“å…¥</span></span><br><span class="line">input_names = [<span class="string">&#x27;input&#x27;</span>]</span><br><span class="line"><span class="comment"># å®šä¹‰è¾“å‡ºåç§°ï¼Œlistç»“æ„ï¼Œå¯èƒ½æœ‰å¤šä¸ªè¾“å‡º</span></span><br><span class="line">output_names = [<span class="string">&#x27;output&#x27;</span>]</span><br><span class="line"><span class="comment"># å£°æ˜åŠ¨æ€ç»´åº¦ï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠinputçš„ç¬¬0ç»´åº¦èµ‹åä¸ºbatch_size</span></span><br><span class="line">dynamic_axes = &#123;</span><br><span class="line">            <span class="string">&#x27;input&#x27;</span>: &#123;<span class="number">0</span>: <span class="string">&#x27;batch_size&#x27;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line"> <span class="comment"># æ„é€ è¾“å…¥ï¼Œç”¨ä»¥onnxéªŒè¯</span></span><br><span class="line"><span class="built_in">input</span> = torch.randn(<span class="number">2</span>, <span class="number">3</span>, <span class="number">384</span>, <span class="number">288</span>, requires_grad=<span class="literal">True</span>)</span><br><span class="line">torch.onnx.export(model, <span class="built_in">input</span>, output_path,</span><br><span class="line">                          export_params=<span class="literal">True</span>,</span><br><span class="line">                          opset_version=<span class="number">10</span>,</span><br><span class="line">                          do_constant_folding=<span class="literal">True</span>,</span><br><span class="line">                          input_names=input_names,</span><br><span class="line">                          output_names=output_names,</span><br><span class="line">                          dynamic_axes=dynamic_axes)</span><br></pre></td></tr></table></figure></div>

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221162707928-168493652323434.png"
                      class="" title="image-20230221162707928"
                >

<h2 id="æ¨¡å‹æ„é€ é˜¶æ®µ"><a href="#æ¨¡å‹æ„é€ é˜¶æ®µ" class="headerlink" title="æ¨¡å‹æ„é€ é˜¶æ®µ"></a>æ¨¡å‹æ„é€ é˜¶æ®µ</h2><p>å½“è¦batchæ‰¹å¤„ç†æ—¶ï¼Œéœ€æŒ‡å®šshapeså‚æ•°</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trtexec --fp16 --shapes=input:32x3x384x288 --onnx=xxxx.onnx --saveEngine=xxxx.trt </span><br></pre></td></tr></table></figure></div>

<h1 id="æ‰§è¡Œé˜¶æ®µ"><a href="#æ‰§è¡Œé˜¶æ®µ" class="headerlink" title="æ‰§è¡Œé˜¶æ®µ"></a>æ‰§è¡Œé˜¶æ®µ</h1><p>åœ¨æ‰§è¡Œé˜¶æ®µï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯TensorRTçš„è¾“å…¥å¿…é¡»æ˜¯ä¸¥æ ¼å›ºå®šçš„batch_sizeå¤§å°ï¼Œå³æ¯æ¬¡è¾“å…¥åˆ°trtæ¨¡å‹æ—¶ï¼Œè¾“å…¥å¿…é¡»æ˜¯batch_sizeå¤§å°ä¸¥æ ¼ç­‰äºæ„é€ é˜¶æ®µçš„è¾“å…¥ï¼Œ<strong>å› æ­¤å¯¹äºå°äºbatch_sizeå¤§å°çš„æ•°æ®éœ€è¦0å¡«å……å¤„ç†</strong> </p>
<h1 id="TensorRTå®˜æ¡£ä»‹ç»"><a href="#TensorRTå®˜æ¡£ä»‹ç»" class="headerlink" title="TensorRTå®˜æ¡£ä»‹ç»"></a>TensorRTå®˜æ¡£ä»‹ç»</h1><h2 id="The-Programming-Model"><a href="#The-Programming-Model" class="headerlink" title="The Programming Model"></a>The Programming Model</h2><p>TensorRT æ„å»ºé˜¶æ®µçš„æœ€é«˜çº§åˆ«æ¥å£æ˜¯<strong>Builder</strong> ï¼ˆ C++ ã€ Python ï¼‰ã€‚æ„å»ºå™¨è´Ÿè´£ä¼˜åŒ–æ¨¡å‹å¹¶ç”ŸæˆEngine ã€‚</p>
<p>ä¸ºäº†æ„å»ºå¼•æ“ï¼Œæ‚¨éœ€è¦ï¼š</p>
<ul>
<li>åˆ›å»ºç½‘ç»œå®šä¹‰</li>
<li>ä¸ºbuilderæŒ‡å®šé…ç½®</li>
<li>è°ƒç”¨builderåˆ›å»ºå¼•æ“</li>
</ul>
<p><code>NetworkDefinition</code>æ¥å£ç”¨äºå®šä¹‰æ¨¡å‹ã€‚å°†æ¨¡å‹ä¼ è¾“åˆ° TensorRT çš„æœ€å¸¸è§é€”å¾„æ˜¯ä»¥ ONNX æ ¼å¼ä»æ¡†æ¶ä¸­å¯¼å‡ºæ¨¡å‹ï¼Œå¹¶ä½¿ç”¨ TensorRT çš„ ONNX è§£æå™¨æ¥å¡«å……ç½‘ç»œå®šä¹‰ã€‚ä½†æ˜¯ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ TensorRT çš„Layerå’ŒTensor æ¥å£é€æ­¥æ„å»ºå®šä¹‰ã€‚</p>
<p>æ— è®ºé€‰æ‹©å“ªç§æ–¹å¼ï¼Œè¿˜å¿…é¡»å®šä¹‰å“ªäº›å¼ é‡æ˜¯ç½‘ç»œçš„è¾“å…¥å’Œè¾“å‡ºã€‚<strong>æœªæ ‡è®°ä¸ºè¾“å‡ºçš„å¼ é‡è¢«è®¤ä¸ºæ˜¯å¯ä»¥ç”±æ„å»ºå™¨ä¼˜åŒ–æ‰çš„ç¬æ€å€¼</strong>ã€‚è¾“å…¥å’Œè¾“å‡ºå¼ é‡å¿…é¡»å‘½åï¼Œä»¥ä¾¿åœ¨è¿è¡Œæ—¶ï¼ŒTensorRT çŸ¥é“å¦‚ä½•å°†è¾“å…¥å’Œè¾“å‡ºç¼“å†²åŒºç»‘å®šåˆ°æ¨¡å‹ã€‚</p>
<p><strong><code>BuilderConfig</code>æ¥å£ç”¨äºæŒ‡å®šTensorRTå¦‚ä½•ä¼˜åŒ–æ¨¡å‹ã€‚</strong>åœ¨å¯ç”¨çš„é…ç½®é€‰é¡¹ä¸­ï¼Œæ‚¨å¯ä»¥æ§åˆ¶ TensorRT é™ä½è®¡ç®—ç²¾åº¦çš„èƒ½åŠ›ï¼Œæ§åˆ¶å†…å­˜å’Œè¿è¡Œæ—¶æ‰§è¡Œé€Ÿåº¦ä¹‹é—´çš„æƒè¡¡ï¼Œä»¥åŠé™åˆ¶å¯¹ CUDA Â®å†…æ ¸çš„é€‰æ‹©ã€‚ç”±äºæ„å»ºå™¨å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæˆ–æ›´é•¿æ—¶é—´æ‰èƒ½è¿è¡Œï¼Œå› æ­¤æ‚¨è¿˜å¯ä»¥æ§åˆ¶æ„å»ºå™¨æœç´¢å†…æ ¸çš„æ–¹å¼ï¼Œä»¥åŠç¼“å­˜æœç´¢ç»“æœä»¥ä¾›åç»­è¿è¡Œä½¿ç”¨ã€‚</p>
<p><strong>ä¸€æ—¦æœ‰äº†ç½‘ç»œå®šä¹‰å’Œæ„å»ºå™¨é…ç½®ï¼Œå°±å¯ä»¥è°ƒç”¨æ„å»ºå™¨æ¥åˆ›å»ºå¼•æ“ã€‚</strong>æ„å»ºå™¨æ¶ˆé™¤äº†æ— æ•ˆè®¡ç®—ã€æŠ˜å å¸¸é‡ã€é‡æ–°æ’åºå’Œç»„åˆæ“ä½œä»¥åœ¨ GPU ä¸Šæ›´é«˜æ•ˆåœ°è¿è¡Œã€‚å®ƒå¯ä»¥é€‰æ‹©æ€§åœ°é™ä½æµ®ç‚¹è®¡ç®—çš„ç²¾åº¦ï¼Œæ–¹æ³•æ˜¯ç®€å•åœ°åœ¨ 16 ä½æµ®ç‚¹ä¸­è¿è¡Œå®ƒä»¬ï¼Œæˆ–è€…é€šè¿‡é‡åŒ–æµ®ç‚¹å€¼ä»¥ä¾¿å¯ä»¥ä½¿ç”¨ 8 ä½æ•´æ•°æ‰§è¡Œè®¡ç®—ã€‚å®ƒè¿˜ä½¿ç”¨ä¸åŒçš„æ•°æ®æ ¼å¼å¯¹æ¯ä¸€å±‚çš„å¤šæ¬¡å®ç°è¿›è¡Œè®¡æ—¶ï¼Œç„¶åè®¡ç®—æ‰§è¡Œæ¨¡å‹çš„æœ€ä½³æ—¶é—´è¡¨ï¼Œä»è€Œæœ€å¤§é™åº¦åœ°é™ä½å†…æ ¸æ‰§è¡Œå’Œæ ¼å¼è½¬æ¢çš„ç»¼åˆæˆæœ¬ã€‚</p>
<p><strong>æ„å»ºå™¨ä»¥ç§°ä¸ºè®¡åˆ’çš„åºåˆ—åŒ–å½¢å¼åˆ›å»ºå¼•æ“ï¼Œè¯¥è®¡åˆ’å¯ä»¥ç«‹å³ååºåˆ—åŒ–ï¼Œæˆ–ä¿å­˜åˆ°ç£ç›˜ä»¥ä¾›ä»¥åä½¿ç”¨ã€‚</strong></p>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li><strong>TensorRT åˆ›å»ºçš„å¼•æ“ç‰¹å®šäºåˆ›å»ºå®ƒä»¬çš„ TensorRT ç‰ˆæœ¬å’Œåˆ›å»ºå®ƒä»¬çš„ GPUã€‚</strong></li>
<li>TensorRT çš„ç½‘ç»œå®šä¹‰ä¸ä¼šæ·±åº¦å¤åˆ¶å‚æ•°æ•°ç»„ï¼ˆä¾‹å¦‚å·ç§¯çš„æƒé‡ï¼‰ã€‚å› æ­¤ï¼Œåœ¨æ„å»ºé˜¶æ®µå®Œæˆä¹‹å‰ï¼Œæ‚¨ä¸å¾—é‡Šæ”¾è¿™äº›é˜µåˆ—çš„å†…å­˜ã€‚ä½¿ç”¨ ONNX è§£æå™¨å¯¼å…¥ç½‘ç»œæ—¶ï¼Œè§£æå™¨æ‹¥æœ‰æƒé‡ï¼Œå› æ­¤åœ¨æ„å»ºé˜¶æ®µå®Œæˆä¹‹å‰ä¸å¾—å°†å…¶é”€æ¯ã€‚</li>
<li>æ„å»ºå™¨æ—¶é—´ç®—æ³•ä»¥ç¡®å®šæœ€å¿«çš„ã€‚ä¸å…¶ä»– GPU å·¥ä½œå¹¶è¡Œè¿è¡Œæ„å»ºå™¨å¯èƒ½ä¼šæ‰°ä¹±æ—¶åºï¼Œå¯¼è‡´ä¼˜åŒ–ä¸ä½³ã€‚</li>
</ul>
<h3 id="The-Runtime-Phase"><a href="#The-Runtime-Phase" class="headerlink" title="The Runtime Phase"></a>The Runtime Phase</h3><p>TensorRT æ‰§è¡Œé˜¶æ®µçš„æœ€é«˜çº§åˆ«æ¥å£æ˜¯<code>Runtime</code>ã€‚ ä½¿ç”¨è¿è¡Œæ—¶æ—¶ï¼Œæ‚¨é€šå¸¸ä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ul>
<li>ååºåˆ—åŒ–åˆ›å»ºå¼•æ“çš„è®¡åˆ’(plan æ–‡ä»¶)</li>
<li><strong>ä»å¼•æ“åˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡(context) ç„¶åï¼Œåå¤ï¼š</strong></li>
<li><strong>å¡«å……è¾“å…¥ç¼“å†²åŒºä»¥è¿›è¡Œæ¨ç†</strong></li>
<li>è°ƒç”¨enqueue()æˆ–execute()ä»¥è¿è¡Œæ¨ç†</li>
</ul>
<p><code>Engine</code>æ¥å£ï¼‰ä»£è¡¨ä¸€ä¸ªä¼˜åŒ–æ¨¡å‹ã€‚æ‚¨å¯ä»¥æŸ¥è¯¢å¼•æ“ä»¥è·å–æœ‰å…³ç½‘ç»œè¾“å…¥å’Œè¾“å‡ºå¼ é‡çš„ä¿¡æ¯â€”â€”é¢„æœŸçš„ç»´åº¦ã€æ•°æ®ç±»å‹ã€æ•°æ®æ ¼å¼ç­‰ã€‚</p>
<p><strong><code>ExecutionContext</code>æ¥å£æ˜¯è°ƒç”¨æ¨ç†çš„ä¸»è¦æ¥å£</strong>ã€‚æ‰§è¡Œä¸Šä¸‹æ–‡åŒ…å«ä¸ç‰¹å®šè°ƒç”¨å…³è”çš„æ‰€æœ‰çŠ¶æ€ â€“ å› æ­¤æ‚¨å¯ä»¥æ‹¥æœ‰ä¸å•ä¸ªå¼•æ“å…³è”çš„å¤šä¸ªä¸Šä¸‹æ–‡ï¼Œå¹¶å¹¶è¡Œè¿è¡Œå®ƒä»¬ã€‚</p>
<p>è°ƒç”¨æ¨ç†æ—¶ï¼Œæ‚¨å¿…é¡»åœ¨é€‚å½“çš„ä½ç½®è®¾ç½®è¾“å…¥å’Œè¾“å‡ºç¼“å†²åŒºã€‚æ ¹æ®æ•°æ®çš„æ€§è´¨ï¼Œè¿™å¯èƒ½åœ¨ CPU æˆ– GPU å†…å­˜ä¸­ã€‚å¦‚æœæ ¹æ®æ‚¨çš„æ¨¡å‹ä¸æ˜æ˜¾ï¼Œæ‚¨å¯ä»¥æŸ¥è¯¢å¼•æ“ä»¥ç¡®å®šåœ¨å“ªä¸ªå†…å­˜ç©ºé—´ä¸­æä¾›ç¼“å†²åŒºã€‚</p>
<p>è®¾ç½®ç¼“å†²åŒºåï¼Œå¯ä»¥åŒæ­¥ï¼ˆæ‰§è¡Œï¼‰æˆ–å¼‚æ­¥ï¼ˆå…¥é˜Ÿï¼‰è°ƒç”¨æ¨ç†ã€‚åœ¨åä¸€ç§æƒ…å†µä¸‹ï¼Œæ‰€éœ€çš„å†…æ ¸åœ¨ CUDA æµä¸Šæ’é˜Ÿï¼Œå¹¶å°½å¿«å°†æ§åˆ¶æƒè¿”å›ç»™åº”ç”¨ç¨‹åºã€‚ä¸€äº›ç½‘ç»œéœ€è¦åœ¨ CPU å’Œ GPU ä¹‹é—´è¿›è¡Œå¤šæ¬¡æ§åˆ¶ä¼ è¾“ï¼Œå› æ­¤æ§åˆ¶å¯èƒ½ä¸ä¼šç«‹å³è¿”å›ã€‚è¦ç­‰å¾…å¼‚æ­¥æ‰§è¡Œå®Œæˆï¼Œè¯·ä½¿ç”¨<code>cudaStreamSynchronize</code>åœ¨æµä¸ŠåŒæ­¥ã€‚</p>
<h2 id="Plugins"><a href="#Plugins" class="headerlink" title="Plugins"></a>Plugins</h2><p>TensorRT æœ‰ä¸€ä¸ª<code>Plugin</code>æ¥å£ï¼Œå…è®¸åº”ç”¨ç¨‹åºæä¾› TensorRT æœ¬èº«ä¸æ”¯æŒçš„æ“ä½œçš„å®ç°ã€‚åœ¨è½¬æ¢ç½‘ç»œæ—¶ï¼ŒONNX è§£æå™¨å¯ä»¥æ‰¾åˆ°ä½¿ç”¨ TensorRT çš„<code>PluginRegistry</code>åˆ›å»ºå’Œæ³¨å†Œçš„æ’ä»¶ã€‚<a class="link"   target="_blank" rel="noopener" href="https://docs.nvidia.com/deeplearning/tensorrt/developer-guide/index.html#extending" >è‡ªå®šä¹‰å±‚æ‰©å±• TensorRT <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h2 id="Types-and-Precision"><a href="#Types-and-Precision" class="headerlink" title="Types and Precision"></a>Types and Precision</h2><p>TensorRT æ”¯æŒä½¿ç”¨ <code>FP32</code>ã€<code>FP16</code>ã€<code>INT8</code>ã€<code>Bool</code> å’Œ <code>INT32</code> æ•°æ®ç±»å‹çš„è®¡ç®—ã€‚ å½“ TensorRT é€‰æ‹© CUDA å†…æ ¸åœ¨ç½‘ç»œä¸­å®ç°æµ®ç‚¹è¿ç®—æ—¶ï¼Œå®ƒé»˜è®¤ä¸º <code>FP32</code> å®ç°ã€‚æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥é…ç½®ä¸åŒçš„ç²¾åº¦çº§åˆ«ï¼š</p>
<ul>
<li>ä¸ºäº†åœ¨æ¨¡å‹çº§åˆ«æ§åˆ¶ç²¾åº¦ï¼Œ BuilderFlagé€‰é¡¹å¯ä»¥å‘ TensorRT æŒ‡ç¤ºå®ƒåœ¨æœç´¢æœ€å¿«æ—¶å¯èƒ½ä¼šé€‰æ‹©è¾ƒä½ç²¾åº¦çš„å®ç°ï¼ˆå¹¶ä¸”å› ä¸ºè¾ƒä½çš„ç²¾åº¦é€šå¸¸æ›´å¿«ï¼Œå¦‚æœå…è®¸çš„è¯ï¼Œå®ƒé€šå¸¸ä¼šï¼‰ã€‚ å› æ­¤ï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°æŒ‡ç¤º TensorRT ä¸ºæ‚¨çš„æ•´ä¸ªæ¨¡å‹ä½¿ç”¨ FP16 è®¡ç®—ã€‚å¯¹äºè¾“å…¥åŠ¨æ€èŒƒå›´çº¦ä¸º 1 çš„æ­£åˆ™åŒ–æ¨¡å‹ï¼Œè¿™é€šå¸¸ä¼šäº§ç”Ÿæ˜¾ç€çš„åŠ é€Ÿï¼Œè€Œå‡†ç¡®åº¦çš„å˜åŒ–å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</li>
<li>å¯¹äºæ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œç”±äºç½‘ç»œçš„ä¸€éƒ¨åˆ†å¯¹æ•°å€¼æ•æ„Ÿæˆ–éœ€è¦é«˜åŠ¨æ€èŒƒå›´ï¼Œå› æ­¤å±‚å¿…é¡»ä»¥æ›´é«˜çš„ç²¾åº¦è¿è¡Œï¼Œå¯ä»¥ä¸ºè¯¥å±‚<strong>æŒ‡å®šç®—æœ¯ç²¾åº¦ã€‚</strong></li>
</ul>
<h2 id="Quantization"><a href="#Quantization" class="headerlink" title="Quantization"></a>Quantization</h2><p>TensorRT æ”¯æŒé‡åŒ–æµ®ç‚¹ï¼Œå…¶ä¸­æµ®ç‚¹å€¼è¢«çº¿æ€§å‹ç¼©å¹¶å››èˆäº”å…¥ä¸º 8 ä½æ•´æ•°ã€‚è¿™æ˜¾ç€æé«˜äº†ç®—æœ¯ååé‡ï¼ŒåŒæ—¶é™ä½äº†å­˜å‚¨è¦æ±‚å’Œå†…å­˜å¸¦å®½ã€‚åœ¨é‡åŒ–æµ®ç‚¹å¼ é‡æ—¶ï¼ŒTensorRT éœ€è¦çŸ¥é“å®ƒçš„åŠ¨æ€èŒƒå›´â€”â€”å³è¡¨ç¤ºä»€ä¹ˆèŒƒå›´çš„å€¼å¾ˆé‡è¦â€”â€”<strong>é‡åŒ–æ—¶ä¼šé’³åˆ¶è¶…å‡ºè¯¥èŒƒå›´çš„å€¼ã€‚</strong></p>
<p><strong>åŠ¨æ€èŒƒå›´ä¿¡æ¯å¯ç”±æ„å»ºå™¨æ ¹æ®ä»£è¡¨æ€§è¾“å…¥æ•°æ®è®¡ç®—ï¼ˆè¿™ç§°ä¸ºæ ¡å‡†â€“<code>calibration</code>ï¼‰</strong>ã€‚æˆ–è€…ï¼Œæ‚¨å¯ä»¥åœ¨æ¡†æ¶ä¸­æ‰§è¡Œé‡åŒ–æ„ŸçŸ¥è®­ç»ƒï¼Œå¹¶å°†æ¨¡å‹ä¸å¿…è¦çš„åŠ¨æ€èŒƒå›´ä¿¡æ¯ä¸€èµ·å¯¼å…¥åˆ° TensorRTã€‚</p>
<h2 id="Tensors-and-Data-Formats"><a href="#Tensors-and-Data-Formats" class="headerlink" title="Tensors and Data Formats"></a>Tensors and Data Formats</h2><p>åœ¨å®šä¹‰ç½‘ç»œæ—¶ï¼ŒTensorRT å‡è®¾å¼ é‡ç”±å¤šç»´ C æ ·å¼æ•°ç»„è¡¨ç¤ºã€‚æ¯ä¸€å±‚å¯¹å…¶è¾“å…¥éƒ½æœ‰ç‰¹å®šçš„è§£é‡Šï¼šä¾‹å¦‚ï¼Œ2D å·ç§¯å°†å‡å®šå…¶è¾“å…¥çš„æœ€åä¸‰ä¸ªç»´åº¦æ˜¯ CHW æ ¼å¼ â€“ æ²¡æœ‰é€‰é¡¹å¯ä»¥ä½¿ç”¨ï¼Œä¾‹å¦‚ WHC æ ¼å¼ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œå¼ é‡æœ€å¤šåªèƒ½åŒ…å« 2^31-1 ä¸ªå…ƒç´ ã€‚ åœ¨ä¼˜åŒ–ç½‘ç»œçš„åŒæ—¶ï¼ŒTensorRT åœ¨å†…éƒ¨æ‰§è¡Œè½¬æ¢ï¼ˆ<strong>åŒ…æ‹¬åˆ° HWCï¼Œä½†ä¹ŸåŒ…æ‹¬æ›´å¤æ‚çš„æ ¼å¼è½¬æ¢</strong>ï¼‰ä»¥ä½¿ç”¨å°½å¯èƒ½å¿«çš„ CUDA å†…æ ¸ã€‚é€šå¸¸ï¼Œé€‰æ‹©æ ¼å¼æ˜¯ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œè€Œåº”ç”¨ç¨‹åºæ— æ³•æ§åˆ¶è¿™äº›é€‰æ‹©ã€‚ç„¶è€Œï¼Œåº•å±‚æ•°æ®æ ¼å¼æš´éœ²åœ¨ I&#x2F;O è¾¹ç•Œï¼ˆç½‘ç»œè¾“å…¥å’Œè¾“å‡ºï¼Œä»¥åŠå°†æ•°æ®ä¼ å…¥å’Œä¼ å‡ºæ’ä»¶ï¼‰ï¼Œä»¥å…è®¸åº”ç”¨ç¨‹åºæœ€å¤§é™åº¦åœ°å‡å°‘ä¸å¿…è¦çš„æ ¼å¼è½¬æ¢ã€‚</p>
<h2 id="Dynamic-Shapes"><a href="#Dynamic-Shapes" class="headerlink" title="Dynamic Shapes"></a>Dynamic Shapes</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒTensorRT æ ¹æ®å®šä¹‰æ—¶çš„è¾“å…¥å½¢çŠ¶ï¼ˆæ‰¹é‡å¤§å°ã€å›¾åƒå¤§å°ç­‰ï¼‰ä¼˜åŒ–æ¨¡å‹ã€‚ä½†æ˜¯ï¼Œå¯ä»¥å°†æ„å»ºå™¨é…ç½®ä¸ºå…è®¸åœ¨è¿è¡Œæ—¶è°ƒæ•´è¾“å…¥ç»´åº¦ã€‚ä¸ºäº†å¯ç”¨æ­¤åŠŸèƒ½ï¼Œæ‚¨å¯ä»¥åœ¨æ„å»ºå™¨é…ç½®ä¸­æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ª<code>OptimizationProfile</code>å®ä¾‹ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸ªè¾“å…¥çš„æœ€å°å’Œæœ€å¤§å½¢çŠ¶ï¼Œä»¥åŠè¯¥èŒƒå›´å†…çš„ä¼˜åŒ–ç‚¹ã€‚</p>
<p>TensorRT ä¸ºæ¯ä¸ªé…ç½®æ–‡ä»¶åˆ›å»ºä¸€ä¸ªä¼˜åŒ–çš„å¼•æ“ï¼Œé€‰æ‹©é€‚ç”¨äº [æœ€å°ã€æœ€å¤§] èŒƒå›´å†…çš„æ‰€æœ‰å½¢çŠ¶çš„ CUDA å†…æ ¸ï¼Œå¹¶ä¸”å¯¹äºä¼˜åŒ–ç‚¹æ¥è¯´æ˜¯æœ€å¿«çš„â€”â€”<strong>é€šå¸¸æ¯ä¸ªé…ç½®æ–‡ä»¶éƒ½æœ‰ä¸åŒçš„å†…æ ¸</strong>ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥åœ¨è¿è¡Œæ—¶åœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé€‰æ‹©ã€‚</p>
<h2 id="DLA"><a href="#DLA" class="headerlink" title="DLA"></a>DLA</h2><p>TensorRT æ”¯æŒ NVIDIA çš„æ·±åº¦å­¦ä¹ åŠ é€Ÿå™¨ (DLA)ï¼Œè¿™æ˜¯è®¸å¤š NVIDIA SoC ä¸Šçš„ä¸“ç”¨æ¨ç†å¤„ç†å™¨ï¼Œæ”¯æŒ TensorRT å±‚çš„å­é›†ã€‚ TensorRT å…è®¸æ‚¨åœ¨ DLA ä¸Šæ‰§è¡Œéƒ¨åˆ†ç½‘ç»œï¼Œè€Œåœ¨ GPU ä¸Šæ‰§è¡Œå…¶ä½™éƒ¨åˆ†ï¼›å¯¹äºå¯ä»¥åœ¨ä»»ä¸€è®¾å¤‡ä¸Šæ‰§è¡Œçš„å±‚ï¼Œæ‚¨å¯ä»¥åœ¨æ„å»ºå™¨é…ç½®ä¸­é€å±‚é€‰æ‹©ç›®æ ‡è®¾å¤‡ã€‚</p>
<h2 id="Updating-Weights"><a href="#Updating-Weights" class="headerlink" title="Updating Weights"></a>Updating Weights</h2><p><strong>åœ¨æ„å»ºå¼•æ“æ—¶ï¼Œæ‚¨å¯ä»¥æŒ‡å®šå®ƒå¯èƒ½éœ€è¦ç¨åæ›´æ–°å…¶æƒé‡</strong>ã€‚å¦‚æœæ‚¨ç»å¸¸åœ¨ä¸æ›´æ”¹ç»“æ„çš„æƒ…å†µä¸‹æ›´æ–°æ¨¡å‹çš„æƒé‡ï¼Œä¾‹å¦‚åœ¨å¼ºåŒ–å­¦ä¹ ä¸­æˆ–åœ¨ä¿ç•™ç›¸åŒç»“æ„çš„åŒæ—¶é‡æ–°è®­ç»ƒæ¨¡å‹æ—¶ï¼Œè¿™å°†å¾ˆæœ‰ç”¨ã€‚æƒé‡æ›´æ–°æ˜¯é€šè¿‡**<code>Refitter</code>** æ¥å£æ‰§è¡Œçš„ã€‚</p>
<h2 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a><strong>å·¥å…·</strong></h2><h3 id="trtexec"><a href="#trtexec" class="headerlink" title="trtexec"></a>trtexec</h3><p>ç¤ºä¾‹ç›®å½•ä¸­åŒ…å«ä¸€ä¸ªåä¸º<code>trtexec</code>çš„å‘½ä»¤è¡ŒåŒ…è£…å·¥å…·ã€‚ <code>trtexec</code>æ˜¯ä¸€ç§æ— éœ€å¼€å‘è‡ªå·±çš„åº”ç”¨ç¨‹åºå³å¯å¿«é€Ÿä½¿ç”¨ TensorRT çš„å·¥å…·ã€‚ trtexecå·¥å…·æœ‰ä¸‰ä¸ªä¸»è¦ç”¨é€”ï¼š</p>
<ul>
<li><strong>åœ¨éšæœºæˆ–ç”¨æˆ·æä¾›çš„è¾“å…¥æ•°æ®ä¸Šå¯¹ç½‘ç»œè¿›è¡ŒåŸºå‡†æµ‹è¯•ã€‚</strong></li>
<li>ä»æ¨¡å‹ç”Ÿæˆåºåˆ—åŒ–å¼•æ“ã€‚</li>
<li>ä»æ„å»ºå™¨ç”Ÿæˆåºåˆ—åŒ–æ—¶åºç¼“å­˜ã€‚</li>
</ul>
<h3 id="Polygraphy"><a href="#Polygraphy" class="headerlink" title="Polygraphy"></a>Polygraphy</h3><p>Polygraphy æ˜¯ä¸€ä¸ªå·¥å…·åŒ…ï¼Œæ—¨åœ¨å¸®åŠ©åœ¨ TensorRT å’Œå…¶ä»–æ¡†æ¶ä¸­è¿è¡Œå’Œè°ƒè¯•æ·±åº¦å­¦ä¹ æ¨¡å‹ã€‚å®ƒåŒ…æ‹¬ä¸€ä¸ªPython APIå’Œä¸€ä¸ªä½¿ç”¨æ­¤ API æ„å»ºçš„å‘½ä»¤è¡Œç•Œé¢ (CLI) ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œä½¿ç”¨ Polygraphyï¼Œæ‚¨å¯ä»¥ï¼š</p>
<ul>
<li>åœ¨å¤šä¸ªåç«¯ä¹‹é—´è¿è¡Œæ¨ç†ï¼Œä¾‹å¦‚ TensorRT å’Œ ONNX-Runtimeï¼Œå¹¶æ¯”è¾ƒç»“æœï¼ˆä¾‹å¦‚<a class="link"   target="_blank" rel="noopener" href="https://github.com/NVIDIA/TensorRT/blob/main/tools/Polygraphy/examples/api/01_comparing_frameworks" >API <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> ã€ <a class="link"   target="_blank" rel="noopener" href="https://github.com/NVIDIA/TensorRT/blob/main/tools/Polygraphy/examples/cli/run/01_comparing_frameworks" >CLI <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> ï¼‰</li>
<li>å°†æ¨¡å‹è½¬æ¢ä¸ºå„ç§æ ¼å¼ï¼Œä¾‹å¦‚å…·æœ‰è®­ç»ƒåé‡åŒ–çš„ TensorRT å¼•æ“ï¼ˆä¾‹å¦‚<a class="link"   target="_blank" rel="noopener" href="https://github.com/NVIDIA/TensorRT/blob/main/tools/Polygraphy/examples/api/04_int8_calibration_in_tensorrt" >API <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> ã€ <a class="link"   target="_blank" rel="noopener" href="https://github.com/NVIDIA/TensorRT/blob/main/tools/Polygraphy/examples/cli/convert/01_int8_calibration_in_tensorrt" >CLI <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> ï¼‰</li>
<li>æŸ¥çœ‹æœ‰å…³å„ç§ç±»å‹æ¨¡å‹çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚<a class="link"   target="_blank" rel="noopener" href="https://github.com/NVIDIA/TensorRT/blob/main/tools/Polygraphy/examples/cli/inspect" >CLI <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> ï¼‰</li>
<li>åœ¨å‘½ä»¤è¡Œä¸Šä¿®æ”¹ ONNX æ¨¡å‹ï¼š<ul>
<li>æå–å­å›¾ï¼ˆä¾‹å¦‚<a class="link"   target="_blank" rel="noopener" href="https://github.com/NVIDIA/TensorRT/blob/main/tools/Polygraphy/examples/cli/surgeon/01_isolating_subgraphs" >CLI <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> ï¼‰</li>
<li>ç®€åŒ–å’Œæ¸…ç†ï¼ˆä¾‹å¦‚<a class="link"   target="_blank" rel="noopener" href="https://github.com/NVIDIA/TensorRT/blob/main/tools/Polygraphy/examples/cli/surgeon/02_folding_constants" >CLI <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> ï¼‰</li>
</ul>
</li>
<li>éš”ç¦» TensorRT ä¸­çš„é”™è¯¯ç­–ç•¥ï¼ˆä¾‹å¦‚<a class="link"   target="_blank" rel="noopener" href="https://github.com/NVIDIA/TensorRT/blob/main/tools/Polygraphy/examples/cli/debug/01_debugging_flaky_trt_tactics" >CLI <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> ï¼‰</li>
</ul>
<h1 id="TensorRTçš„C-æ¥å£è§£æ"><a href="#TensorRTçš„C-æ¥å£è§£æ" class="headerlink" title="TensorRTçš„C++æ¥å£è§£æ"></a>TensorRTçš„C++æ¥å£è§£æ</h1><p>C++ API å¯ä»¥é€šè¿‡å¤´æ–‡ä»¶<code>NvInfer.h</code>è®¿é—®ï¼Œå¹¶ä¸”ä½äº<code>nvinfer1</code>å‘½åç©ºé—´ä¸­ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºå¯èƒ½ä»¥ä¸‹å¼€å¤´ï¼š</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> â€œNvInfer.hâ€</span></span><br><span class="line"></span><br><span class="line">using namespace nvinfer1;</span><br></pre></td></tr></table></figure></div>

<p><strong>CUDA ä¸Šä¸‹æ–‡ä¼šåœ¨ TensorRT ç¬¬ä¸€æ¬¡è°ƒç”¨ CUDA æ—¶è‡ªåŠ¨åˆ›å»ºï¼Œ</strong>å¦‚æœåœ¨è¯¥ç‚¹ä¹‹å‰ä¸å­˜åœ¨ã€‚é€šå¸¸æœ€å¥½åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ TensoRT ä¹‹å‰è‡ªå·±åˆ›å»ºå’Œé…ç½® CUDA ä¸Šä¸‹æ–‡ã€‚ ä¸ºäº†è¯´æ˜å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œæœ¬ç« ä¸­çš„ä»£ç ä¸ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆï¼›ä½†æ˜¯ï¼Œå»ºè®®å°†å®ƒä»¬ä¸ TensorRT æ¥å£ä¸€èµ·ä½¿ç”¨ã€‚</p>
<h2 id="The-Build-Phase"><a href="#The-Build-Phase" class="headerlink" title="The Build Phase"></a>The Build Phase</h2><p>è¦åˆ›å»ºæ„å»ºå™¨ï¼Œé¦–å…ˆéœ€è¦å®ä¾‹åŒ–ILoggeræ¥å£ã€‚æ­¤ç¤ºä¾‹æ•è·æ‰€æœ‰è­¦å‘Šæ¶ˆæ¯ï¼Œä½†å¿½ç•¥ä¿¡æ¯æ€§æ¶ˆæ¯ï¼š</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span> :</span> public ILogger           </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">log</span><span class="params">(Severity severity, <span class="type">const</span> <span class="type">char</span>* msg)</span> noexcept override</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// suppress info-level messages</span></span><br><span class="line">        <span class="keyword">if</span> (severity &lt;= Severity::kWARNING)</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; msg &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; logger;</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åï¼Œæ‚¨å¯ä»¥åˆ›å»ºæ„å»ºå™¨çš„å®ä¾‹ï¼š</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IBuilder* builder = createInferBuilder(logger);</span><br></pre></td></tr></table></figure></div>

<h3 id="Creating-a-Network-Definition"><a href="#Creating-a-Network-Definition" class="headerlink" title="Creating a Network Definition"></a>Creating a Network Definition</h3><p>åˆ›å»ºæ„å»ºå™¨åï¼Œä¼˜åŒ–æ¨¡å‹çš„ç¬¬ä¸€æ­¥æ˜¯åˆ›å»ºç½‘ç»œå®šä¹‰ï¼š</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint32_t</span> flag = <span class="number">1U</span> &lt;&lt;static_cast&lt;<span class="type">uint32_t</span>&gt;</span><br><span class="line">    (NetworkDefinitionCreationFlag::kEXPLICIT_BATCH); 	<span class="comment">//ä¸ºäº†ä½¿ç”¨ ONNX è§£æå™¨å¯¼å…¥æ¨¡å‹ï¼Œéœ€è¦kEXPLICIT_BATCHæ ‡å¿—ã€‚</span></span><br><span class="line"></span><br><span class="line">INetworkDefinition* network = builder-&gt;createNetworkV2(flag);</span><br></pre></td></tr></table></figure></div>

<h3 id="Importing-a-Model-using-the-ONNX-Parser"><a href="#Importing-a-Model-using-the-ONNX-Parser" class="headerlink" title="Importing a Model using the ONNX Parser"></a>Importing a Model using the ONNX Parser</h3><p>ç°åœ¨ï¼Œéœ€è¦ä» ONNX è¡¨ç¤ºä¸­å¡«å……ç½‘ç»œå®šä¹‰ã€‚ ONNX è§£æå™¨ API ä½äºæ–‡ä»¶NvOnnxParser.hä¸­ï¼Œè§£æå™¨ä½äº<code>nvonnxparser</code> C++ å‘½åç©ºé—´ä¸­ã€‚</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> â€œNvOnnxParser.hâ€</span></span><br><span class="line"></span><br><span class="line">using namespace nvonnxparser;</span><br></pre></td></tr></table></figure></div>

<p>æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ª ONNX è§£æå™¨æ¥å¡«å……ç½‘ç»œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IParser*  parser = createParser(*network, logger);</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åï¼Œè¯»å–æ¨¡å‹æ–‡ä»¶å¹¶å¤„ç†ä»»ä½•é”™è¯¯ã€‚</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">parser-&gt;parseFromFile(modelFile, </span><br><span class="line">    static_cast&lt;<span class="type">int32_t</span>&gt;(ILogger::Severity::kWARNING));</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int32_t</span> i = <span class="number">0</span>; i &lt; parser.getNbErrors(); ++i)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; parser-&gt;getError(i)-&gt;desc() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>TensorRT ç½‘ç»œå®šä¹‰çš„ä¸€ä¸ªé‡è¦æ–¹é¢æ˜¯å®ƒåŒ…å«æŒ‡å‘æ¨¡å‹æƒé‡çš„æŒ‡é’ˆï¼Œè¿™äº›æŒ‡é’ˆç”±æ„å»ºå™¨å¤åˆ¶åˆ°ä¼˜åŒ–çš„å¼•æ“ä¸­ã€‚<strong>ç”±äºç½‘ç»œæ˜¯é€šè¿‡è§£æå™¨åˆ›å»ºçš„ï¼Œè§£æå™¨æ‹¥æœ‰æƒé‡å ç”¨çš„å†…å­˜ï¼Œå› æ­¤åœ¨æ„å»ºå™¨è¿è¡Œä¹‹å‰ä¸åº”åˆ é™¤è§£æå™¨å¯¹è±¡ã€‚</strong></p>
<h3 id="Building-an-Engine"><a href="#Building-an-Engine" class="headerlink" title="Building an Engine"></a>Building an Engine</h3><p>ä¸‹ä¸€æ­¥æ˜¯åˆ›å»ºä¸€ä¸ªæ„å»ºé…ç½®ï¼ŒæŒ‡å®š TensorRT åº”è¯¥å¦‚ä½•ä¼˜åŒ–æ¨¡å‹ã€‚</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IBuilderConfig* config = builder-&gt;createBuilderConfig();</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªæ¥å£æœ‰å¾ˆå¤šå±æ€§ï¼Œä½ å¯ä»¥è®¾ç½®è¿™äº›å±æ€§æ¥æ§åˆ¶ TensorRT å¦‚ä½•ä¼˜åŒ–ç½‘ç»œã€‚<strong>ä¸€ä¸ªé‡è¦çš„å±æ€§æ˜¯æœ€å¤§å·¥ä½œç©ºé—´å¤§å°</strong>ã€‚å±‚å®ç°é€šå¸¸éœ€è¦ä¸€ä¸ªä¸´æ—¶å·¥ä½œç©ºé—´ï¼Œå¹¶ä¸”æ­¤å‚æ•°é™åˆ¶äº†ç½‘ç»œä¸­ä»»ä½•å±‚å¯ä»¥ä½¿ç”¨çš„æœ€å¤§å¤§å°ã€‚<strong>å¦‚æœæä¾›çš„å·¥ä½œç©ºé—´ä¸è¶³ï¼ŒTensorRT å¯èƒ½æ— æ³•æ‰¾åˆ°å±‚çš„å®ç°</strong>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå·¥ä½œåŒºè®¾ç½®ä¸ºç»™å®šè®¾å¤‡çš„æ€»å…¨å±€å†…å­˜å¤§å°ï¼›å¿…è¦æ—¶é™åˆ¶å®ƒï¼Œä¾‹å¦‚ï¼Œåœ¨å•ä¸ªè®¾å¤‡ä¸Šæ„å»ºå¤šä¸ªå¼•æ“æ—¶ã€‚</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config-&gt;setMemoryPoolLimit(MemoryPoolType::kWORKSPACE, <span class="number">1U</span> &lt;&lt; <span class="number">20</span>);</span><br></pre></td></tr></table></figure></div>

<p>ä¸€æ—¦æŒ‡å®šäº†é…ç½®ï¼Œå°±å¯ä»¥æ„å»ºå¼•æ“ã€‚</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IHostMemory*  serializedModel = builder-&gt;buildSerializedNetwork(*network, *config);</span><br></pre></td></tr></table></figure></div>

<p><strong>ç”±äºåºåˆ—åŒ–å¼•æ“åŒ…å«æƒé‡çš„å¿…è¦æ‹·è´</strong>ï¼Œå› æ­¤ä¸å†éœ€è¦è§£æå™¨ã€ç½‘ç»œå®šä¹‰ã€æ„å»ºå™¨é…ç½®å’Œæ„å»ºå™¨ï¼Œå¯ä»¥å®‰å…¨åœ°åˆ é™¤ï¼š</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">delete parser;</span><br><span class="line">delete network;</span><br><span class="line">delete config;</span><br><span class="line">delete builder;</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åå¯ä»¥å°†å¼•æ“ä¿å­˜åˆ°ç£ç›˜ï¼Œå¹¶ä¸”å¯ä»¥åˆ é™¤å®ƒè¢«åºåˆ—åŒ–åˆ°çš„ç¼“å†²åŒºã€‚</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete serializedModel</span><br></pre></td></tr></table></figure></div>

<p><strong>æ³¨æ„ï¼šåºåˆ—åŒ–å¼•æ“ä¸èƒ½è·¨å¹³å°æˆ– TensorRT ç‰ˆæœ¬ç§»æ¤ã€‚å¼•æ“ç‰¹å®šäºå®ƒä»¬æ„å»ºçš„ç¡®åˆ‡ GPU æ¨¡å‹ï¼ˆé™¤äº†å¹³å°å’Œ TensorRT ç‰ˆæœ¬ï¼‰ã€‚</strong></p>
<h2 id="Deserializing-a-Plan"><a href="#Deserializing-a-Plan" class="headerlink" title="Deserializing a Plan"></a>Deserializing a Plan</h2><p>å‡è®¾æ‚¨ä¹‹å‰å·²ç»åºåˆ—åŒ–äº†ä¸€ä¸ªä¼˜åŒ–æ¨¡å‹å¹¶å¸Œæœ›æ‰§è¡Œæ¨ç†ï¼Œæ‚¨å°†éœ€è¦åˆ›å»ºä¸€ä¸ª<strong>è¿è¡Œæ—¶æ¥å£</strong>çš„å®ä¾‹ã€‚ä¸æ„å»ºå™¨ä¸€æ ·ï¼Œè¿è¡Œæ—¶éœ€è¦ä¸€ä¸ªè®°å½•å™¨å®ä¾‹ï¼š</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IRuntime* runtime = createInferRuntime(logger);</span><br></pre></td></tr></table></figure></div>

<p>å‡è®¾æ‚¨å·²å°†æ¨¡å‹ä»ç¼“å†²åŒºä¸­è¯»å–ï¼Œç„¶åå¯ä»¥å¯¹å…¶è¿›è¡Œååºåˆ—åŒ–ä»¥è·å¾—å¼•æ“ï¼š</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ICudaEngine* engine = </span><br><span class="line">  runtime-&gt;deserializeCudaEngine(modelData, modelSize);</span><br></pre></td></tr></table></figure></div>

<h2 id="Performing-Inference"><a href="#Performing-Inference" class="headerlink" title="Performing Inference"></a>Performing Inference</h2><p>å¼•æ“æ‹¥æœ‰ä¼˜åŒ–çš„æ¨¡å‹ï¼Œä½†è¦æ‰§è¡Œæ¨ç†ï¼Œ<strong>æˆ‘ä»¬éœ€è¦ç®¡ç†ä¸­é—´æ¿€æ´»çš„é¢å¤–çŠ¶æ€</strong>ã€‚è¿™æ˜¯é€šè¿‡<code>ExecutionContext</code>æ¥å£å®Œæˆçš„ï¼š</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IExecutionContext *context = engine-&gt;createExecutionContext();</span><br></pre></td></tr></table></figure></div>

<p>ä¸€ä¸ªå¼•æ“å¯ä»¥æœ‰å¤šä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå…è®¸ä¸€ç»„æƒé‡ç”¨äºå¤šä¸ªé‡å çš„æ¨ç†ä»»åŠ¡ã€‚ ï¼ˆå½“å‰çš„ä¸€ä¸ªä¾‹å¤–æ˜¯<strong>ä½¿ç”¨åŠ¨æ€å½¢çŠ¶æ—¶ï¼Œæ¯ä¸ªä¼˜åŒ–é…ç½®æ–‡ä»¶åªèƒ½æœ‰ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ã€‚</strong>ï¼‰</p>
<p><strong>è¦æ‰§è¡Œæ¨ç†ï¼Œæ‚¨å¿…é¡»ä¸ºè¾“å…¥å’Œè¾“å‡ºä¼ é€’ TensorRT ç¼“å†²åŒº</strong>ï¼ŒTensorRT è¦æ±‚æ‚¨åœ¨æŒ‡é’ˆæ•°ç»„ä¸­æŒ‡å®šã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä¸ºè¾“å…¥å’Œè¾“å‡ºå¼ é‡æä¾›çš„åç§°æŸ¥è¯¢å¼•æ“ï¼Œä»¥åœ¨æ•°ç»„ä¸­æ‰¾åˆ°æ­£ç¡®çš„ä½ç½®ï¼š</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int32_t</span> inputIndex = engine-&gt;getBindingIndex(INPUT_NAME);</span><br><span class="line"><span class="type">int32_t</span> outputIndex = engine-&gt;getBindingIndex(OUTPUT_NAME);</span><br></pre></td></tr></table></figure></div>

<p>ä½¿ç”¨è¿™äº›ç´¢å¼•ï¼Œè®¾ç½®ä¸€ä¸ªç¼“å†²åŒºæ•°ç»„ï¼ŒæŒ‡å‘ GPU ä¸Šçš„è¾“å…¥å’Œè¾“å‡ºç¼“å†²åŒºï¼š</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span>* buffers[<span class="number">2</span>];</span><br><span class="line">buffers[inputIndex] = inputBuffer;</span><br><span class="line">buffers[outputIndex] = outputBuffer;</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åï¼Œæ‚¨å¯ä»¥è°ƒç”¨ TensorRT çš„ <strong>enqueue</strong> æ–¹æ³•ä»¥ä½¿ç”¨CUDA æµå¼‚æ­¥å¯åŠ¨æ¨ç†ï¼š</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context-&gt;enqueueV2(buffers, stream, nullptr);</span><br></pre></td></tr></table></figure></div>

<p>é€šå¸¸åœ¨å†…æ ¸ä¹‹å‰å’Œä¹‹åå°†<code>cudaMemcpyAsync()</code> æ’å…¥é˜Ÿåˆ—ä»¥ä» GPU ä¸­ç§»åŠ¨æ•°æ®ï¼ˆå¦‚æœæ•°æ®å°šä¸å­˜åœ¨ï¼‰ã€‚</p>
<p> <strong><code>enqueueV2()</code>çš„æœ€åä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯é€‰çš„ CUDA äº‹ä»¶ï¼Œå½“è¾“å…¥ç¼“å†²åŒºè¢«æ¶ˆè€—æ—¶å‘å‡ºä¿¡å·ï¼Œå¹¶ä¸”å¯ä»¥å®‰å…¨åœ°é‡ç”¨å®ƒä»¬çš„å†…å­˜ã€‚</strong></p>
<p>è¦ç¡®å®šå†…æ ¸ï¼ˆå¯èƒ½è¿˜æœ‰<code>memcpy()</code> ï¼‰ä½•æ—¶å®Œæˆï¼Œè¯·ä½¿ç”¨æ ‡å‡† CUDA åŒæ­¥æœºåˆ¶ï¼Œä¾‹å¦‚äº‹ä»¶æˆ–ç­‰å¾…æµã€‚</p>
<p><strong>å¦‚æœæ‚¨æ›´å–œæ¬¢åŒæ­¥æ¨ç†ï¼Œè¯·ä½¿ç”¨<code>executeV2</code>æ–¹æ³•è€Œä¸æ˜¯<code>enqueueV2 </code>ã€‚</strong></p>
<h1 id="TensorRT-çš„-Python-æ¥å£è§£æ"><a href="#TensorRT-çš„-Python-æ¥å£è§£æ" class="headerlink" title="TensorRT çš„ Python æ¥å£è§£æ"></a>TensorRT çš„ Python æ¥å£è§£æ</h1><p>Python API å¯ä»¥é€šè¿‡tensorrtæ¨¡å—è®¿é—®ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorrt <span class="keyword">as</span> trt</span><br></pre></td></tr></table></figure></div>

<h2 id="The-Build-Phase-1"><a href="#The-Build-Phase-1" class="headerlink" title="The Build Phase"></a>The Build Phase</h2><p>è¦åˆ›å»ºæ„å»ºå™¨ï¼Œæ‚¨éœ€è¦é¦–å…ˆåˆ›å»ºä¸€ä¸ªè®°å½•å™¨ã€‚ Python ç»‘å®šåŒ…æ‹¬ä¸€ä¸ªç®€å•çš„è®°å½•å™¨å®ç°ï¼Œå®ƒå°†é«˜äºç‰¹å®šä¸¥é‡æ€§çš„æ‰€æœ‰æ¶ˆæ¯è®°å½•åˆ°<code>stdout</code> ã€‚</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger = trt.Logger(trt.Logger.WARNING)</span><br></pre></td></tr></table></figure></div>

<p>æˆ–è€…ï¼Œå¯ä»¥é€šè¿‡ä»<code>ILogger</code>ç±»æ´¾ç”Ÿæ¥å®šä¹‰æ‚¨è‡ªå·±çš„è®°å½•å™¨å®ç°ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyLogger</span>(trt.ILogger):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">       trt.ILogger.__init__(self)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log</span>(<span class="params">self, severity, msg</span>):</span><br><span class="line">        <span class="keyword">pass</span> <span class="comment"># Your custom logging implementation here</span></span><br><span class="line"></span><br><span class="line">logger = MyLogger()</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ„å»ºå™¨ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder = trt.Builder(logger)</span><br></pre></td></tr></table></figure></div>

<h3 id="Creating-a-Network-Definition-in-Python"><a href="#Creating-a-Network-Definition-in-Python" class="headerlink" title="Creating a Network Definition in Python"></a>Creating a Network Definition in Python</h3><p>åˆ›å»ºæ„å»ºå™¨åï¼Œä¼˜åŒ–æ¨¡å‹çš„ç¬¬ä¸€æ­¥æ˜¯åˆ›å»ºç½‘ç»œå®šä¹‰ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">network = builder.create_network(<span class="number">1</span> &lt;&lt; <span class="built_in">int</span>(trt.NetworkDefinitionCreationFlag.EXPLICIT_BATCH))</span><br></pre></td></tr></table></figure></div>

<p><strong>ä¸ºäº†ä½¿ç”¨ ONNX è§£æå™¨å¯¼å…¥æ¨¡å‹ï¼Œéœ€è¦<code>EXPLICIT_BATCH</code>æ ‡å¿—ã€‚</strong></p>
<h3 id="Importing-a-Model-using-the-ONNX-Parser-1"><a href="#Importing-a-Model-using-the-ONNX-Parser-1" class="headerlink" title="Importing a Model using the ONNX Parser"></a>Importing a Model using the ONNX Parser</h3><p>ç°åœ¨ï¼Œéœ€è¦ä» ONNX è¡¨ç¤ºä¸­å¡«å……ç½‘ç»œå®šä¹‰ã€‚æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ª ONNX è§£æå™¨æ¥å¡«å……ç½‘ç»œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">parser = trt.OnnxParser(network, logger)</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åï¼Œè¯»å–æ¨¡å‹æ–‡ä»¶å¹¶å¤„ç†ä»»ä½•é”™è¯¯ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">success = parser.parse_from_file(model_path)</span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(parser.num_errors):</span><br><span class="line">    <span class="built_in">print</span>(parser.get_error(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> success:</span><br><span class="line">    <span class="keyword">pass</span> <span class="comment"># Error handling code here</span></span><br></pre></td></tr></table></figure></div>

<h3 id="Building-an-Engine-1"><a href="#Building-an-Engine-1" class="headerlink" title="Building an Engine"></a>Building an Engine</h3><p>ä¸‹ä¸€æ­¥æ˜¯åˆ›å»ºä¸€ä¸ªæ„å»ºé…ç½®ï¼ŒæŒ‡å®š TensorRT åº”è¯¥å¦‚ä½•ä¼˜åŒ–æ¨¡å‹ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config = builder.create_builder_config()</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªæ¥å£æœ‰å¾ˆå¤šå±æ€§ï¼Œä½ å¯ä»¥è®¾ç½®è¿™äº›å±æ€§æ¥æ§åˆ¶ TensorRT å¦‚ä½•ä¼˜åŒ–ç½‘ç»œã€‚ä¸€ä¸ªé‡è¦çš„å±æ€§æ˜¯æœ€å¤§å·¥ä½œç©ºé—´å¤§å°ã€‚å±‚å®ç°é€šå¸¸éœ€è¦ä¸€ä¸ªä¸´æ—¶å·¥ä½œç©ºé—´ï¼Œå¹¶ä¸”æ­¤å‚æ•°é™åˆ¶äº†ç½‘ç»œä¸­ä»»ä½•å±‚å¯ä»¥ä½¿ç”¨çš„æœ€å¤§å¤§å°ã€‚å¦‚æœæä¾›çš„å·¥ä½œç©ºé—´ä¸è¶³ï¼ŒTensorRT å¯èƒ½æ— æ³•æ‰¾åˆ°å±‚çš„å®ç°ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.set_memory_pool_limit(trt.MemoryPoolType.WORKSPACE, <span class="number">1</span> &lt;&lt; <span class="number">20</span>) <span class="comment"># 1 MiB</span></span><br></pre></td></tr></table></figure></div>

<p>æŒ‡å®šé…ç½®åï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ„å»ºå’Œåºåˆ—åŒ–å¼•æ“ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serialized_engine = builder.build_serialized_network(network, config)</span><br></pre></td></tr></table></figure></div>

<p>å°†å¼•æ“ä¿å­˜åˆ°æ–‡ä»¶ä»¥ä¾›å°†æ¥ä½¿ç”¨å¯èƒ½å¾ˆæœ‰ç”¨ã€‚ä½ å¯ä»¥è¿™æ ·åšï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(â€œsample.engineâ€, â€œwbâ€) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(serialized_engine)</span><br></pre></td></tr></table></figure></div>

<h2 id="Performing-Inference-1"><a href="#Performing-Inference-1" class="headerlink" title="Performing Inference"></a>Performing Inference</h2><p><strong>å¼•æ“æ‹¥æœ‰ä¼˜åŒ–çš„æ¨¡å‹ï¼Œä½†è¦æ‰§è¡Œæ¨ç†éœ€è¦é¢å¤–çš„ä¸­é—´æ¿€æ´»çŠ¶æ€ã€‚è¿™æ˜¯é€šè¿‡<code>IExecutionContext</code>æ¥å£å®Œæˆçš„ï¼š</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context = engine.create_execution_context()</span><br></pre></td></tr></table></figure></div>

<p>ä¸€ä¸ªå¼•æ“å¯ä»¥æœ‰å¤šä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå…è®¸ä¸€ç»„æƒé‡ç”¨äºå¤šä¸ªé‡å çš„æ¨ç†ä»»åŠ¡ã€‚ ï¼ˆå½“å‰çš„ä¸€ä¸ªä¾‹å¤–æ˜¯ä½¿ç”¨åŠ¨æ€å½¢çŠ¶æ—¶ï¼Œæ¯ä¸ªä¼˜åŒ–é…ç½®æ–‡ä»¶åªèƒ½æœ‰ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ã€‚ï¼‰</p>
<p><strong>è¦æ‰§è¡Œæ¨ç†ï¼Œæ‚¨å¿…é¡»ä¸ºè¾“å…¥å’Œè¾“å‡ºä¼ é€’ TensorRT ç¼“å†²åŒº</strong>ï¼ŒTensorRT è¦æ±‚æ‚¨åœ¨ GPU æŒ‡é’ˆåˆ—è¡¨ä¸­æŒ‡å®šã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä¸ºè¾“å…¥å’Œè¾“å‡ºå¼ é‡æä¾›çš„åç§°æŸ¥è¯¢å¼•æ“ï¼Œä»¥åœ¨æ•°ç»„ä¸­æ‰¾åˆ°æ­£ç¡®çš„ä½ç½®ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">input_idx = engine[input_name]</span><br><span class="line">output_idx = engine[output_name]		<span class="comment">#é€šè¿‡å¼•æ“æŸ¥æ‰¾è¾“å‡ºçš„ç´¢å¼•</span></span><br></pre></td></tr></table></figure></div>

<p>ä½¿ç”¨è¿™äº›ç´¢å¼•ï¼Œä¸ºæ¯ä¸ªè¾“å…¥å’Œè¾“å‡ºè®¾ç½® GPU ç¼“å†²åŒºã€‚å¤šä¸ª Python åŒ…å…è®¸æ‚¨åœ¨ GPU ä¸Šåˆ†é…å†…å­˜ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº PyTorchã€Polygraphy CUDA åŒ…è£…å™¨å’Œ PyCUDAã€‚</p>
<p>ç„¶åï¼Œåˆ›å»ºä¸€ä¸ª GPU æŒ‡é’ˆåˆ—è¡¨ã€‚ä¾‹å¦‚ï¼Œå¯¹äº PyTorch CUDA å¼ é‡ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>data_ptr()</code>æ–¹æ³•è®¿é—® GPU æŒ‡é’ˆï¼›å¯¹äº Polygraphy <code>DeviceArray</code> ï¼Œä½¿ç”¨<code>ptr</code>å±æ€§ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">buffers = [<span class="literal">None</span>] * <span class="number">2</span> <span class="comment"># Assuming 1 input and 1 output</span></span><br><span class="line">buffers[input_idx] = input_ptr</span><br><span class="line">buffers[output_idx] = output_ptr</span><br></pre></td></tr></table></figure></div>

<p><strong>å¡«å……è¾“å…¥ç¼“å†²åŒºåï¼Œæ‚¨å¯ä»¥è°ƒç”¨ TensorRT çš„<code>execute_async</code>æ–¹æ³•ä»¥ä½¿ç”¨ CUDA æµå¼‚æ­¥å¯åŠ¨æ¨ç†ã€‚</strong></p>
<p>é¦–å…ˆï¼Œåˆ›å»º CUDA æµã€‚å¦‚æœæ‚¨å·²ç»æœ‰ CUDA æµï¼Œåˆ™å¯ä»¥ä½¿ç”¨æŒ‡å‘ç°æœ‰æµçš„æŒ‡é’ˆã€‚ä¾‹å¦‚ï¼Œå¯¹äº PyTorch CUDA æµï¼Œå³<code>torch.cuda.Stream() </code>ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>cuda_stream</code>å±æ€§è®¿é—®æŒ‡é’ˆï¼›å¯¹äº Polygraphy CUDA æµï¼Œä½¿ç”¨<code>ptr</code>å±æ€§ã€‚ æ¥ä¸‹æ¥ï¼Œå¼€å§‹æ¨ç†ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.execute_async_v2(buffers, stream_ptr)</span><br></pre></td></tr></table></figure></div>

<p>é€šå¸¸åœ¨å†…æ ¸ä¹‹å‰å’Œä¹‹åå°†å¼‚æ­¥<code>memcpy()</code>æ’å…¥é˜Ÿåˆ—ä»¥ä» GPU ä¸­ç§»åŠ¨æ•°æ®ï¼ˆå¦‚æœæ•°æ®å°šä¸å­˜åœ¨ï¼‰ã€‚</p>
<p><strong>è¦ç¡®å®šå†…æ ¸ï¼ˆå¯èƒ½è¿˜æœ‰memcpy() ï¼‰ä½•æ—¶å®Œæˆï¼Œè¯·ä½¿ç”¨æ ‡å‡† CUDA åŒæ­¥æœºåˆ¶</strong>ï¼Œä¾‹å¦‚äº‹ä»¶æˆ–ç­‰å¾…æµã€‚ä¾‹å¦‚ï¼Œå¯¹äº Polygraphyï¼Œä½¿ç”¨ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stream.synchronize()</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœæ‚¨æ›´å–œæ¬¢åŒæ­¥æ¨ç†ï¼Œè¯·ä½¿ç”¨<code>execute_v2</code>æ–¹æ³•è€Œä¸æ˜¯<code>execute_async_v2</code> ã€‚</p>
<h1 id="TensorRTå¦‚ä½•å·¥ä½œ"><a href="#TensorRTå¦‚ä½•å·¥ä½œ" class="headerlink" title="TensorRTå¦‚ä½•å·¥ä½œ"></a>TensorRTå¦‚ä½•å·¥ä½œ</h1><h2 id="Object-Lifetimes"><a href="#Object-Lifetimes" class="headerlink" title="Object Lifetimes"></a>Object Lifetimes</h2><p>TensorRT çš„ API æ˜¯åŸºäºç±»çš„ï¼Œå…¶ä¸­ä¸€äº›ç±»å……å½“å…¶ä»–ç±»çš„å·¥å‚ã€‚<strong>å¯¹äºç”¨æˆ·æ‹¥æœ‰çš„å¯¹è±¡ï¼Œå·¥å‚å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå¿…é¡»è·¨è¶Šå®ƒåˆ›å»ºçš„å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚</strong>ä¾‹å¦‚ï¼Œ <code>NetworkDefinition</code>å’Œ<code>BuilderConfig</code>ç±»æ˜¯ä»æ„å»ºå™¨ç±»åˆ›å»ºçš„ï¼Œè¿™äº›ç±»çš„å¯¹è±¡åº”è¯¥åœ¨æ„å»ºå™¨å·¥å‚å¯¹è±¡ä¹‹å‰é”€æ¯ã€‚</p>
<p>æ­¤è§„åˆ™çš„ä¸€ä¸ªé‡è¦ä¾‹å¤–æ˜¯ä»æ„å»ºå™¨åˆ›å»ºå¼•æ“ã€‚åˆ›å»ºå¼•æ“åï¼Œæ‚¨å¯ä»¥é”€æ¯æ„å»ºå™¨ã€ç½‘ç»œã€è§£æå™¨å’Œæ„å»ºé…ç½®å¹¶ç»§ç»­ä½¿ç”¨å¼•æ“ã€‚ï¼ˆ<strong>æ„å»ºå™¨å¯ä»¥æå‰åˆ é™¤ï¼Œå› ä¸ºå¼•æ“ä¸­åŒ…å«äº†ç½‘ç»œçš„å®šä¹‰å’Œæƒé‡ç­‰</strong>ï¼‰</p>
<h2 id="Error-Handling-and-Logging"><a href="#Error-Handling-and-Logging" class="headerlink" title="Error Handling and Logging"></a>Error Handling and Logging</h2><p><strong>åˆ›å»º TensorRT é¡¶çº§æ¥å£ï¼ˆ<code>builder</code>ã€<code>runtime</code> æˆ– <code>refitter</code>ï¼‰æ—¶ï¼Œæ‚¨å¿…é¡»æä¾›<code>Logger</code> æ¥å£çš„å®ç°ã€‚</strong>è®°å½•å™¨ç”¨äºè¯Šæ–­å’Œä¿¡æ¯æ€§æ¶ˆæ¯ï¼›å®ƒçš„è¯¦ç»†ç¨‹åº¦æ˜¯å¯é…ç½®çš„ã€‚ç”±äºè®°å½•å™¨å¯ç”¨äºåœ¨ TensorRT ç”Ÿå‘½å‘¨æœŸçš„ä»»ä½•æ—¶é—´ç‚¹ä¼ å›ä¿¡æ¯ï¼Œå› æ­¤å®ƒçš„ç”Ÿå‘½å‘¨æœŸå¿…é¡»è·¨è¶Šåº”ç”¨ç¨‹åºä¸­å¯¹è¯¥æ¥å£çš„ä»»ä½•ä½¿ç”¨ã€‚å®ç°ä¹Ÿå¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸º TensorRT å¯ä»¥åœ¨å†…éƒ¨ä½¿ç”¨å·¥ä½œçº¿ç¨‹ã€‚</p>
<p><strong>å¯¹å¯¹è±¡çš„ API è°ƒç”¨å°†ä½¿ç”¨ä¸ç›¸åº”é¡¶çº§æ¥å£å…³è”çš„è®°å½•å™¨ã€‚</strong>ä¾‹å¦‚ï¼Œåœ¨å¯¹<code>ExecutionContext::enqueue()</code>çš„è°ƒç”¨ä¸­ï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡æ˜¯ä»å¼•æ“åˆ›å»ºçš„ï¼Œå› æ­¤ TensorRT å°†ä½¿ç”¨ä¸å¼•æ“è¿è¡Œæ—¶å…³è”çš„è®°å½•å™¨ã€‚<code>ï¼ˆå…³è”è®°å½•å™¨ï¼‰</code></p>
<p>é”™è¯¯å¤„ç†çš„ä¸»è¦æ–¹æ³•æ˜¯<code>ErrorRecorde</code> æ¥å£ã€‚<strong>æ‚¨å¯ä»¥å®ç°æ­¤æ¥å£ï¼Œå¹¶å°†å…¶é™„åŠ åˆ° API å¯¹è±¡ä»¥æ¥æ”¶ä¸è¯¥å¯¹è±¡å…³è”çš„é”™è¯¯ã€‚å¯¹è±¡çš„è®°å½•å™¨ä¹Ÿå°†ä¼ é€’ç»™å®ƒåˆ›å»ºçš„ä»»ä½•å…¶ä»–è®°å½•å™¨</strong> â€“ ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å°†é”™è¯¯è®°å½•å™¨é™„åŠ åˆ°å¼•æ“ï¼Œå¹¶ä»è¯¥å¼•æ“åˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå®ƒå°†ä½¿ç”¨ç›¸åŒçš„è®°å½•å™¨ã€‚å¦‚æœæ‚¨éšåå°†æ–°çš„é”™è¯¯è®°å½•å™¨é™„åŠ åˆ°æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå®ƒå°†ä»…æ¥æ”¶æ¥è‡ªè¯¥ä¸Šä¸‹æ–‡çš„é”™è¯¯ã€‚å¦‚æœç”Ÿæˆé”™è¯¯ä½†æ²¡æœ‰æ‰¾åˆ°é”™è¯¯è®°å½•å™¨ï¼Œå®ƒå°†é€šè¿‡å…³è”çš„è®°å½•å™¨å‘å‡ºã€‚<code>ï¼ˆé”™è¯¯è®°å½•å™¨ï¼‰</code></p>
<p><strong>è¯·æ³¨æ„ï¼ŒCUDA é”™è¯¯é€šå¸¸æ˜¯å¼‚æ­¥çš„ â€“ å› æ­¤ï¼Œå½“æ‰§è¡Œå¤šä¸ªæ¨ç†æˆ–å…¶ä»– CUDA æµåœ¨å•ä¸ª CUDA ä¸Šä¸‹æ–‡ä¸­å¼‚æ­¥å·¥ä½œæ—¶ï¼Œå¯èƒ½ä¼šåœ¨ä¸ç”Ÿæˆå®ƒçš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¸åŒçš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­è§‚å¯Ÿåˆ°å¼‚æ­¥ GPU é”™è¯¯ã€‚</strong></p>
<h2 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h2><p>TensorRT ä½¿ç”¨å¤§é‡è®¾å¤‡å†…å­˜ï¼Œå³ GPU å¯ç›´æ¥è®¿é—®çš„å†…å­˜ï¼Œè€Œä¸æ˜¯è¿æ¥åˆ° CPU çš„ä¸»æœºå†…å­˜ã€‚ç”±äºè®¾å¤‡å†…å­˜é€šå¸¸æ˜¯ä¸€ç§å—é™èµ„æºï¼Œå› æ­¤äº†è§£ TensorRT å¦‚ä½•ä½¿ç”¨å®ƒå¾ˆé‡è¦ã€‚</p>
<h3 id="The-Build-Phase-2"><a href="#The-Build-Phase-2" class="headerlink" title="The Build Phase"></a>The Build Phase</h3><p><strong>åœ¨æ„å»ºæœŸé—´ï¼ŒTensorRT ä¸ºæ—¶åºå±‚å®ç°åˆ†é…è®¾å¤‡å†…å­˜</strong>ã€‚ä¸€äº›å®ç°å¯èƒ½ä¼šæ¶ˆè€—å¤§é‡ä¸´æ—¶å†…å­˜ï¼Œå°¤å…¶æ˜¯åœ¨ä½¿ç”¨å¤§å¼ é‡çš„æƒ…å†µä¸‹ã€‚æ‚¨å¯ä»¥é€šè¿‡æ„å»ºå™¨çš„<code>maxWorkspace</code>å±æ€§æ§åˆ¶æœ€å¤§ä¸´æ—¶å†…å­˜é‡ã€‚è¿™é»˜è®¤ä¸ºè®¾å¤‡å…¨å±€å†…å­˜çš„å®Œæ•´å¤§å°ï¼Œä½†å¯ä»¥åœ¨å¿…è¦æ—¶è¿›è¡Œé™åˆ¶ã€‚å¦‚æœæ„å»ºå™¨å‘ç°ç”±äºå·¥ä½œç©ºé—´ä¸è¶³è€Œæ— æ³•è¿è¡Œçš„é€‚ç”¨å†…æ ¸ï¼Œå®ƒå°†å‘å‡ºä¸€æ¡æ—¥å¿—æ¶ˆæ¯æ¥æŒ‡ç¤ºè¿™ä¸€ç‚¹ã€‚</p>
<p><strong>ç„¶è€Œï¼Œå³ä½¿å·¥ä½œç©ºé—´ç›¸å¯¹è¾ƒå°ï¼Œä¹Ÿéœ€è¦ä¸ºè¾“å…¥ã€è¾“å‡ºå’Œæƒé‡åˆ›å»ºç¼“å†²åŒºã€‚</strong> TensorRT å¯¹æ“ä½œç³»ç»Ÿå› æ­¤ç±»åˆ†é…è€Œè¿”å›å†…å­˜ä¸è¶³æ˜¯ç¨³å¥çš„ï¼Œä½†åœ¨æŸäº›å¹³å°ä¸Šï¼Œæ“ä½œç³»ç»Ÿå¯èƒ½ä¼šæˆåŠŸæä¾›å†…å­˜ï¼Œéšåå†…å­˜ä¸è¶³killerè¿›ç¨‹è§‚å¯Ÿåˆ°ç³»ç»Ÿå†…å­˜ä¸è¶³ï¼Œå¹¶ç»ˆæ­¢ TensorRT .å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œè¯·åœ¨é‡è¯•ä¹‹å‰å°½å¯èƒ½å¤šåœ°é‡Šæ”¾ç³»ç»Ÿå†…å­˜ã€‚</p>
<p>åœ¨æ„å»ºé˜¶æ®µï¼Œé€šå¸¸åœ¨ä¸»æœºå†…å­˜ä¸­è‡³å°‘æœ‰ä¸¤ä¸ªæƒé‡æ‹·è´ï¼š<strong>æ¥è‡ªåŸå§‹ç½‘ç»œçš„æƒé‡æ‹·è´ï¼Œä»¥åŠåœ¨æ„å»ºå¼•æ“æ—¶ä½œä¸ºå¼•æ“ä¸€éƒ¨åˆ†åŒ…å«çš„æƒé‡æ‹·è´ã€‚</strong>æ­¤å¤–ï¼Œå½“ TensorRT ç»„åˆæƒé‡ï¼ˆä¾‹å¦‚å·ç§¯ä¸æ‰¹é‡å½’ä¸€åŒ–ï¼‰æ—¶ï¼Œå°†åˆ›å»º<strong>é¢å¤–çš„ä¸´æ—¶æƒé‡å¼ é‡ã€‚</strong></p>
<h3 id="The-Runtime-Phase-1"><a href="#The-Runtime-Phase-1" class="headerlink" title="The Runtime Phase"></a>The Runtime Phase</h3><p>åœ¨è¿è¡Œæ—¶ï¼ŒTensorRT ä½¿ç”¨ç›¸å¯¹è¾ƒå°‘çš„ä¸»æœºå†…å­˜ï¼Œä½†å¯ä»¥ä½¿ç”¨å¤§é‡çš„è®¾å¤‡å†…å­˜ã€‚</p>
<p><strong>å¼•æ“åœ¨ååºåˆ—åŒ–æ—¶åˆ†é…è®¾å¤‡å†…å­˜æ¥å­˜å‚¨æ¨¡å‹æƒé‡</strong>ã€‚ç”±äºåºåˆ—åŒ–å¼•æ“å‡ ä¹éƒ½æ˜¯æƒé‡ï¼Œå› æ­¤å®ƒçš„å¤§å°éå¸¸æ¥è¿‘æƒé‡æ‰€éœ€çš„è®¾å¤‡å†…å­˜é‡ã€‚</p>
<p><code>ExecutionContext</code>ä½¿ç”¨ä¸¤ç§è®¾å¤‡å†…å­˜ï¼š</p>
<ul>
<li>ä¸€äº›å±‚å®ç°æ‰€éœ€çš„<strong>æŒä¹…å†…å­˜</strong>â€”â€”ä¾‹å¦‚ï¼Œä¸€äº›å·ç§¯å®ç°ä½¿ç”¨è¾¹ç¼˜æ©ç ï¼Œå¹¶ä¸”è¿™ç§çŠ¶æ€ä¸èƒ½åƒæƒé‡é‚£æ ·åœ¨ä¸Šä¸‹æ–‡ä¹‹é—´å…±äº«ï¼Œå› ä¸ºå®ƒçš„å¤§å°å–å†³äºå±‚è¾“å…¥å½¢çŠ¶ï¼Œè¿™å¯èƒ½å› ä¸Šä¸‹æ–‡è€Œå¼‚ã€‚è¯¥å†…å­˜åœ¨åˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡æ—¶åˆ†é…ï¼Œå¹¶åœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…æŒç»­ã€‚</li>
<li><strong>æš‚å­˜å†…å­˜</strong>ï¼Œç”¨äºåœ¨å¤„ç†ç½‘ç»œæ—¶ä¿å­˜ä¸­é—´ç»“æœã€‚è¯¥å†…å­˜ç”¨äºä¸­é—´æ¿€æ´»å¼ é‡ã€‚å®ƒè¿˜ç”¨äºå±‚å®ç°æ‰€éœ€çš„ä¸´æ—¶å­˜å‚¨ï¼Œå…¶è¾¹ç•Œç”±<code>IBuilderConfig::setMaxWorkspaceSize()</code>æ§åˆ¶ã€‚</li>
</ul>
<p>æ‚¨å¯ä»¥é€‰æ‹©é€šè¿‡<code>ICudaEngine::createExecutionContextWithoutDeviceMemory()</code><strong>åˆ›å»ºä¸€ä¸ªæ²¡æœ‰æš‚å­˜å†…å­˜çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå¹¶åœ¨ç½‘ç»œæ‰§è¡ŒæœŸé—´è‡ªè¡Œæä¾›è¯¥å†…å­˜ã€‚</strong> <strong>è¿™å…è®¸æ‚¨åœ¨æœªåŒæ—¶è¿è¡Œçš„å¤šä¸ªä¸Šä¸‹æ–‡ä¹‹é—´å…±äº«å®ƒï¼Œæˆ–è€…åœ¨æ¨ç†æœªè¿è¡Œæ—¶ç”¨äºå…¶ä»–ç”¨é€”ã€‚</strong> <code>ICudaEngine::getDeviceMemorySize()</code>è¿”å›æ‰€éœ€çš„æš‚å­˜å†…å­˜é‡ã€‚</p>
<p>æ„å»ºå™¨åœ¨æ„å»ºç½‘ç»œæ—¶å‘å‡ºæœ‰å…³æ‰§è¡Œä¸Šä¸‹æ–‡ä½¿ç”¨çš„æŒä¹…å†…å­˜å’Œæš‚å­˜å†…å­˜é‡çš„ä¿¡æ¯ï¼Œä¸¥é‡æ€§ä¸º <code>kINFO</code> ã€‚æ£€æŸ¥æ—¥å¿—ï¼Œæ¶ˆæ¯ç±»ä¼¼äºä»¥ä¸‹å†…å®¹ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[08/12/2021-17:39:11] [I] [TRT] Total Host Persistent Memory: 106528</span><br><span class="line">[08/12/2021-17:39:11] [I] [TRT] Total Device Persistent Memory: 29785600</span><br><span class="line">[08/12/2021-17:39:11] [I] [TRT] Total Scratch Memory: 9970688</span><br></pre></td></tr></table></figure></div>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒTensorRT ç›´æ¥ä» CUDA åˆ†é…è®¾å¤‡å†…å­˜ã€‚ä½†æ˜¯ï¼Œ<strong>æ‚¨å¯ä»¥å°† TensorRT çš„<code>IGpuAllocator</code>æ¥å£çš„å®ç°é™„åŠ åˆ°æ„å»ºå™¨æˆ–è¿è¡Œæ—¶ï¼Œå¹¶è‡ªè¡Œç®¡ç†è®¾å¤‡å†…å­˜ã€‚</strong>å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºå¸Œæœ›æ§åˆ¶æ‰€æœ‰ GPU å†…å­˜å¹¶å­åˆ†é…ç»™ TensorRTï¼Œè€Œä¸æ˜¯è®© TensorRT ç›´æ¥ä» CUDA åˆ†é…ï¼Œè¿™å°†éå¸¸æœ‰ç”¨ã€‚</p>
<p>TensorRT çš„ä¾èµ–é¡¹ï¼ˆ <a class="link"   target="_blank" rel="noopener" href="https://developer.nvidia.com/cudnn" >cuDNN <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>å’Œ<a class="link"   target="_blank" rel="noopener" href="https://developer.nvidia.com/cublas" >cuBLAS <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> ï¼‰ä¼šå ç”¨å¤§é‡è®¾å¤‡å†…å­˜ã€‚ <strong>TensorRT å…è®¸æ‚¨é€šè¿‡æ„å»ºå™¨é…ç½®ä¸­çš„<code>TacticSources</code>å±æ€§æ§åˆ¶è¿™äº›åº“æ˜¯å¦ç”¨äºæ¨ç†ã€‚</strong>è¯·æ³¨æ„ï¼ŒæŸäº›å±‚å®ç°éœ€è¦è¿™äº›åº“ï¼Œå› æ­¤å½“å®ƒä»¬è¢«æ’é™¤æ—¶ï¼Œç½‘ç»œå¯èƒ½æ— æ³•ç¼–è¯‘ã€‚</p>
<p>CUDA åŸºç¡€è®¾æ–½å’Œ TensorRT çš„è®¾å¤‡ä»£ç ä¹Ÿä¼šæ¶ˆè€—è®¾å¤‡å†…å­˜ã€‚å†…å­˜é‡å› å¹³å°ã€è®¾å¤‡å’Œ TensorRT ç‰ˆæœ¬è€Œå¼‚ã€‚æ‚¨å¯ä»¥ä½¿ç”¨<code>cudaGetMemInfo</code>æ¥ç¡®å®šæ­£åœ¨ä½¿ç”¨çš„è®¾å¤‡å†…å­˜æ€»é‡ã€‚</p>
<h2 id="Threading"><a href="#Threading" class="headerlink" title="Threading"></a>Threading</h2><p>ä¸€èˆ¬æ¥è¯´ï¼ŒTensorRT å¯¹è±¡ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚é¢„æœŸçš„è¿è¡Œæ—¶å¹¶å‘æ¨¡å‹æ˜¯ä¸åŒçš„çº¿ç¨‹å°†åœ¨ä¸åŒçš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¸Šæ“ä½œã€‚<strong>ä¸Šä¸‹æ–‡åŒ…å«æ‰§è¡ŒæœŸé—´çš„ç½‘ç»œçŠ¶æ€ï¼ˆæ¿€æ´»å€¼ç­‰ï¼‰ï¼Œå› æ­¤åœ¨ä¸åŒçº¿ç¨‹ä¸­åŒæ—¶ä½¿ç”¨ä¸Šä¸‹æ–‡ä¼šå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸º</strong>ã€‚ ä¸ºäº†æ”¯æŒè¿™ä¸ªæ¨¡å‹ï¼Œä»¥ä¸‹æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼š</p>
<ul>
<li>è¿è¡Œæ—¶æˆ–å¼•æ“ä¸Šçš„éä¿®æ”¹æ“ä½œã€‚</li>
<li>ä» TensorRT è¿è¡Œæ—¶ååºåˆ—åŒ–å¼•æ“ã€‚</li>
<li>ä»å¼•æ“åˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡ã€‚</li>
<li>æ³¨å†Œå’Œæ³¨é”€æ’ä»¶ã€‚</li>
</ul>
<p><strong>åœ¨ä¸åŒçº¿ç¨‹ä¸­ä½¿ç”¨å¤šä¸ªæ„å»ºå™¨æ²¡æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼›</strong>ä½†æ˜¯ï¼Œæ„å»ºå™¨ä½¿ç”¨æ—¶åºæ¥ç¡®å®šæ‰€æä¾›å‚æ•°çš„æœ€å¿«å†…æ ¸ï¼Œå¹¶ä¸”ä½¿ç”¨å…·æœ‰ç›¸åŒ GPU çš„å¤šä¸ªæ„å»ºå™¨å°†æ‰°ä¹±æ—¶åºå’Œ TensorRT æ„å»ºæœ€ä½³å¼•æ“çš„èƒ½åŠ›ã€‚ä½¿ç”¨å¤šçº¿ç¨‹ä½¿ç”¨ä¸åŒçš„ GPU æ„å»ºä¸å­˜åœ¨æ­¤ç±»é—®é¢˜ã€‚</p>
<h2 id="Determinism"><a href="#Determinism" class="headerlink" title="Determinism"></a>Determinism</h2><p>TensorRT <code>builder</code> ä½¿ç”¨æ—¶é—´æ¥æ‰¾åˆ°æœ€å¿«çš„å†…æ ¸æ¥å®ç°ç»™å®šçš„è¿ç®—ç¬¦ã€‚æ—¶åºå†…æ ¸ä¼šå—åˆ°å™ªå£°çš„å½±å“â€”â€”GPU ä¸Šè¿è¡Œçš„å…¶ä»–å·¥ä½œã€GPU æ—¶é’Ÿé€Ÿåº¦çš„æ³¢åŠ¨ç­‰<strong>ã€‚æ—¶åºå™ªå£°æ„å‘³ç€åœ¨æ„å»ºå™¨çš„è¿ç»­è¿è¡Œä¸­ï¼Œå¯èƒ½ä¸ä¼šé€‰æ‹©ç›¸åŒçš„å®ç°</strong>ã€‚</p>
<p><strong><code>AlgorithmSelector</code>æ¥å£å…è®¸æ‚¨å¼ºåˆ¶æ„å»ºå™¨ä¸ºç»™å®šå±‚é€‰æ‹©ç‰¹å®šå®ç°</strong>ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥ç¡®ä¿æ„å»ºå™¨ä»è¿è¡Œåˆ°è¿è¡Œé€‰æ‹©ç›¸åŒçš„å†…æ ¸ã€‚</p>
<p>ä¸€æ—¦æ„å»ºäº†å¼•æ“ï¼Œå®ƒå°±æ˜¯ç¡®å®šæ€§çš„ï¼šåœ¨ç›¸åŒçš„è¿è¡Œæ—¶ç¯å¢ƒä¸­æä¾›ç›¸åŒçš„è¾“å…¥å°†äº§ç”Ÿç›¸åŒçš„è¾“å‡ºã€‚</p>
<h1 id="TensorRT-è¿›é˜¶ç”¨æ³•"><a href="#TensorRT-è¿›é˜¶ç”¨æ³•" class="headerlink" title="TensorRT è¿›é˜¶ç”¨æ³•"></a>TensorRT è¿›é˜¶ç”¨æ³•</h1><h2 id="The-Timing-Cache"><a href="#The-Timing-Cache" class="headerlink" title="The Timing Cache"></a>The Timing Cache</h2><p><strong>ä¸ºäº†å‡å°‘æ„å»ºå™¨æ—¶é—´ï¼ŒTensorRT åˆ›å»ºäº†ä¸€ä¸ªå±‚æ—¶åºç¼“å­˜ï¼Œä»¥åœ¨æ„å»ºå™¨é˜¶æ®µä¿å­˜å±‚åˆ†æä¿¡æ¯ã€‚</strong>å®ƒåŒ…å«çš„ä¿¡æ¯ç‰¹å®šäºç›®æ ‡æ„å»ºå™¨è®¾å¤‡ã€CUDA å’Œ TensorRT ç‰ˆæœ¬ï¼Œä»¥åŠå¯ä»¥æ›´æ”¹å±‚å®ç°çš„ <code>BuilderConfig</code> å‚æ•°ï¼Œä¾‹å¦‚<code>BuilderFlag::kTF32æˆ–BuilderFlag::kREFIT</code> ã€‚</p>
<p><strong>å¦‚æœæœ‰å…¶ä»–å±‚å…·æœ‰ç›¸åŒçš„è¾“å…¥&#x2F;è¾“å‡ºå¼ é‡é…ç½®å’Œå±‚å‚æ•°ï¼Œåˆ™ TensorRT æ„å»ºå™¨ä¼šè·³è¿‡åˆ†æå¹¶é‡ç”¨é‡å¤å±‚çš„ç¼“å­˜ç»“æœã€‚å¦‚æœç¼“å­˜ä¸­çš„è®¡æ—¶æŸ¥è¯¢æœªå‘½ä¸­ï¼Œåˆ™æ„å»ºå™¨ä¼šå¯¹è¯¥å±‚è®¡æ—¶å¹¶æ›´æ–°ç¼“å­˜ã€‚</strong></p>
<p>æ—¶åºç¼“å­˜å¯ä»¥è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚æ‚¨å¯ä»¥é€šè¿‡<code>IBuilderConfig::createTimingCache</code>ä»ç¼“å†²åŒºåŠ è½½åºåˆ—åŒ–ç¼“å­˜ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ITimingCache* cache = </span><br><span class="line"> config-&gt;createTimingCache(cacheFile.data(), cacheFile.size());</span><br></pre></td></tr></table></figure></div>

<p>å°†ç¼“å†²åŒºå¤§å°è®¾ç½®ä¸º0ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºæ—¶åºç¼“å­˜ã€‚</p>
<p><strong>ç„¶åï¼Œåœ¨æ„å»ºä¹‹å‰å°†ç¼“å­˜é™„åŠ åˆ°æ„å»ºå™¨é…ç½®ã€‚</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config-&gt;setTimingCache(*cache, false);</span><br></pre></td></tr></table></figure></div>

<p>åœ¨æ„å»ºæœŸé—´ï¼Œç”±äºç¼“å­˜æœªå‘½ä¸­ï¼Œæ—¶åºç¼“å­˜å¯ä»¥å¢åŠ æ›´å¤šä¿¡æ¯ã€‚åœ¨æ„å»ºä¹‹åï¼Œå®ƒå¯ä»¥è¢«åºåˆ—åŒ–ä»¥ä¸å¦ä¸€ä¸ªæ„å»ºå™¨ä¸€èµ·ä½¿ç”¨ã€‚</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IHostMemory* serializedCache = cache-&gt;serialize();</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœæ„å»ºå™¨æ²¡æœ‰é™„åŠ æ—¶é—´ç¼“å­˜ï¼Œæ„å»ºå™¨ä¼šåˆ›å»ºè‡ªå·±çš„ä¸´æ—¶æœ¬åœ°ç¼“å­˜å¹¶åœ¨å®Œæˆæ—¶å°†å…¶é”€æ¯ã€‚</p>
<h2 id="Refitting-An-Engine"><a href="#Refitting-An-Engine" class="headerlink" title="Refitting An Engine"></a>Refitting An Engine</h2><p><strong>TensorRT å¯ä»¥ç”¨æ–°çš„æƒé‡æ”¹è£…å¼•æ“è€Œæ— éœ€é‡å»ºå®ƒ</strong>ï¼Œä½†æ˜¯ï¼Œåœ¨æ„å»ºæ—¶å¿…é¡»æŒ‡å®šè¿™æ ·åšçš„é€‰é¡¹ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">config-&gt;setFlag(BuilderFlag::kREFIT) </span><br><span class="line">builder-&gt;buildSerializedNetwork(network, config);</span><br></pre></td></tr></table></figure></div>

<p><strong>ç¨åï¼Œæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ª<code>Refitter</code>å¯¹è±¡ï¼š</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ICudaEngine* engine = ...;</span><br><span class="line">IRefitter* refitter = createInferRefitter(*engine,gLogger)</span><br></pre></td></tr></table></figure></div>

<p><strong>ç„¶åæ›´æ–°æƒé‡ã€‚</strong>ä¾‹å¦‚ï¼Œè¦æ›´æ–°åä¸ºâ€œ<code>MyLayer</code>â€çš„å·ç§¯å±‚çš„å†…æ ¸æƒé‡ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Weights newWeights = ...;</span><br><span class="line">refitter-&gt;setWeights(<span class="string">&quot;MyLayer&quot;</span>,WeightsRole::kKERNEL,</span><br><span class="line">                    newWeights);</span><br></pre></td></tr></table></figure></div>

<p><strong>æ–°çš„æƒé‡åº”è¯¥ä¸ç”¨äºæ„å»ºå¼•æ“çš„åŸå§‹æƒé‡å…·æœ‰ç›¸åŒçš„è®¡æ•°</strong>ã€‚å¦‚æœå‡ºç°é—®é¢˜ï¼Œä¾‹å¦‚é”™è¯¯çš„å±‚åç§°æˆ–è§’è‰²æˆ–æƒé‡è®¡æ•°å‘ç”Ÿå˜åŒ–ï¼Œ <code>setWeights</code>è¿”å› <code>false</code>ã€‚</p>
<p><strong>ç”±äºå¼•æ“ä¼˜åŒ–çš„æ–¹å¼ï¼Œå¦‚æœæ‚¨æ›´æ”¹ä¸€äº›æƒé‡ï¼Œæ‚¨å¯èƒ½è¿˜å¿…é¡»æä¾›ä¸€äº›å…¶ä»–æƒé‡ã€‚</strong>è¯¥ç•Œé¢å¯ä»¥å‘Šè¯‰æ‚¨éœ€è¦æä¾›å“ªäº›é¢å¤–çš„æƒé‡ã€‚</p>
<p><strong>æ‚¨å¯ä»¥ä½¿ç”¨<code>INetworkDefinition::setWeightsName()</code>åœ¨æ„å»ºæ—¶å‘½åæƒé‡ â€“ ONNX è§£æå™¨ä½¿ç”¨æ­¤ API å°†æƒé‡ä¸ ONNX æ¨¡å‹ä¸­ä½¿ç”¨çš„åç§°ç›¸å…³è”</strong>ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>setNamedWeights</code>æ›´æ–°æƒé‡ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Weights newWeights = ...;</span><br><span class="line">refitter-&gt;setNamedWeights(<span class="string">&quot;MyWeights&quot;</span>, newWeights);</span><br></pre></td></tr></table></figure></div>

<p><code>setNamedWeights</code>å’Œ<code>setWeights</code>å¯ä»¥åŒæ—¶ä½¿ç”¨ï¼Œå³ï¼Œæ‚¨å¯ä»¥é€šè¿‡<code>setNamedWeights</code>æ›´æ–°å…·æœ‰åç§°çš„æƒé‡ï¼Œå¹¶é€šè¿‡<code>setWeights</code>æ›´æ–°é‚£äº›æœªå‘½åçš„æƒé‡ã€‚</p>
<p><strong>è¿™é€šå¸¸éœ€è¦ä¸¤æ¬¡è°ƒç”¨<code>IRefitter::getMissing</code></strong> ï¼Œé¦–å…ˆè·å–å¿…é¡»æä¾›çš„æƒé‡å¯¹è±¡çš„æ•°é‡ï¼Œç„¶åè·å–å®ƒä»¬çš„å±‚å’Œè§’è‰²ã€‚</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const int32_t n = refitter-&gt;getMissing(<span class="number">0</span>, nullptr, nullptr);</span><br><span class="line">std::vector&lt;const char*&gt; layerNames(n);</span><br><span class="line">std::vector&lt;WeightsRole&gt; weightsRoles(n);</span><br><span class="line">refitter-&gt;getMissing(n, layerNames.data(), </span><br><span class="line">                        weightsRoles.data());</span><br></pre></td></tr></table></figure></div>

<p>æˆ–è€…ï¼Œè¦è·å–æ‰€æœ‰ç¼ºå¤±æƒé‡çš„åç§°ï¼Œè¯·è¿è¡Œï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const int32_t n = refitter-&gt;getMissingWeights(<span class="number">0</span>, nullptr);</span><br><span class="line">std::vector&lt;const char*&gt; weightsNames(n);</span><br><span class="line">refitter-&gt;getMissingWeights(n, weightsNames.data());</span><br></pre></td></tr></table></figure></div>

<p>æ‚¨å¯ä»¥æŒ‰ä»»ä½•é¡ºåºæä¾›ç¼ºå¤±çš„æƒé‡ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (int32_t i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">    refitter-&gt;setWeights(layerNames[i], weightsRoles[i],</span><br><span class="line">                         Weights&#123;...&#125;);</span><br></pre></td></tr></table></figure></div>

<p><strong>è¿”å›çš„ç¼ºå¤±æƒé‡é›†æ˜¯å®Œæ•´çš„ï¼Œä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼Œä»…æä¾›ç¼ºå¤±çš„æƒé‡ä¸ä¼šäº§ç”Ÿå¯¹ä»»ä½•æ›´å¤šæƒé‡çš„éœ€æ±‚ã€‚</strong></p>
<p>æä¾›æ‰€æœ‰æƒé‡åï¼Œæ‚¨å¯ä»¥æ›´æ–°å¼•æ“ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bool</span> success = refitter-&gt;refitCudaEngine();</span><br><span class="line"><span class="keyword">assert</span>(success);</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœ <code>refit</code> è¿”å› <code>false</code>ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ä»¥è·å–è¯Šæ–­ä¿¡æ¯ï¼Œå¯èƒ½æ˜¯å…³äºä»ç„¶ä¸¢å¤±çš„æƒé‡ã€‚ ç„¶åï¼Œæ‚¨å¯ä»¥åˆ é™¤<code>refitter</code>ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete refitter;</span><br></pre></td></tr></table></figure></div>

<p>æ›´æ–°åçš„å¼•æ“çš„è¡Œä¸ºå°±åƒå®ƒæ˜¯ä»ä½¿ç”¨æ–°æƒé‡æ›´æ–°çš„ç½‘ç»œæ„å»ºçš„ä¸€æ ·ã€‚</p>
<p>è¦æŸ¥çœ‹å¼•æ“ä¸­çš„æ‰€æœ‰å¯æ”¹è£…æƒé‡ï¼Œè¯·ä½¿ç”¨<code>refitter-&gt;getAll(...)</code>æˆ–<code>refitter-&gt;getAllWeights(...)</code> ï¼›ç±»ä¼¼äºä¸Šé¢ä½¿ç”¨<code>getMissing</code>å’Œ<code>getMissingWeights</code>çš„æ–¹å¼ã€‚</p>
<h2 id="Algorithm-Selection-and-Reproducible-Builds"><a href="#Algorithm-Selection-and-Reproducible-Builds" class="headerlink" title="Algorithm Selection and Reproducible Builds"></a>Algorithm Selection and Reproducible Builds</h2><p><strong>TensorRT ä¼˜åŒ–å™¨çš„é»˜è®¤è¡Œä¸ºæ˜¯é€‰æ‹©å…¨å±€æœ€å°åŒ–å¼•æ“æ‰§è¡Œæ—¶é—´çš„ç®—æ³•ã€‚</strong>å®ƒé€šè¿‡å®šæ—¶æ¯ä¸ªå®ç°æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œæœ‰æ—¶ï¼Œå½“å®ç°å…·æœ‰ç›¸ä¼¼çš„æ—¶é—´æ—¶ï¼Œ<strong>ç³»ç»Ÿå™ªå£°</strong>å¯èƒ½ä¼šå†³å®šåœ¨æ„å»ºå™¨çš„ä»»ä½•ç‰¹å®šè¿è¡Œä¸­å°†é€‰æ‹©å“ªä¸ªã€‚ä¸åŒçš„å®ç°é€šå¸¸ä¼šä½¿ç”¨ä¸åŒçš„æµ®ç‚¹å€¼ç´¯åŠ é¡ºåºï¼Œä¸¤ç§å®ç°å¯èƒ½ä½¿ç”¨ä¸åŒçš„ç®—æ³•ï¼Œç”šè‡³ä»¥ä¸åŒçš„ç²¾åº¦è¿è¡Œã€‚å› æ­¤ï¼Œæ„å»ºå™¨çš„ä¸åŒè°ƒç”¨é€šå¸¸ä¸ä¼šå¯¼è‡´å¼•æ“è¿”å›ä½ç›¸åŒçš„ç»“æœã€‚</p>
<p>æœ‰æ—¶ï¼Œç¡®å®šæ€§æ„å»ºæˆ–é‡æ–°åˆ›å»ºæ—©æœŸæ„å»ºçš„ç®—æ³•é€‰æ‹©å¾ˆé‡è¦ã€‚<strong>é€šè¿‡æä¾›<code>IAlgorithmSelector</code>æ¥å£çš„å®ç°å¹¶ä½¿ç”¨<code>setAlgorithmSelector</code>å°†å…¶é™„åŠ åˆ°æ„å»ºå™¨é…ç½®</strong>ï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨æŒ‡å¯¼ç®—æ³•é€‰æ‹©ã€‚</p>
<p>æ–¹æ³•<code>IAlgorithmSelector::selectAlgorithms</code>æ¥æ”¶ä¸€ä¸ª<code>AlgorithmContext</code> ï¼Œå…¶ä¸­åŒ…å«æœ‰å…³å±‚ç®—æ³•è¦æ±‚çš„ä¿¡æ¯ï¼Œä»¥åŠä¸€ç»„æ»¡è¶³è¿™äº›è¦æ±‚çš„ç®—æ³•é€‰æ‹©ã€‚<strong>å®ƒè¿”å› TensorRT åº”è¯¥ä¸ºå±‚è€ƒè™‘çš„ç®—æ³•é›†ã€‚</strong></p>
<p>æ„å»ºå™¨å°†ä»è¿™äº›ç®—æ³•ä¸­é€‰æ‹©ä¸€ç§å¯ä»¥æœ€å°åŒ–ç½‘ç»œå…¨å±€è¿è¡Œæ—¶é—´çš„ç®—æ³•ã€‚å¦‚æœæœªè¿”å›ä»»ä½•é€‰é¡¹å¹¶ä¸”**<code>BuilderFlag::kREJECT_EMPTY_ALGORITHMS</code>æœªè®¾ç½®ï¼Œåˆ™ TensorRT å°†å…¶è§£é‡Šä¸ºæ„å‘³ç€ä»»ä½•ç®—æ³•éƒ½å¯ä»¥ç”¨äºè¯¥å±‚**ã€‚è¦è¦†ç›–æ­¤è¡Œä¸ºå¹¶åœ¨è¿”å›ç©ºåˆ—è¡¨æ—¶ç”Ÿæˆé”™è¯¯ï¼Œè¯·è®¾ç½®<code>BuilderFlag::kREJECT_EMPTY_ALGORITHMSS</code>æ ‡å¿—ã€‚</p>
<p>åœ¨ TensorRT å®Œæˆå¯¹ç»™å®šé…ç½®æ–‡ä»¶çš„ç½‘ç»œä¼˜åŒ–åï¼Œå®ƒä¼šè°ƒç”¨<code>reportAlgorithms</code> ï¼Œå®ƒå¯ç”¨äºè®°å½•ä¸ºæ¯ä¸€å±‚åšå‡ºçš„æœ€ç»ˆé€‰æ‹©ã€‚</p>
<p><code>selectAlgorithms</code>è¿”å›ä¸€ä¸ªé€‰é¡¹ã€‚è¦é‡æ’­æ—©æœŸæ„å»ºä¸­çš„é€‰æ‹©ï¼Œè¯·ä½¿ç”¨<code>reportAlgorithms</code>è®°å½•è¯¥æ„å»ºä¸­çš„é€‰æ‹©ï¼Œå¹¶åœ¨<code>selectAlgorithms</code>ä¸­è¿”å›å®ƒä»¬ã€‚</p>
<p><code>sampleAlgorithmSelector</code>æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ç®—æ³•é€‰æ‹©å™¨åœ¨æ„å»ºå™¨ä¸­å®ç°ç¡®å®šæ€§å’Œå¯é‡å¤æ€§ã€‚</p>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>ç®—æ³•é€‰æ‹©ä¸­çš„â€œå±‚â€æ¦‚å¿µä¸<code>INetworkDefinition</code>ä¸­çš„<code>ILayer</code>ä¸åŒã€‚ç”±äºèåˆä¼˜åŒ–<strong>ï¼Œå‰è€…ä¸­çš„â€œå±‚â€å¯ä»¥ç­‰åŒäºå¤šä¸ªç½‘ç»œå±‚çš„é›†åˆã€‚</strong></li>
<li><code>selectAlgorithms</code>ä¸­é€‰æ‹©æœ€å¿«çš„ç®—æ³•å¯èƒ½ä¸ä¼šä¸ºæ•´ä¸ªç½‘ç»œäº§ç”Ÿæœ€ä½³æ€§èƒ½ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šå¢åŠ é‡æ–°æ ¼å¼åŒ–çš„å¼€é”€ã€‚</li>
<li>å¦‚æœ TensorRT å‘ç°è¯¥å±‚æ˜¯ç©ºæ“ä½œï¼Œåˆ™ <code>IAlgorithm</code>çš„æ—¶é—´åœ¨<code>selectAlgorithms</code>ä¸­ä¸º0 ã€‚</li>
<li><code>reportAlgorithms</code>ä¸æä¾›æä¾›ç»™<code>selectAlgorithms</code>çš„<code>IAlgorithm</code>çš„æ—¶é—´å’Œå·¥ä½œç©ºé—´ä¿¡æ¯ã€‚</li>
</ul>
<h2 id="Creating-A-Network-Definition-From-Scratch"><a href="#Creating-A-Network-Definition-From-Scratch" class="headerlink" title="Creating A Network Definition From Scratch"></a>Creating A Network Definition From Scratch</h2><p>é™¤äº†ä½¿ç”¨è§£æå™¨ï¼Œæ‚¨è¿˜å¯ä»¥é€šè¿‡ç½‘ç»œå®šä¹‰ API å°†ç½‘ç»œç›´æ¥å®šä¹‰åˆ° TensorRTã€‚<strong>æ­¤åœºæ™¯å‡è®¾æ¯å±‚æƒé‡å·²åœ¨ä¸»æœºå†…å­˜ä¸­å‡†å¤‡å¥½åœ¨ç½‘ç»œåˆ›å»ºæœŸé—´ä¼ é€’ç»™ TensorRTã€‚</strong></p>
<p>ä»¥ä¸‹ç¤ºä¾‹åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„ç½‘ç»œï¼Œå…¶ä¸­åŒ…å« <code>Input</code>ã€<code>Convolution</code>ã€<code>Pooling</code>ã€ <code>MatrixMultiply</code>ã€<code>Shuffle</code> ã€<code>Activation</code> å’Œ <code>Softmax</code> å±‚ã€‚</p>
<h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><p>æ­¤éƒ¨åˆ†å¯¹åº”çš„ä»£ç å¯ä»¥åœ¨<a class="link"   target="_blank" rel="noopener" href="https://github.com/NVIDIA/TensorRT/tree/main/samples/python/network_api_pytorch_mnist" >network_api_pytorch_mnist <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>ä¸­æ‰¾åˆ°ã€‚</p>
<p><strong>è¿™ä¸ªä¾‹å­ä½¿ç”¨ä¸€ä¸ªå¸®åŠ©ç±»æ¥ä¿å­˜ä¸€äº›å…³äºæ¨¡å‹çš„å…ƒæ•°æ®ï¼š</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ModelData</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    INPUT_NAME = <span class="string">&quot;data&quot;</span></span><br><span class="line">    INPUT_SHAPE = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">28</span>, <span class="number">28</span>)</span><br><span class="line">    OUTPUT_NAME = <span class="string">&quot;prob&quot;</span></span><br><span class="line">    OUTPUT_SIZE = <span class="number">10</span></span><br><span class="line">    DTYPE = trt.float32</span><br></pre></td></tr></table></figure></div>

<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæƒé‡æ˜¯ä» Pytorch MNIST æ¨¡å‹å¯¼å…¥çš„ã€‚</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">weights = mnist_model.get_weights()</span><br></pre></td></tr></table></figure></div>

<p><strong>åˆ›å»ºè®°å½•å™¨ã€æ„å»ºå™¨å’Œç½‘ç»œç±»ã€‚</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TRT_LOGGER = trt.Logger(trt.Logger.ERROR)</span><br><span class="line">builder = trt.Builder(TRT_LOGGER)</span><br><span class="line">EXPLICIT_BATCH = <span class="number">1</span> &lt;&lt; (<span class="built_in">int</span>)(trt.NetworkDefinitionCreationFlag.EXPLICIT_BATCH)</span><br><span class="line">network = builder.create_network(common.EXPLICIT_BATCH)</span><br></pre></td></tr></table></figure></div>

<p><code>kEXPLICIT_BATCH</code>æ ‡å¿—çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…<a class="link"   target="_blank" rel="noopener" href="https://docs.nvidia.com/deeplearning/tensorrt/developer-guide/index.html#explicit-implicit-batch" >æ˜¾å¼ä¸éšå¼æ‰¹å¤„ç† <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>éƒ¨åˆ†ã€‚</p>
<p><strong>æ¥ä¸‹æ¥ï¼Œä¸ºç½‘ç»œåˆ›å»ºè¾“å…¥å¼ é‡ï¼ŒæŒ‡å®šå¼ é‡çš„åç§°ã€æ•°æ®ç±»å‹å’Œå½¢çŠ¶ã€‚</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input_tensor = network.add_input(name=ModelData.INPUT_NAME, dtype=ModelData.DTYPE, shape=ModelData.INPUT_SHAPE)</span><br></pre></td></tr></table></figure></div>

<p>æ·»åŠ ä¸€ä¸ªå·ç§¯å±‚ï¼ŒæŒ‡å®šè¾“å…¥ã€è¾“å‡ºå›¾çš„æ•°é‡ã€å†…æ ¸å½¢çŠ¶ã€æƒé‡ã€åå·®å’Œæ­¥å¹…ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">conv1_w = weights[<span class="string">&#x27;conv1.weight&#x27;</span>].numpy()</span><br><span class="line">    conv1_b = weights[<span class="string">&#x27;conv1.bias&#x27;</span>].numpy()</span><br><span class="line">    conv1 = network.add_convolution(<span class="built_in">input</span>=input_tensor, num_output_maps=<span class="number">20</span>, kernel_shape=(<span class="number">5</span>, <span class="number">5</span>), kernel=conv1_w, bias=conv1_b)</span><br><span class="line">    conv1.stride = (<span class="number">1</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure></div>

<p>æ·»åŠ ä¸€ä¸ªæ± åŒ–å±‚ï¼ŒæŒ‡å®šè¾“å…¥ï¼ˆå‰ä¸€ä¸ªå·ç§¯å±‚çš„è¾“å‡ºï¼‰ã€æ± åŒ–ç±»å‹ã€çª—å£å¤§å°å’Œæ­¥å¹…ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pool1 = network.add_pooling(<span class="built_in">input</span>=conv1.get_output(<span class="number">0</span>), <span class="built_in">type</span>=trt.PoolingType.MAX, window_size=(<span class="number">2</span>, <span class="number">2</span>))</span><br><span class="line">    pool1.stride = (<span class="number">2</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure></div>

<p>æ·»åŠ ä¸‹ä¸€å¯¹å·ç§¯å’Œæ± åŒ–å±‚ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">conv2_w = weights[<span class="string">&#x27;conv2.weight&#x27;</span>].numpy()</span><br><span class="line">conv2_b = weights[<span class="string">&#x27;conv2.bias&#x27;</span>].numpy()</span><br><span class="line">conv2 = network.add_convolution(pool1.get_output(<span class="number">0</span>), <span class="number">50</span>, (<span class="number">5</span>, <span class="number">5</span>), conv2_w, conv2_b)</span><br><span class="line">conv2.stride = (<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">pool2 = network.add_pooling(conv2.get_output(<span class="number">0</span>), trt.PoolingType.MAX, (<span class="number">2</span>, <span class="number">2</span>))</span><br><span class="line">pool2.stride = (<span class="number">2</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure></div>

<p>æ·»åŠ ä¸€ä¸ª Shuffle å±‚æ¥é‡å¡‘è¾“å…¥ï¼Œä¸ºçŸ©é˜µä¹˜æ³•åšå‡†å¤‡ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">batch = <span class="built_in">input</span>.shape[<span class="number">0</span>]</span><br><span class="line">mm_inputs = np.prod(<span class="built_in">input</span>.shape[<span class="number">1</span>:])			<span class="comment">#è®¡ç®—æ‰€æœ‰å…ƒç´ çš„ä¹˜ç§¯</span></span><br><span class="line">input_reshape = net.add_shuffle(<span class="built_in">input</span>)</span><br><span class="line">input_reshape.reshape_dims = trt.Dims2(batch, mm_inputs)</span><br></pre></td></tr></table></figure></div>

<p>ç°åœ¨ï¼Œæ·»åŠ ä¸€ä¸ª <code>MatrixMultiply</code> å±‚ã€‚åœ¨è¿™é‡Œï¼Œæ¨¡å‹å¯¼å‡ºå™¨æä¾›äº†è½¬ç½®æƒé‡ï¼Œå› æ­¤ä¸ºè¿™äº›æƒé‡æŒ‡å®šäº†<code>kTRANSPOSE</code>é€‰é¡¹ã€‚</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filter_const = net.add_constant(trt.Dims2(nbOutputs, k), weights[<span class="string">&quot;fc1.weight&quot;</span>].numpy())</span><br><span class="line">mm = net.add_matrix_multiply(input_reshape.get_output(<span class="number">0</span>), trt.MatrixOperation.NONE, filter_const.get_output(<span class="number">0</span>), trt.MatrixOperation.TRANSPOSE);</span><br></pre></td></tr></table></figure></div>

<p>æ·»åŠ å°†åœ¨æ‰¹æ¬¡ç»´åº¦å¹¿æ’­çš„åå·®æ·»åŠ ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bias_const = net.add_constant(trt.Dims2(<span class="number">1</span>, nbOutputs), weights[<span class="string">&quot;fc1.bias&quot;</span>].numpy())</span><br><span class="line">bias_add = net.add_elementwise(mm.get_output(<span class="number">0</span>), bias_const.get_output(<span class="number">0</span>), trt.ElementWiseOperation.SUM)</span><br></pre></td></tr></table></figure></div>

<p>æ·»åŠ  Relu æ¿€æ´»å±‚ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">relu1 = network.add_activation(<span class="built_in">input</span>=fc1.get_output(<span class="number">0</span>), <span class="built_in">type</span>=trt.ActivationType.RELU)</span><br></pre></td></tr></table></figure></div>

<p>æ·»åŠ æœ€åçš„å…¨è¿æ¥å±‚ï¼Œå¹¶å°†è¯¥å±‚çš„è¾“å‡ºæ ‡è®°ä¸ºæ•´ä¸ªç½‘ç»œçš„è¾“å‡ºï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fc2_w = weights[<span class="string">&#x27;fc2.weight&#x27;</span>].numpy()</span><br><span class="line">fc2_b = weights[<span class="string">&#x27;fc2.bias&#x27;</span>].numpy()</span><br><span class="line">fc2 = network.add_fully_connected(relu1.get_output(<span class="number">0</span>), ModelData.OUTPUT_SIZE, fc2_w, fc2_b)</span><br><span class="line"></span><br><span class="line">fc2.get_output(<span class="number">0</span>).name = ModelData.OUTPUT_NAME</span><br><span class="line">network.mark_output(tensor=fc2.get_output(<span class="number">0</span>))</span><br></pre></td></tr></table></figure></div>

<p>ä»£è¡¨ MNIST æ¨¡å‹çš„ç½‘ç»œç°å·²å®Œå…¨æ„å»ºã€‚</p>
<h2 id="Reduced-Precision"><a href="#Reduced-Precision" class="headerlink" title="Reduced Precision"></a>Reduced Precision</h2><h3 id="Network-level-Control-of-Precision"><a href="#Network-level-Control-of-Precision" class="headerlink" title="Network-level Control of Precision"></a>Network-level Control of Precision</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒTensorRT ä»¥ 32 ä½ç²¾åº¦å·¥ä½œï¼Œä½†ä¹Ÿå¯ä»¥ä½¿ç”¨ 16 ä½æµ®ç‚¹å’Œ 8 ä½é‡åŒ–æµ®ç‚¹æ‰§è¡Œæ“ä½œã€‚<strong>ä½¿ç”¨è¾ƒä½çš„ç²¾åº¦éœ€è¦æ›´å°‘çš„å†…å­˜å¹¶å®ç°æ›´å¿«çš„è®¡ç®—ã€‚</strong></p>
<p>é™ä½ç²¾åº¦æ”¯æŒå–å†³äºæ‚¨çš„ç¡¬ä»¶ã€‚æ‚¨å¯ä»¥æŸ¥è¯¢æ„å»ºå™¨ä»¥æ£€æŸ¥å¹³å°ä¸Šæ”¯æŒçš„ç²¾åº¦æ”¯æŒï¼š<strong>Python</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> builder.platform_has_fp16:</span><br></pre></td></tr></table></figure></div>

<p><strong>åœ¨æ„å»ºå™¨é…ç½®ä¸­è®¾ç½®æ ‡å¿—ä¼šé€šçŸ¥ TensorRT å®ƒå¯èƒ½ä¼šé€‰æ‹©è¾ƒä½ç²¾åº¦çš„å®ç°</strong>ï¼š<strong>Python</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.set_flag(trt.BuilderFlag.FP16)</span><br></pre></td></tr></table></figure></div>

<p>å…±æœ‰ä¸‰ä¸ªç²¾åº¦æ ‡å¿—ï¼š<code>FP16</code>ã€<code>INT8</code> å’Œ <code>TF32</code>ï¼Œå®ƒä»¬å¯ä»¥ç‹¬ç«‹å¯ç”¨ã€‚<strong>è¯·æ³¨æ„ï¼Œå¦‚æœ TensorRT å¯¼è‡´æ•´ä½“è¿è¡Œæ—¶é—´è¾ƒçŸ­ï¼Œæˆ–è€…ä¸å­˜åœ¨ä½ç²¾åº¦å®ç°ï¼ŒTensorRT ä»å°†é€‰æ‹©æ›´é«˜ç²¾åº¦çš„å†…æ ¸ã€‚</strong></p>
<p>å½“ TensorRT ä¸ºå±‚é€‰æ‹©ç²¾åº¦æ—¶ï¼Œå®ƒä¼šæ ¹æ®éœ€è¦è‡ªåŠ¨è½¬æ¢æƒé‡ä»¥è¿è¡Œå±‚ã€‚è™½ç„¶ä½¿ç”¨ <code>FP16</code> å’Œ <code>TF32</code> ç²¾åº¦ç›¸å¯¹ç®€å•ï¼Œä½†ä½¿ç”¨ <code>INT8</code> æ—¶ä¼šæœ‰é¢å¤–çš„å¤æ‚æ€§ã€‚</p>
<h3 id="Layer-level-Control-of-Precision"><a href="#Layer-level-Control-of-Precision" class="headerlink" title="Layer-level Control of Precision"></a>Layer-level Control of Precision</h3><p><strong><code>builder-flags</code> æä¾›äº†å…è®¸çš„ã€ç²—ç²’åº¦çš„æ§åˆ¶ã€‚</strong>ç„¶è€Œï¼Œæœ‰æ—¶ç½‘ç»œçš„ä¸€éƒ¨åˆ†éœ€è¦æ›´é«˜çš„åŠ¨æ€èŒƒå›´æˆ–å¯¹æ•°å€¼ç²¾åº¦æ•æ„Ÿã€‚æ‚¨å¯ä»¥é™åˆ¶æ¯å±‚çš„è¾“å…¥å’Œè¾“å‡ºç±»å‹ï¼š <strong>Python</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">layer.precision = trt.fp16</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ºè¾“å…¥å’Œè¾“å‡ºæä¾›äº†é¦–é€‰ç±»å‹ï¼ˆæ­¤å¤„ä¸ºD<code>ataType::kFP16</code> ï¼‰ã€‚</p>
<p><strong>æ‚¨å¯ä»¥è¿›ä¸€æ­¥è®¾ç½®å›¾å±‚è¾“å‡ºçš„é¦–é€‰ç±»å‹ï¼šPython</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">layer.set_output_type(out_tensor_index, trt.fp16)</span><br></pre></td></tr></table></figure></div>

<p>è®¡ç®—å°†ä½¿ç”¨ä¸è¾“å…¥é¦–é€‰ç›¸åŒçš„æµ®ç‚¹ç±»å‹ã€‚å¤§å¤šæ•° TensorRT å®ç°å…·æœ‰ç›¸åŒçš„è¾“å…¥å’Œè¾“å‡ºæµ®ç‚¹ç±»å‹ï¼›<strong>ä½†æ˜¯ï¼Œ<code>Convolution</code>ã€<code>Deconvolution</code> å’Œ <code>FullyConnected</code> å¯ä»¥æ”¯æŒé‡åŒ–çš„ <code>INT8</code> è¾“å…¥å’Œæœªé‡åŒ–çš„ <code>FP16</code> æˆ– <code>FP32</code> è¾“å‡ºï¼Œå› ä¸ºæœ‰æ—¶éœ€è¦ä½¿ç”¨æ¥è‡ªé‡åŒ–è¾“å…¥çš„æ›´é«˜ç²¾åº¦è¾“å‡ºæ¥ä¿æŒå‡†ç¡®æ€§ã€‚</strong></p>
<p>è®¾ç½®ç²¾åº¦çº¦æŸå‘ TensorRT æç¤ºå®ƒåº”è¯¥é€‰æ‹©ä¸€ä¸ªè¾“å…¥å’Œè¾“å‡ºä¸é¦–é€‰ç±»å‹åŒ¹é…çš„å±‚å®ç°ï¼Œå¦‚æœå‰ä¸€å±‚çš„è¾“å‡ºå’Œä¸‹ä¸€å±‚çš„è¾“å…¥ä¸è¯·æ±‚çš„ç±»å‹ä¸åŒ¹é…ï¼Œåˆ™æ’å…¥<strong>é‡æ–°æ ¼å¼åŒ–æ“ä½œ</strong>ã€‚è¯·æ³¨æ„ï¼Œåªæœ‰é€šè¿‡æ„å»ºå™¨é…ç½®ä¸­çš„æ ‡å¿—å¯ç”¨äº†è¿™äº›ç±»å‹ï¼ŒTensorRT æ‰èƒ½é€‰æ‹©å…·æœ‰è¿™äº›ç±»å‹çš„å®ç°ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒTensorRT åªæœ‰åœ¨äº§ç”Ÿæ›´é«˜æ€§èƒ½çš„ç½‘ç»œæ—¶æ‰ä¼šé‡æ–°æ ¼å¼åŒ–æ“ä½œã€‚å¦‚æœå¦ä¸€ä¸ªå®ç°æ›´å¿«ï¼ŒTensorRT ä¼šä½¿ç”¨å®ƒå¹¶å‘å‡ºè­¦å‘Šã€‚æ‚¨å¯ä»¥é€šè¿‡é¦–é€‰æ„å»ºå™¨é…ç½®ä¸­çš„ç±»å‹çº¦æŸæ¥è¦†ç›–æ­¤è¡Œä¸ºã€‚</p>
<p><strong>Python</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.set_flag(trt.BuilderFlag.PREFER_PRECISION_CONSTRAINTS)</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœçº¦æŸæ˜¯é¦–é€‰çš„ï¼ŒTensorRT ä¼šæœä»å®ƒä»¬ï¼Œé™¤éæ²¡æœ‰å…·æœ‰é¦–é€‰ç²¾åº¦çº¦æŸçš„å®ç°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒä¼šå‘å‡ºè­¦å‘Šå¹¶ä½¿ç”¨æœ€å¿«çš„å¯ç”¨å®ç°ã€‚</p>
<p>è¦å°†è­¦å‘Šæ›´æ”¹ä¸ºé”™è¯¯ï¼Œè¯·ä½¿ç”¨<code>OBEY</code>è€Œä¸æ˜¯<code>PREFER</code> ï¼š<strong>Python</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.set_flag(trt.BuilderFlag.OBEY_PRECISION_CONSTRAINTS);</span><br></pre></td></tr></table></figure></div>

<p><strong>ç²¾åº¦çº¦æŸæ˜¯å¯é€‰çš„</strong> â€“ æ‚¨å¯ä»¥æŸ¥è¯¢ä»¥ç¡®å®šæ˜¯å¦å·²ä½¿ç”¨Python ä¸­çš„<code>layer.precision_is_set</code>è®¾ç½®äº†çº¦æŸã€‚å¦‚æœæ²¡æœ‰è®¾ç½®ç²¾åº¦çº¦æŸï¼Œé‚£ä¹ˆåœ¨ Python ä¸­è¯»å–ç²¾åº¦å±æ€§ï¼Œæ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚è¾“å‡ºç±»å‹çº¦æŸåŒæ ·æ˜¯å¯é€‰çš„ã€‚</p>
<p><code>layer-&gt;getOutput(i)-&gt;setType()</code>å’Œ<code>layer-&gt;setOutputType()</code>ä¹‹é—´å­˜åœ¨åŒºåˆ«â€”â€”<strong>å‰è€…æ˜¯ä¸€ç§å¯é€‰ç±»å‹ï¼Œå®ƒé™åˆ¶äº† TensorRT å°†ä¸ºå±‚é€‰æ‹©çš„å®ç°ã€‚åè€…æ˜¯å¼ºåˆ¶æ€§çš„ï¼ˆé»˜è®¤ä¸º FP32ï¼‰å¹¶æŒ‡å®šç½‘ç»œè¾“å‡ºçš„ç±»å‹ã€‚</strong>å¦‚æœå®ƒä»¬ä¸åŒï¼ŒTensorRT å°†æ’å…¥ä¸€ä¸ªå¼ºåˆ¶è½¬æ¢ä»¥ç¡®ä¿ä¸¤ä¸ªè§„èŒƒéƒ½å¾—åˆ°å°Šé‡ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨ä¸ºäº§ç”Ÿç½‘ç»œè¾“å‡ºçš„å±‚è°ƒç”¨<code>setOutputType()</code> ï¼Œé€šå¸¸è¿˜åº”è¯¥å°†ç›¸åº”çš„ç½‘ç»œè¾“å‡ºé…ç½®ä¸ºå…·æœ‰ç›¸åŒçš„ç±»å‹ã€‚</p>
<h3 id="Enabling-TF32-Inference-Using-C"><a href="#Enabling-TF32-Inference-Using-C" class="headerlink" title="Enabling TF32 Inference Using C++"></a>Enabling TF32 Inference Using C++</h3><p><strong>TensorRT é»˜è®¤å…è®¸ä½¿ç”¨ TF32 Tensor Coresã€‚</strong>åœ¨è®¡ç®—å†…ç§¯æ—¶ï¼Œä¾‹å¦‚åœ¨å·ç§¯æˆ–çŸ©é˜µä¹˜æ³•æœŸé—´ï¼ŒTF32 æ‰§è¡Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ul>
<li>å°† FP32 è¢«ä¹˜æ•°èˆå…¥åˆ° FP16 ç²¾åº¦ï¼Œä½†ä¿æŒ FP32 åŠ¨æ€èŒƒå›´ã€‚</li>
<li>è®¡ç®—å››èˆäº”å…¥çš„è¢«ä¹˜æ•°çš„ç²¾ç¡®ä¹˜ç§¯ã€‚</li>
<li>å°†ä¹˜ç§¯ç´¯åŠ åˆ° FP32 æ€»å’Œä¸­ã€‚</li>
</ul>
<p>TF32 Tensor Cores å¯ä»¥ä½¿ç”¨ FP32 åŠ é€Ÿç½‘ç»œï¼Œé€šå¸¸ä¸ä¼šæŸå¤±å‡†ç¡®æ€§ã€‚å¯¹äºéœ€è¦é«˜åŠ¨æ€èŒƒå›´çš„æƒé‡æˆ–æ¿€æ´»çš„æ¨¡å‹ï¼Œå®ƒæ¯” FP16 æ›´å¼ºå¤§ã€‚</p>
<p>ä¸èƒ½ä¿è¯ TF32 Tensor Cores ä¼šè¢«å®é™…ä½¿ç”¨ï¼Œä¹Ÿæ²¡æœ‰åŠæ³•å¼ºåˆ¶å®ç°ä½¿ç”¨å®ƒä»¬ â€“ TensorRT å¯ä»¥éšæ—¶å›é€€åˆ° FP32ï¼Œå¦‚æœå¹³å°ä¸æ”¯æŒ TF32ï¼Œåˆ™æ€»æ˜¯å›é€€ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ¸…é™¤ TF32 builder æ ‡å¿—æ¥ç¦ç”¨å®ƒä»¬ã€‚</p>
<p><strong>Python</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.clear_flag(trt.BuilderFlag.TF32)</span><br></pre></td></tr></table></figure></div>

<p>å°½ç®¡è®¾ç½®äº† <code>BuilderFlag::kTF32</code> ï¼Œ<strong>ä½†åœ¨æ„å»ºå¼•æ“æ—¶è®¾ç½®ç¯å¢ƒå˜é‡<code>NVIDIA_TF32_OVERRIDE=0</code>ä¼šç¦ç”¨ <code>TF32</code> ã€‚æ­¤ç¯å¢ƒå˜é‡åœ¨è®¾ç½®ä¸º0æ—¶ä¼šè¦†ç›– NVIDIA åº“çš„ä»»ä½•é»˜è®¤å€¼æˆ–ç¼–ç¨‹é…ç½®</strong>ï¼Œå› æ­¤å®ƒä»¬æ°¸è¿œä¸ä¼šä½¿ç”¨ <strong>TF32 Tensor Cores</strong> åŠ é€Ÿ FP32 è®¡ç®—ã€‚è¿™åªæ˜¯ä¸€ä¸ªè°ƒè¯•å·¥å…·ï¼ŒNVIDIA åº“ä¹‹å¤–çš„ä»»ä½•ä»£ç éƒ½ä¸åº”æ›´æ”¹åŸºäºæ­¤ç¯å¢ƒå˜é‡çš„è¡Œä¸ºã€‚é™¤0ä»¥å¤–çš„ä»»ä½•å…¶ä»–è®¾ç½®éƒ½ä¿ç•™ä¾›å°†æ¥ä½¿ç”¨ã€‚</p>
<p>è­¦å‘Šï¼šåœ¨å¼•æ“è¿è¡Œæ—¶å°†ç¯å¢ƒå˜é‡<code>NVIDIA_TF32_OVERRIDE</code>è®¾ç½®ä¸ºä¸åŒçš„å€¼å¯èƒ½ä¼šå¯¼è‡´æ— æ³•é¢„æµ‹çš„ç²¾åº¦&#x2F;æ€§èƒ½å½±å“ã€‚å¼•æ“è¿è½¬æ—¶æœ€å¥½ä¸è¦è®¾ç½®ã€‚é™¤éæ‚¨çš„åº”ç”¨ç¨‹åºéœ€è¦ TF32 æä¾›çš„æ›´é«˜åŠ¨æ€èŒƒå›´ï¼Œå¦åˆ™ <strong><code>FP16</code> å°†æ˜¯æ›´å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºå®ƒå‡ ä¹æ€»èƒ½äº§ç”Ÿæ›´å¿«çš„æ€§èƒ½ã€‚</strong></p>
<h2 id="I-x2F-O-Formats"><a href="#I-x2F-O-Formats" class="headerlink" title="I&#x2F;O Formats"></a>I&#x2F;O Formats</h2><p>TensorRT ä½¿ç”¨è®¸å¤šä¸åŒçš„æ•°æ®æ ¼å¼ä¼˜åŒ–ç½‘ç»œã€‚ä¸ºäº†å…è®¸åœ¨ TensorRT å’Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä¹‹é—´æœ‰æ•ˆä¼ é€’æ•°æ®ï¼Œ<strong>è¿™äº›åº•å±‚æ•°æ®æ ¼å¼åœ¨ç½‘ç»œ I&#x2F;O è¾¹ç•Œå¤„å…¬å¼€ï¼Œå³ç”¨äºæ ‡è®°ä¸ºç½‘ç»œè¾“å…¥æˆ–è¾“å‡ºçš„å¼ é‡ï¼Œä»¥åŠåœ¨å°†æ•°æ®ä¼ å…¥å’Œä¼ å‡ºæ’ä»¶æ—¶</strong>ã€‚å¯¹äºå…¶ä»–å¼ é‡ï¼ŒTensorRT é€‰æ‹©å¯¼è‡´æœ€å¿«æ•´ä½“æ‰§è¡Œçš„æ ¼å¼ï¼Œå¹¶å¯èƒ½æ’å…¥é‡æ–°æ ¼å¼åŒ–ä»¥æé«˜æ€§èƒ½ã€‚</p>
<p>æ‚¨å¯ä»¥é€šè¿‡åˆ†æå¯ç”¨çš„ I&#x2F;O æ ¼å¼ä»¥åŠå¯¹ TensorRT ä¹‹å‰å’Œä¹‹åçš„æ“ä½œæœ€æœ‰æ•ˆçš„æ ¼å¼æ¥ç»„è£…æœ€ä½³æ•°æ®ç®¡é“ã€‚</p>
<p>è¦æŒ‡å®š I&#x2F;O æ ¼å¼ï¼Œè¯·ä»¥ä½æ©ç çš„å½¢å¼æŒ‡å®šä¸€ç§æˆ–å¤šç§æ ¼å¼ã€‚ <strong>ä»¥ä¸‹ç¤ºä¾‹å°†è¾“å…¥å¼ é‡æ ¼å¼è®¾ç½®ä¸º<code>TensorFormat::kHWC8</code> ã€‚è¯·æ³¨æ„ï¼Œæ­¤æ ¼å¼ä»…é€‚ç”¨äº<code>DataType::kHALF</code> ï¼Œå› æ­¤å¿…é¡»ç›¸åº”åœ°è®¾ç½®æ•°æ®ç±»å‹ã€‚</strong></p>
<p><strong>Python</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">formats = <span class="number">1</span> &lt;&lt; <span class="built_in">int</span>(tensorrt.TensorFormat.HWC8)</span><br><span class="line">network.get_input(<span class="number">0</span>).allowed_formats = formats</span><br><span class="line">network.get_input(<span class="number">0</span>).dtype = tensorrt.DataType.HALF</span><br></pre></td></tr></table></figure></div>

<p>é€šè¿‡è®¾ç½®æ„å»ºå™¨é…ç½®æ ‡å¿—<code>DIRECT_IO</code> ï¼Œå¯ä»¥ä½¿ TensorRT é¿å…åœ¨ç½‘ç»œè¾¹ç•Œæ’å…¥é‡æ–°æ ¼å¼åŒ–ã€‚è¿™ä¸ªæ ‡å¿—é€šå¸¸ä¼šé€‚å¾—å…¶åï¼ŒåŸå› æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>å¦‚æœå…è®¸ TensorRT æ’å…¥é‡æ–°æ ¼å¼åŒ–ï¼Œåˆ™ç”Ÿæˆçš„å¼•æ“å¯èƒ½ä¼šæ›´æ…¢ã€‚é‡æ–°æ ¼å¼åŒ–å¯èƒ½å¬èµ·æ¥åƒæ˜¯æµªè´¹å·¥ä½œï¼Œä½†å®ƒå¯ä»¥å…è®¸æœ€æœ‰æ•ˆçš„å†…æ ¸è€¦åˆã€‚</li>
<li>å¦‚æœ TensorRT åœ¨ä¸å¼•å…¥æ­¤ç±»é‡æ–°æ ¼å¼åŒ–çš„æƒ…å†µä¸‹æ— æ³•æ„å»ºå¼•æ“ï¼Œåˆ™æ„å»ºå°†å¤±è´¥ã€‚<strong>æ•…éšœå¯èƒ½ä»…å‘ç”Ÿåœ¨æŸäº›ç›®æ ‡å¹³å°ä¸Šï¼Œ</strong>å› ä¸ºè¿™äº›å¹³å°çš„å†…æ ¸æ”¯æŒå“ªäº›æ ¼å¼ã€‚</li>
</ul>
<p><strong>è¯¥æ ‡å¿—çš„å­˜åœ¨æ˜¯ä¸ºäº†å¸Œæœ›å®Œå…¨æ§åˆ¶é‡æ–°æ ¼å¼åŒ–æ˜¯å¦å‘ç”Ÿåœ¨ I&#x2F;O è¾¹ç•Œçš„ç”¨æˆ·ï¼Œä¾‹å¦‚æ„å»ºä»…åœ¨ DLA ä¸Šè¿è¡Œè€Œä¸å›é€€åˆ° GPU è¿›è¡Œé‡æ–°æ ¼å¼åŒ–çš„å¼•æ“ã€‚</strong></p>
<p>è¯·æ³¨æ„ï¼Œå¯¹äºçŸ¢é‡åŒ–æ ¼å¼ï¼Œé€šé“ç»´åº¦å¿…é¡»è¡¥é›¶åˆ°çŸ¢é‡å¤§å°çš„å€æ•°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè¾“å…¥ç»‘å®šçš„ç»´åº¦ä¸º[16,3,224,224] ã€ <code>kHALF</code>æ•°æ®ç±»å‹å’Œ<code>kHWC8</code>æ ¼å¼ï¼Œåˆ™ç»‘å®šç¼“å†²åŒºçš„å®é™…æ‰€éœ€å¤§å°å°†ä¸º1<code>6* 8 *224*224*sizeof(half)</code>å­—èŠ‚ï¼Œç”šè‡³å°½ç®¡<code>engine-&gt;getBindingDimension()</code> API å°†å¼ é‡ç»´åº¦è¿”å›ä¸º<code>[16,3,224,224]</code> ã€‚å¡«å……éƒ¨åˆ†ä¸­çš„å€¼ï¼ˆå³æœ¬ä¾‹ä¸­çš„C&#x3D;3,4,â€¦,7 ï¼‰å¿…é¡»ç”¨é›¶å¡«å……ã€‚</p>
<h2 id="Compatibility-of-Serialized-Engines"><a href="#Compatibility-of-Serialized-Engines" class="headerlink" title="Compatibility of Serialized Engines"></a>Compatibility of Serialized Engines</h2><p><strong>ä»…å½“ä¸ç”¨äºåºåˆ—åŒ–å¼•æ“çš„ç›¸åŒæ“ä½œç³»ç»Ÿã€CPU æ¶æ„ã€GPU æ¨¡å‹å’Œ TensorRT ç‰ˆæœ¬ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œåºåˆ—åŒ–å¼•æ“æ‰èƒ½ä¿è¯æ­£å¸¸å·¥ä½œ</strong>ã€‚</p>
<p>TensorRT æ£€æŸ¥å¼•æ“çš„ä»¥ä¸‹å±æ€§ï¼Œå¦‚æœå®ƒä»¬ä¸å¼•æ“è¢«åºåˆ—åŒ–çš„ç¯å¢ƒä¸åŒ¹é…ï¼Œå°†æ— æ³•ååºåˆ—åŒ–ï¼š</p>
<ul>
<li>TensorRT çš„ä¸»è¦ã€æ¬¡è¦ã€è¡¥ä¸å’Œæ„å»ºç‰ˆæœ¬</li>
<li>è®¡ç®—èƒ½åŠ›ï¼ˆä¸»è¦å’Œæ¬¡è¦ç‰ˆæœ¬ï¼‰</li>
</ul>
<p>è¿™ç¡®ä¿äº†åœ¨æ„å»ºé˜¶æ®µé€‰æ‹©çš„å†…æ ¸å­˜åœ¨å¹¶ä¸”å¯ä»¥è¿è¡Œã€‚æ­¤å¤–ï¼ŒTensorRT ç”¨äºä» cuDNN å’Œ cuBLAS ä¸­é€‰æ‹©å’Œé…ç½®å†…æ ¸çš„ API ä¸æ”¯æŒè·¨è®¾å¤‡å…¼å®¹æ€§ï¼Œå› æ­¤åœ¨æ„å»ºå™¨é…ç½®ä¸­ç¦ç”¨è¿™äº›ç­–ç•¥æºçš„ä½¿ç”¨ã€‚ TensorRT è¿˜ä¼šæ£€æŸ¥ä»¥ä¸‹å±æ€§ï¼Œå¦‚æœå®ƒä»¬ä¸åŒ¹é…ï¼Œåˆ™ä¼šå‘å‡ºè­¦å‘Šï¼š</p>
<ul>
<li>å…¨å±€å†…å­˜æ€»çº¿å¸¦å®½</li>
<li>äºŒçº§ç¼“å­˜å¤§å°</li>
<li>æ¯ä¸ªå—å’Œæ¯ä¸ªå¤šå¤„ç†å™¨çš„æœ€å¤§å…±äº«å†…å­˜</li>
<li><strong>çº¹ç†å¯¹é½è¦æ±‚</strong></li>
<li>å¤šå¤„ç†å™¨æ•°é‡</li>
<li><strong>GPU è®¾å¤‡æ˜¯é›†æˆçš„è¿˜æ˜¯åˆ†ç«‹çš„</strong></li>
</ul>
<p>å¦‚æœå¼•æ“åºåˆ—åŒ–å’Œè¿è¡Œæ—¶ç³»ç»Ÿä¹‹é—´çš„ GPU æ—¶é’Ÿé€Ÿåº¦ä¸åŒï¼Œåˆ™ä»åºåˆ—åŒ–ç³»ç»Ÿä¸­é€‰æ‹©çš„ç­–ç•¥å¯¹äºè¿è¡Œæ—¶ç³»ç»Ÿå¯èƒ½ä¸æ˜¯æœ€ä½³çš„ï¼Œå¹¶ä¸”å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›æ€§èƒ½ä¸‹é™ã€‚</p>
<p>å¦‚æœååºåˆ—åŒ–è¿‡ç¨‹ä¸­å¯ç”¨çš„è®¾å¤‡å†…å­˜å°äºåºåˆ—åŒ–è¿‡ç¨‹ä¸­çš„æ•°é‡ï¼Œååºåˆ—åŒ–å¯èƒ½ä¼šç”±äºå†…å­˜åˆ†é…å¤±è´¥è€Œå¤±è´¥ã€‚</p>
<p><strong>åœ¨å¤§å‹è®¾å¤‡ä¸Šæ„å»ºå°å‹æ¨¡å‹æ—¶ï¼ŒTensorRT å¯èƒ½ä¼šé€‰æ‹©æ•ˆç‡è¾ƒä½ä½†å¯åœ¨å¯ç”¨èµ„æºä¸Šæ›´å¥½åœ°æ‰©å±•çš„å†…æ ¸ã€‚</strong>å› æ­¤ï¼Œå¦‚æœä¼˜åŒ–å•ä¸ªTensorRT å¼•æ“ä»¥åœ¨åŒä¸€æ¶æ„ä¸­çš„å¤šä¸ªè®¾å¤‡ä¸Šä½¿ç”¨ï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯åœ¨æœ€å°çš„è®¾å¤‡ä¸Šè¿è¡Œæ„å»ºå™¨ã€‚æˆ–è€…ï¼Œæ‚¨å¯ä»¥åœ¨è®¡ç®—èµ„æºæœ‰é™çš„å¤§å‹è®¾å¤‡ä¸Šæ„å»ºå¼•æ“</p>
<h2 id="Explicit-vs-Implicit-Batch"><a href="#Explicit-vs-Implicit-Batch" class="headerlink" title="Explicit vs Implicit Batch"></a>Explicit vs Implicit Batch</h2><p>TensorRT æ”¯æŒä¸¤ç§æŒ‡å®šç½‘ç»œçš„æ¨¡å¼ï¼šæ˜¾å¼æ‰¹å¤„ç†å’Œéšå¼æ‰¹å¤„ç†ã€‚</p>
<p>åœ¨éšå¼æ‰¹å¤„ç†æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªå¼ é‡éƒ½æœ‰ä¸€ä¸ªéšå¼æ‰¹å¤„ç†ç»´åº¦ï¼Œæ‰€æœ‰å…¶ä»–ç»´åº¦å¿…é¡»å…·æœ‰æ’å®šé•¿åº¦ã€‚æ­¤æ¨¡å¼ç”± TensoRT çš„æ—©æœŸç‰ˆæœ¬ä½¿ç”¨ï¼Œç°åœ¨å·²å¼ƒç”¨ï¼Œä½†ç»§ç»­æ”¯æŒä»¥å®ç°å‘åå…¼å®¹æ€§ã€‚ åœ¨æ˜¾å¼æ‰¹å¤„ç†æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰ç»´åº¦éƒ½æ˜¯æ˜¾å¼çš„å¹¶ä¸”å¯ä»¥æ˜¯åŠ¨æ€çš„ï¼Œå³å®ƒä»¬çš„é•¿åº¦å¯ä»¥åœ¨æ‰§è¡Œæ—¶æ”¹å˜ã€‚è®¸å¤šæ–°åŠŸèƒ½ï¼ˆä¾‹å¦‚åŠ¨æ€å½¢çŠ¶å’Œå¾ªç¯ï¼‰ä»…åœ¨æ­¤æ¨¡å¼ä¸‹å¯ç”¨ã€‚ ONNX è§£æå™¨ä¹Ÿéœ€è¦å®ƒã€‚</p>
<p>ä¾‹å¦‚ï¼Œè€ƒè™‘ä¸€ä¸ªå¤„ç† NCHW æ ¼å¼çš„å…·æœ‰ 3 ä¸ªé€šé“çš„å¤§å°ä¸º HxW çš„ N ä¸ªå›¾åƒçš„ç½‘ç»œã€‚åœ¨è¿è¡Œæ—¶ï¼Œè¾“å…¥å¼ é‡çš„ç»´åº¦ä¸º [N,3,H,W]ã€‚è¿™ä¸¤ç§æ¨¡å¼åœ¨<code>INetworkDefinition</code>æŒ‡å®šå¼ é‡ç»´åº¦çš„æ–¹å¼ä¸Šæœ‰æ‰€ä¸åŒï¼š</p>
<ul>
<li>åœ¨æ˜¾å¼æ‰¹å¤„ç†æ¨¡å¼ä¸‹ï¼Œç½‘ç»œæŒ‡å®š [N,3,H,W]ã€‚</li>
<li>åœ¨éšå¼æ‰¹å¤„ç†æ¨¡å¼ä¸‹ï¼Œç½‘ç»œä»…æŒ‡å®š [3,H,W]ã€‚<strong>æ‰¹æ¬¡ç»´åº¦ N æ˜¯éšå¼çš„ã€‚</strong></li>
</ul>
<p>â€œ<strong>è·¨æ‰¹æ¬¡å¯¹è¯</strong>â€çš„æ“ä½œæ— æ³•åœ¨éšå¼æ‰¹æ¬¡æ¨¡å¼ä¸‹è¡¨è¾¾ï¼Œå› ä¸ºæ— æ³•åœ¨ç½‘ç»œä¸­æŒ‡å®šæ‰¹æ¬¡ç»´åº¦ã€‚éšå¼æ‰¹å¤„ç†æ¨¡å¼ä¸‹æ— æ³•è¡¨è¾¾çš„æ“ä½œç¤ºä¾‹ï¼š</p>
<ul>
<li>å‡å°‘æ•´ä¸ªæ‰¹æ¬¡ç»´åº¦</li>
<li>é‡å¡‘æ‰¹æ¬¡ç»´åº¦</li>
<li>ç”¨å¦ä¸€ä¸ªç»´åº¦è½¬ç½®æ‰¹æ¬¡ç»´åº¦</li>
</ul>
<p>ä¾‹å¤–æ˜¯å¼ é‡å¯ä»¥åœ¨æ•´ä¸ªæ‰¹æ¬¡ä¸­å¹¿æ’­ï¼Œé€šè¿‡æ–¹æ³•<code>ITensor::setBroadcastAcrossBatch</code>ç”¨äºç½‘ç»œè¾“å…¥ï¼Œå¹¶é€šè¿‡éšå¼å¹¿æ’­ç”¨äºå…¶ä»–å¼ é‡ã€‚</p>
<p>æ˜¾å¼æ‰¹å¤„ç†æ¨¡å¼æ¶ˆé™¤äº†é™åˆ¶ â€“ æ‰¹å¤„ç†è½´æ˜¯è½´ 0ã€‚æ˜¾å¼æ‰¹å¤„ç†çš„æ›´å‡†ç¡®æœ¯è¯­æ˜¯â€œ<code>batch oblivious</code>â€ï¼Œå› ä¸ºåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒTensorRT å¯¹å¼•å¯¼è½´æ²¡æœ‰ç‰¹æ®Šçš„è¯­ä¹‰å«ä¹‰ï¼Œé™¤éç‰¹å®šæ“ä½œéœ€è¦. å®é™…ä¸Šï¼Œåœ¨æ˜¾å¼æ‰¹å¤„ç†æ¨¡å¼ä¸‹ï¼Œç”šè‡³å¯èƒ½æ²¡æœ‰æ‰¹å¤„ç†ç»´åº¦ï¼ˆä¾‹å¦‚ä»…å¤„ç†å•ä¸ªå›¾åƒçš„ç½‘ç»œï¼‰ï¼Œæˆ–è€…å¯èƒ½å­˜åœ¨å¤šä¸ªé•¿åº¦ä¸ç›¸å…³çš„æ‰¹å¤„ç†ç»´åº¦ï¼ˆä¾‹å¦‚æ¯”è¾ƒä»ä¸¤ä¸ªæ‰¹å¤„ç†ä¸­æå–çš„æ‰€æœ‰å¯èƒ½å¯¹ï¼‰ã€‚</p>
<p><strong><code>INetworkDefinition</code> æ—¶ï¼Œå¿…é¡»é€šè¿‡æ ‡å¿—æŒ‡å®šæ˜¾å¼ä¸éšå¼æ‰¹å¤„ç†çš„é€‰æ‹©ã€‚</strong>è¿™æ˜¯æ˜¾å¼æ‰¹å¤„ç†æ¨¡å¼çš„ Python ä»£ç ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">builder = trt.Builder(...)</span><br><span class="line">builder.create_network(<span class="number">1</span> &lt;&lt; <span class="built_in">int</span>(trt.NetworkDefinitionCreationFlag.EXPLICIT_BATCH)</span><br></pre></td></tr></table></figure></div>

<p>å¯¹äºéšå¼æ‰¹å¤„ç†ï¼Œçœç•¥å‚æ•°æˆ–ä¼ é€’ 0ã€‚</p>
<h2 id="Sparsity"><a href="#Sparsity" class="headerlink" title="Sparsity"></a>Sparsity</h2><p>NVIDIA å®‰åŸ¹æ¶æ„ GPU æ”¯æŒç»“æ„åŒ–ç¨€ç–æ€§ã€‚<strong>åœ¨ä¿è¯ç²¾åº¦æ¨ç†çš„åŒæ—¶ï¼Œé™ä½æ·±åº¦å­¦ä¹ æ¨¡å‹ä¸­çš„éƒ¨åˆ†æƒé‡ï¼Œå‡å°æ¨¡å‹æ‰€éœ€è¦çš„å¸¦å®½å’Œå†…å­˜ï¼Œåœ¨æå‡æ•ˆç‡çš„åŒæ—¶ä½¿å¼€å‘è€…èƒ½å¤Ÿé€šè¿‡å‡å°‘è®¡ç®—æ“ä½œæ¥åŠ é€Ÿç¥ç»ç½‘ç»œã€‚</strong>ä¸ºäº†åˆ©ç”¨è¯¥ç‰¹æ€§è·å¾—æ›´é«˜çš„æ¨ç†æ€§èƒ½ï¼Œå·ç§¯æ ¸æƒé‡å’Œå…¨è¿æ¥æƒé‡å¿…é¡»æ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š</p>
<p>å¯¹äºæ¯ä¸ªè¾“å‡ºé€šé“å’Œå†…æ ¸æƒé‡ä¸­çš„æ¯ä¸ªç©ºé—´åƒç´ ï¼Œæ¯ 4 ä¸ªè¾“å…¥é€šé“å¿…é¡»è‡³å°‘æœ‰ 2 ä¸ªé›¶ã€‚æ¢å¥è¯è¯´ï¼Œå‡è®¾å†…æ ¸æƒé‡çš„å½¢çŠ¶ä¸º[K, C, R, S]å’ŒC % 4 &#x3D;&#x3D; 0 ï¼Œé‚£ä¹ˆè¦æ±‚æ˜¯ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> K:</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> R:</span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> S:</span><br><span class="line">            <span class="keyword">for</span> c_packed <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, C // <span class="number">4</span>):</span><br><span class="line">                num_zeros(weights[k, c_packed*<span class="number">4</span>:(c_packed+<span class="number">1</span>)*<span class="number">4</span>, r, s]) &gt;= <span class="number">2</span></span><br></pre></td></tr></table></figure></div>

<p>è¦å¯ç”¨ç¨€ç–ç‰¹æ€§ï¼Œ<strong>è¯·åœ¨æ„å»ºå™¨é…ç½®ä¸­è®¾ç½®<code>kSPARSE_WEIGHTS</code>æ ‡å¿—ï¼Œå¹¶ç¡®ä¿å¯ç”¨ <code>kFP16</code> æˆ– <code>kINT8</code> æ¨¡å¼</strong>ã€‚ä¾‹å¦‚</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.set_flag(trt.BuilderFlag.SPARSE_WEIGHTS)</span><br></pre></td></tr></table></figure></div>

<p>åœ¨æ„å»º TensorRT å¼•æ“æ—¶ï¼Œåœ¨ TensorRT æ—¥å¿—çš„æœ«å°¾ï¼ŒTensorRT ä¼šæŠ¥å‘Šå“ªäº›å±‚åŒ…å«æ»¡è¶³ç»“æ„ç¨€ç–æ€§è¦æ±‚çš„æƒé‡ï¼Œä»¥åŠ TensorRT åœ¨å“ªäº›å±‚ä¸­é€‰æ‹©äº†åˆ©ç”¨ç»“æ„åŒ–ç¨€ç–æ€§çš„ç­–ç•¥ã€‚<strong>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå…·æœ‰ç»“æ„åŒ–ç¨€ç–æ€§çš„ç­–ç•¥å¯èƒ½æ¯”æ­£å¸¸ç­–ç•¥æ…¢ï¼ŒTensorRT åœ¨è¿™äº›æƒ…å†µä¸‹ä¼šé€‰æ‹©æ­£å¸¸ç­–ç•¥ã€‚</strong>ä»¥ä¸‹è¾“å‡ºæ˜¾ç¤ºäº†ä¸€ä¸ªæ˜¾ç¤ºæœ‰å…³ç¨€ç–æ€§ä¿¡æ¯çš„ TensorRT æ—¥å¿—ç¤ºä¾‹ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[03/23/2021-00:14:05] [I] [TRT] (Sparsity) Layers eligible for sparse math: conv1, conv2, conv3</span><br><span class="line">[03/23/2021-00:14:05] [I] [TRT] (Sparsity) TRT inference plan picked sparse implementation for layers: conv2, conv3</span><br></pre></td></tr></table></figure></div>

<p>å¼ºåˆ¶å†…æ ¸æƒé‡å…·æœ‰ç»“æ„åŒ–çš„ç¨€ç–æ¨¡å¼å¯èƒ½ä¼šå¯¼è‡´å‡†ç¡®æ€§æŸå¤±ã€‚è¦é€šè¿‡è¿›ä¸€æ­¥å¾®è°ƒæ¢å¤ä¸¢å¤±çš„å‡†ç¡®æ€§</p>
<p><strong>è¦ä½¿ç”¨<code>trtexec</code>æµ‹é‡ç»“æ„åŒ–ç¨€ç–æ€§çš„æ¨ç†æ€§èƒ½</strong>ï¼Œè¯·å‚é˜…<a class="link"   target="_blank" rel="noopener" href="https://docs.nvidia.com/deeplearning/tensorrt/developer-guide/index.html#trtexec" >trtexec <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>éƒ¨åˆ†ã€‚</p>
<h2 id="Empty-Tensors"><a href="#Empty-Tensors" class="headerlink" title="Empty Tensors"></a>Empty Tensors</h2><p>TensorRT æ”¯æŒç©ºå¼ é‡ã€‚å¦‚æœå¼ é‡å…·æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªé•¿åº¦ä¸ºé›¶çš„ç»´åº¦ï¼Œåˆ™å®ƒæ˜¯ä¸€ä¸ªç©ºå¼ é‡ã€‚<strong>é›¶é•¿åº¦å°ºå¯¸é€šå¸¸ä¸ä¼šå¾—åˆ°ç‰¹æ®Šå¤„ç†ã€‚å¦‚æœä¸€æ¡è§„åˆ™é€‚ç”¨äºé•¿åº¦ä¸º L çš„ä»»æ„æ­£å€¼ L çš„ç»´åº¦ï¼Œå®ƒé€šå¸¸ä¹Ÿé€‚ç”¨äº L&#x3D;0ã€‚</strong></p>
<p>ä¾‹å¦‚ï¼Œå½“æ²¿æœ€åä¸€ä¸ªè½´è¿æ¥ä¸¤ä¸ªç»´åº¦ä¸º <code>[x,y,z] </code>å’Œ <code>[x,y,w]</code> çš„å¼ é‡æ—¶ï¼Œç»“æœçš„ç»´åº¦ä¸º <code>[x,y,z+w]</code>ï¼Œæ— è®º <code>x,y, zï¼Œ</code>æˆ–è€… <code>w</code> ä¸ºé›¶ã€‚</p>
<p><strong>éšå¼å¹¿æ’­è§„åˆ™ä¿æŒä¸å˜ï¼Œå› ä¸ºåªæœ‰å•ä½é•¿åº¦ç»´åº¦å¯¹å¹¿æ’­æ˜¯ç‰¹æ®Šçš„ã€‚</strong>ä¾‹å¦‚ï¼Œç»™å®šä¸¤ä¸ªç»´åº¦ä¸º <code>[1,y,z]</code> å’Œ <code>[x,1,z]</code> çš„å¼ é‡ï¼Œå®ƒä»¬ç”±<code>IElementWiseLayer</code>è®¡ç®—çš„æ€»å’Œå…·æœ‰ç»´åº¦<code> [x,y,z]</code>ï¼Œæ— è®º <code>xã€y æˆ– z</code> æ˜¯å¦ä¸ºé›¶.</p>
<p>å¦‚æœä¸€ä¸ªå¼•æ“ç»‘å®šæ˜¯ä¸€ä¸ªç©ºçš„å¼ é‡ï¼Œå®ƒä»ç„¶éœ€è¦ä¸€ä¸ªéç©ºçš„å†…å­˜åœ°å€ï¼Œå¹¶ä¸”ä¸åŒçš„å¼ é‡åº”è¯¥æœ‰ä¸åŒçš„åœ°å€ã€‚è¿™ä¸C++ä¸­æ¯ä¸ªå¯¹è±¡éƒ½æœ‰å”¯ä¸€åœ°å€çš„è§„åˆ™æ˜¯ä¸€è‡´çš„ï¼Œä¾‹å¦‚<code>new float[0]</code>è¿”å›ä¸€ä¸ªéç©ºæŒ‡é’ˆã€‚å¦‚æœä½¿ç”¨å¯èƒ½è¿”å›é›¶å­—èŠ‚ç©ºæŒ‡é’ˆçš„å†…å­˜åˆ†é…å™¨ï¼Œè¯·æ”¹ä¸ºè¯·æ±‚è‡³å°‘ä¸€ä¸ªå­—èŠ‚ã€‚</p>
<h2 id="Reusing-Input-Buffers"><a href="#Reusing-Input-Buffers" class="headerlink" title="Reusing Input Buffers"></a>Reusing Input Buffers</h2><p>TensorRT è¿˜åŒ…æ‹¬ä¸€ä¸ªå¯é€‰çš„ CUDA äº‹ä»¶ä½œä¸º<code>enqueue</code>æ–¹æ³•çš„å‚æ•°ï¼Œ<strong>ä¸€æ—¦è¾“å…¥ç¼“å†²åŒºå¯ä»¥é‡ç”¨ï¼Œå°±ä¼šå‘å‡ºä¿¡å·</strong>ã€‚è¿™å…è®¸åº”ç”¨ç¨‹åºåœ¨å®Œæˆå½“å‰æ¨ç†çš„åŒæ—¶ç«‹å³å¼€å§‹é‡æ–°å¡«å……è¾“å…¥ç¼“å†²åŒºä»¥è¿›è¡Œä¸‹ä¸€æ¬¡æ¨ç†ã€‚ä¾‹å¦‚ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.execute_async_v2(buffers, stream_ptr, inputReady)</span><br></pre></td></tr></table></figure></div>

<h2 id="Engine-Inspector"><a href="#Engine-Inspector" class="headerlink" title="Engine Inspector"></a>Engine Inspector</h2><p><strong>TensorRT æä¾›<code>IEngineInspector</code> API æ¥æ£€æŸ¥ TensorRT å¼•æ“å†…éƒ¨çš„ä¿¡æ¯ã€‚</strong>ä»ååºåˆ—åŒ–çš„å¼•æ“ä¸­è°ƒç”¨<code>createEngineInspector()</code>åˆ›å»ºå¼•æ“<code>inspector</code>ï¼Œç„¶åè°ƒç”¨<code>getLayerInformation()</code>æˆ–<code>getEngineInformation() inspector</code> APIåˆ†åˆ«è·å–å¼•æ“ä¸­ç‰¹å®šå±‚æˆ–æ•´ä¸ªå¼•æ“çš„ä¿¡æ¯ã€‚å¯ä»¥æ‰“å°å‡ºç»™å®šå¼•æ“çš„ç¬¬ä¸€å±‚ä¿¡æ¯ï¼Œä»¥åŠå¼•æ“çš„æ•´ä½“ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">inspector = engine.create_engine_inspector();</span><br><span class="line">inspector.execution_context = context; <span class="comment"># OPTIONAL</span></span><br><span class="line"><span class="built_in">print</span>(inspector.get_layer_information(<span class="number">0</span>, LayerInformationFormat.JSON); <span class="comment"># Print the information of the first layer in the engine.</span></span><br><span class="line"><span class="built_in">print</span>(inspector.get_engine_information(LayerInformationFormat.JSON); <span class="comment"># Print the information of the entire engine.</span></span><br></pre></td></tr></table></figure></div>

<p><strong>è¯·æ³¨æ„ï¼Œå¼•æ“&#x2F;å±‚ä¿¡æ¯ä¸­çš„è¯¦ç»†ç¨‹åº¦å–å†³äºæ„å»ºå¼•æ“æ—¶çš„<code>ProfilingVerbosity</code>æ„å»ºå™¨é…ç½®è®¾ç½®</strong>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ <code>ProfilingVerbosity</code>è®¾ç½®ä¸º<code>kLAYER_NAMES_ONLY</code> ï¼Œå› æ­¤åªä¼šæ‰“å°å±‚åç§°ã€‚å¦‚æœ<code>ProfilingVerbosity</code>è®¾ç½®ä¸º<code>kNONE</code> ï¼Œåˆ™ä¸ä¼šæ‰“å°ä»»ä½•ä¿¡æ¯ï¼›å¦‚æœè®¾ç½®ä¸º<code>kDETAILED</code> ï¼Œåˆ™ä¼šæ‰“å°è¯¦ç»†ä¿¡æ¯ã€‚</p>
<p><code>getLayerInformation()</code> API æ ¹æ®<code>ProfilingVerbosity</code>è®¾ç½®æ‰“å°çš„å±‚ä¿¡æ¯çš„ä¸€äº›ç¤ºä¾‹ï¼š</p>
<p><strong>kLAYER_NAMES_ONLY</strong></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_of_gpu_0/res4_0_branch2a_1 + node_of_gpu_0/res4_0_branch2a_bn_1 + node_of_gpu_0/res4_0_branch2a_bn_2</span><br></pre></td></tr></table></figure></div>

<p><strong>kDETAILED</strong></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;Name&quot;: &quot;node_of_gpu_0/res4_0_branch2a_1 + node_of_gpu_0/res4_0_branch2a_bn_1 + node_of_gpu_0/res4_0_branch2a_bn_2&quot;,</span><br><span class="line">  &quot;LayerType&quot;: &quot;CaskConvolution&quot;,</span><br><span class="line">  &quot;Inputs&quot;: [</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;Name&quot;: &quot;gpu_0/res3_3_branch2c_bn_3&quot;,</span><br><span class="line">    &quot;Dimensions&quot;: [16,512,28,28],</span><br><span class="line">    &quot;Format/Datatype&quot;: &quot;Thirty-two wide channel vectorized row major Int8 format.&quot;</span><br><span class="line">  &#125;],</span><br><span class="line">  &quot;Outputs&quot;: [</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;Name&quot;: &quot;gpu_0/res4_0_branch2a_bn_2&quot;,</span><br><span class="line">    &quot;Dimensions&quot;: [16,256,28,28],</span><br><span class="line">    &quot;Format/Datatype&quot;: &quot;Thirty-two wide channel vectorized row major Int8 format.&quot;</span><br><span class="line">  &#125;],</span><br><span class="line">  &quot;ParameterType&quot;: &quot;Convolution&quot;,</span><br><span class="line">  &quot;Kernel&quot;: [1,1],</span><br><span class="line">  &quot;PaddingMode&quot;: &quot;kEXPLICIT_ROUND_DOWN&quot;,</span><br><span class="line">  &quot;PrePadding&quot;: [0,0],</span><br><span class="line">  &quot;PostPadding&quot;: [0,0],</span><br><span class="line">  &quot;Stride&quot;: [1,1],</span><br><span class="line">  &quot;Dilation&quot;: [1,1],</span><br><span class="line">  &quot;OutMaps&quot;: 256,</span><br><span class="line">  &quot;Groups&quot;: 1,</span><br><span class="line">  &quot;Weights&quot;: &#123;&quot;Type&quot;: &quot;Int8&quot;, &quot;Count&quot;: 131072&#125;,</span><br><span class="line">  &quot;Bias&quot;: &#123;&quot;Type&quot;: &quot;Float&quot;, &quot;Count&quot;: 256&#125;,</span><br><span class="line">  &quot;AllowSparse&quot;: 0,</span><br><span class="line">  &quot;Activation&quot;: &quot;RELU&quot;,</span><br><span class="line">  &quot;HasBias&quot;: 1,</span><br><span class="line">  &quot;HasReLU&quot;: 1,</span><br><span class="line">  &quot;TacticName&quot;: &quot;sm80_xmma_fprop_implicit_gemm_interleaved_i8i8_i8i32_f32_nchw_vect_c_32kcrs_vect_c_32_nchw_vect_c_32_tilesize256x128x64_stage4_warpsize4x2x1_g1_tensor16x8x32_simple_t1r1s1_epifadd&quot;,</span><br><span class="line">  &quot;TacticValue&quot;: &quot;0x11bde0e1d9f2f35d&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¦å¤–ï¼Œ<strong>å½“å¼•æ“ä½¿ç”¨åŠ¨æ€å½¢çŠ¶æ„å»ºæ—¶</strong>ï¼Œå¼•æ“ä¿¡æ¯ä¸­çš„åŠ¨æ€ç»´åº¦å°†æ˜¾ç¤ºä¸º-1 ï¼Œå¹¶ä¸”ä¸ä¼šæ˜¾ç¤ºå¼ é‡æ ¼å¼ä¿¡æ¯ï¼Œå› ä¸ºè¿™äº›å­—æ®µå–å†³äºæ¨ç†é˜¶æ®µçš„å®é™…å½¢çŠ¶ã€‚<strong>è¦è·å–ç‰¹å®šæ¨ç†å½¢çŠ¶çš„å¼•æ“ä¿¡æ¯ï¼Œè¯·åˆ›å»ºä¸€ä¸ª<code>IExecutionContext</code></strong> ï¼Œå°†æ‰€æœ‰è¾“å…¥å°ºå¯¸è®¾ç½®ä¸ºæ‰€éœ€çš„å½¢çŠ¶ï¼Œç„¶åè°ƒç”¨<code>inspector-&gt;setExecutionContext(context)</code> ã€‚è®¾ç½®ä¸Šä¸‹æ–‡åï¼Œæ£€æŸ¥å™¨å°†æ‰“å°ä¸Šä¸‹æ–‡ä¸­è®¾ç½®çš„ç‰¹å®šå½¢çŠ¶çš„å¼•æ“ä¿¡æ¯ã€‚</p>
<p>trtexecå·¥å…·æä¾›äº†<code>--profilingVerbosity</code> ã€ <code>--dumpLayerInfo</code>å’Œ<code>--exportLayerInfo</code>æ ‡å¿—ï¼Œå¯ç”¨äºè·å–ç»™å®šå¼•æ“çš„å¼•æ“ä¿¡æ¯ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…<a class="link"   target="_blank" rel="noopener" href="https://docs.nvidia.com/deeplearning/tensorrt/developer-guide/index.html#trtexec" >trtexec <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>éƒ¨åˆ†ã€‚</p>
<p>ç›®å‰ï¼Œå¼•æ“ä¿¡æ¯ä¸­åªåŒ…å«ç»‘å®šä¿¡æ¯å’Œå±‚ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸­é—´å¼ é‡çš„ç»´åº¦ã€ç²¾åº¦ã€æ ¼å¼ã€ç­–ç•¥æŒ‡æ ‡ã€å±‚ç±»å‹å’Œå±‚å‚æ•°ã€‚åœ¨æœªæ¥çš„ TensorRT ç‰ˆæœ¬ä¸­ï¼Œæ›´å¤šä¿¡æ¯å¯èƒ½ä¼šä½œä¸ºè¾“å‡º JSON å¯¹è±¡ä¸­çš„æ–°é”®æ·»åŠ åˆ°å¼•æ“æ£€æŸ¥å™¨è¾“å‡ºä¸­ã€‚è¿˜å°†æä¾›æœ‰å…³æ£€æŸ¥å™¨è¾“å‡ºä¸­çš„é”®å’Œå­—æ®µçš„æ›´å¤šè§„èŒƒã€‚</p>
<h2 id="Quantization-1"><a href="#Quantization-1" class="headerlink" title="Quantization"></a>Quantization</h2><p>TensorRT æ”¯æŒä½¿ç”¨ 8 ä½æ•´æ•°æ¥è¡¨ç¤ºé‡åŒ–çš„æµ®ç‚¹å€¼ã€‚é‡åŒ–æ–¹æ¡ˆæ˜¯å¯¹ç§°å‡åŒ€é‡åŒ– â€“ é‡åŒ–å€¼ä»¥æœ‰ç¬¦å· INT8 è¡¨ç¤ºï¼Œä»é‡åŒ–åˆ°éé‡åŒ–å€¼çš„è½¬æ¢åªæ˜¯ä¸€ä¸ªä¹˜æ³•ã€‚åœ¨ç›¸åçš„æ–¹å‘ä¸Šï¼Œé‡åŒ–ä½¿ç”¨å€’æ•°å°ºåº¦ï¼Œç„¶åæ˜¯èˆå…¥å’Œé’³ä½ã€‚<strong>è¦å¯ç”¨ä»»ä½•é‡åŒ–æ“ä½œï¼Œå¿…é¡»åœ¨æ„å»ºå™¨é…ç½®ä¸­è®¾ç½® INT8 æ ‡å¿—ã€‚</strong></p>
<h3 id="Quantization-Workflows"><a href="#Quantization-Workflows" class="headerlink" title="Quantization Workflows"></a>Quantization Workflows</h3><p>åˆ›å»ºé‡åŒ–ç½‘ç»œæœ‰ä¸¤ç§å·¥ä½œæµç¨‹ï¼š</p>
<p>è®­ç»ƒåé‡åŒ–(PTQ: Post-training quantization) <strong>åœ¨ç½‘ç»œç»è¿‡è®­ç»ƒåå¾—å‡ºæ¯”ä¾‹å› å­ã€‚</strong> TensorRT ä¸º PTQ æä¾›äº†ä¸€ä¸ªå·¥ä½œæµç¨‹ï¼Œç§°ä¸º<strong>æ ¡å‡†</strong>(<code>calibration</code>)ï¼Œå½“ç½‘ç»œåœ¨ä»£è¡¨æ€§è¾“å…¥æ•°æ®ä¸Šæ‰§è¡Œæ—¶ï¼Œå®ƒæµ‹é‡æ¯ä¸ªæ¿€æ´»å¼ é‡å†…çš„æ¿€æ´»åˆ†å¸ƒï¼Œç„¶åä½¿ç”¨è¯¥åˆ†å¸ƒæ¥ä¼°è®¡å¼ é‡çš„å°ºåº¦å€¼ã€‚</p>
<p>é‡åŒ–æ„ŸçŸ¥è®­ç»ƒ(QAT: Quantization-aware training) <strong>åœ¨è®­ç»ƒæœŸé—´è®¡ç®—æ¯”ä¾‹å› å­ã€‚</strong>è¿™å…è®¸è®­ç»ƒè¿‡ç¨‹è¡¥å¿é‡åŒ–å’Œå»é‡åŒ–æ“ä½œçš„å½±å“ã€‚</p>
<p>TensorRT çš„<a class="link"   target="_blank" rel="noopener" href="https://github.com/NVIDIA/TensorRT/tree/main/tools/pytorch-quantization" >é‡åŒ–å·¥å…·åŒ… <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>æ˜¯ä¸€ä¸ª PyTorch åº“ï¼Œå¯å¸®åŠ©ç”Ÿæˆå¯ç”± TensorRT ä¼˜åŒ–çš„ QAT æ¨¡å‹ã€‚æ‚¨è¿˜å¯ä»¥åˆ©ç”¨å·¥å…·åŒ…çš„ PTQ æ–¹å¼åœ¨ PyTorch ä¸­æ‰§è¡Œ PTQ å¹¶å¯¼å‡ºåˆ° ONNXã€‚</p>
<h3 id="Explicit-vs-Implicit-Quantization"><a href="#Explicit-vs-Implicit-Quantization" class="headerlink" title="Explicit vs Implicit Quantization"></a>Explicit vs Implicit Quantization</h3><p>é‡åŒ–ç½‘ç»œå¯ä»¥ç”¨ä¸¤ç§æ–¹å¼è¡¨ç¤ºï¼š</p>
<p><strong>åœ¨éšå¼é‡åŒ–ç½‘ç»œä¸­ï¼Œæ¯ä¸ªé‡åŒ–å¼ é‡éƒ½æœ‰ä¸€ä¸ªç›¸å…³çš„å°ºåº¦ã€‚åœ¨è¯»å†™å¼ é‡æ—¶ï¼Œå°ºåº¦ç”¨äºéšå¼é‡åŒ–å’Œåé‡åŒ–å€¼ã€‚</strong></p>
<p>åœ¨å¤„ç†éšå¼é‡åŒ–ç½‘ç»œæ—¶ï¼ŒTensorRT åœ¨åº”ç”¨å›¾å½¢ä¼˜åŒ–æ—¶å°†æ¨¡å‹è§†ä¸ºæµ®ç‚¹æ¨¡å‹ï¼Œå¹¶é€‚æ—¶çš„ä½¿ç”¨ INT8 æ¥ä¼˜åŒ–å±‚æ‰§è¡Œæ—¶é—´ã€‚å¦‚æœä¸€ä¸ªå±‚åœ¨ INT8 ä¸­è¿è¡Œå¾—æ›´å¿«ï¼Œé‚£ä¹ˆå®ƒåœ¨ INT8 ä¸­æ‰§è¡Œã€‚å¦åˆ™ï¼Œä½¿ç”¨ FP32 æˆ– FP16ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒTensorRT ä»…é’ˆå¯¹æ€§èƒ½è¿›è¡Œä¼˜åŒ–ï¼Œæ‚¨å‡ ä¹<strong>æ— æ³•æ§åˆ¶ INT8 çš„ä½¿ç”¨ä½ç½®</strong>â€”â€”å³ä½¿æ‚¨åœ¨ API çº§åˆ«æ˜ç¡®è®¾ç½®å±‚çš„ç²¾åº¦ï¼ŒTensorRT ä¹Ÿå¯èƒ½åœ¨å›¾ä¼˜åŒ–æœŸé—´å°†è¯¥å±‚ä¸å¦ä¸€ä¸ªå±‚èåˆï¼Œå¹¶ä¸¢å¤±å®ƒå¿…é¡»åœ¨ INT8 ä¸­æ‰§è¡Œçš„ä¿¡æ¯ã€‚ <strong>TensorRT çš„ PTQï¼ˆè®­ç»ƒåé‡åŒ–ï¼‰ åŠŸèƒ½å¯ç”Ÿæˆéšå¼é‡åŒ–ç½‘ç»œã€‚</strong></p>
<p>åœ¨æ˜¾å¼é‡åŒ–çš„ç½‘ç»œä¸­ï¼Œ<strong>åœ¨é‡åŒ–å’Œæœªé‡åŒ–å€¼ä¹‹é—´è½¬æ¢çš„ç¼©æ”¾æ“ä½œç”±å›¾ä¸­çš„<code>IQuantizeLayer</code> å’Œ<code>IDequantizeLayer</code> èŠ‚ç‚¹æ˜¾å¼è¡¨ç¤º â€“ è¿™äº›èŠ‚ç‚¹æ­¤åå°†è¢«ç§°ä¸º Q&#x2F;DQ ï¼ˆé‡åŒ–&#x2F;å»é‡åŒ–ï¼‰èŠ‚ç‚¹</strong>ã€‚<strong>ä¸éšå¼é‡åŒ–ç›¸æ¯”ï¼Œæ˜¾å¼å½¢å¼ç²¾ç¡®åœ°æŒ‡å®šäº†ä¸ INT8 ä¹‹é—´çš„è½¬æ¢åœ¨ä½•å¤„æ‰§è¡Œ</strong>ï¼Œå¹¶ä¸”ä¼˜åŒ–å™¨å°†ä»…æ‰§è¡Œç”±æ¨¡å‹è¯­ä¹‰è§„å®šçš„ç²¾åº¦è½¬æ¢ï¼Œå³ä½¿ï¼š</p>
<ul>
<li>æ·»åŠ é¢å¤–çš„è½¬æ¢å¯ä»¥æé«˜å±‚ç²¾åº¦ï¼ˆä¾‹å¦‚ï¼Œé€‰æ‹© FP16 å†…æ ¸å®ç°è€Œä¸æ˜¯ INT8 å®ç°ï¼‰</li>
<li>æ·»åŠ é¢å¤–çš„è½¬æ¢ä¼šå¯¼è‡´å¼•æ“æ‰§è¡Œå¾—æ›´å¿«ï¼ˆä¾‹å¦‚ï¼Œé€‰æ‹© INT8 å†…æ ¸å®ç°æ¥æ‰§è¡ŒæŒ‡å®šä¸ºå…·æœ‰æµ®ç‚¹ç²¾åº¦çš„å±‚ï¼Œåä¹‹äº¦ç„¶ï¼‰</li>
</ul>
<p>ONNX ä½¿ç”¨æ˜¾å¼é‡åŒ–è¡¨ç¤º â€“ å½“ PyTorch æˆ– TensorFlow ä¸­çš„æ¨¡å‹å¯¼å‡ºåˆ° ONNX æ—¶ï¼Œæ¡†æ¶å›¾ä¸­çš„æ¯ä¸ªä¼ªé‡åŒ–æ“ä½œéƒ½å¯¼å‡ºä¸º Qï¼Œç„¶åæ˜¯ DQã€‚ç”±äº TensorRT ä¿ç•™äº†è¿™äº›å±‚çš„è¯­ä¹‰ï¼Œå› æ­¤æ‚¨å¯ä»¥æœŸæœ›ä»»åŠ¡å‡†ç¡®åº¦éå¸¸æ¥è¿‘æ¡†æ¶ä¸­çœ‹åˆ°çš„å‡†ç¡®åº¦ã€‚è™½ç„¶ä¼˜åŒ–ä¿ç•™äº†é‡åŒ–å’Œå»é‡åŒ–çš„ä½ç½®ï¼Œä½†å®ƒä»¬å¯èƒ½ä¼šæ”¹å˜æ¨¡å‹ä¸­æµ®ç‚¹è¿ç®—çš„é¡ºåºï¼Œå› æ­¤ç»“æœä¸ä¼šæŒ‰ä½ç›¸åŒã€‚ <strong>è¯·æ³¨æ„ï¼Œä¸ TensorRT çš„ PTQ ç›¸æ¯”ï¼Œåœ¨æ¡†æ¶ä¸­æ‰§è¡Œ QAT æˆ– PTQ ç„¶åå¯¼å‡ºåˆ° ONNX å°†äº§ç”Ÿä¸€ä¸ªæ˜ç¡®é‡åŒ–çš„æ¨¡å‹</strong>ã€‚</p>
<h3 id="Per-Tensor-and-Per-Channel-Quantization"><a href="#Per-Tensor-and-Per-Channel-Quantization" class="headerlink" title="Per-Tensor and Per-Channel Quantization"></a>Per-Tensor and Per-Channel Quantization</h3><p>æœ‰ä¸¤ç§å¸¸è§çš„é‡åŒ–å°ºåº¦ç²’åº¦ï¼š</p>
<ul>
<li><strong>æ¯å¼ é‡é‡åŒ–ï¼šå…¶ä¸­ä½¿ç”¨å•ä¸ªæ¯”ä¾‹å€¼ï¼ˆæ ‡é‡ï¼‰æ¥ç¼©æ”¾æ•´ä¸ªå¼ é‡ã€‚</strong></li>
<li><strong>æ¯é€šé“é‡åŒ–ï¼šæ²¿ç»™å®šè½´å¹¿æ’­å°ºåº¦å¼ é‡ â€“ å¯¹äºå·ç§¯ç¥ç»ç½‘ç»œï¼Œè¿™é€šå¸¸æ˜¯é€šé“è½´ã€‚</strong></li>
</ul>
<p>é€šè¿‡æ˜¾å¼é‡åŒ–ï¼Œ<strong>æƒé‡å¯ä»¥ä½¿ç”¨æ¯å¼ é‡é‡åŒ–è¿›è¡Œé‡åŒ–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ¯é€šé“é‡åŒ–è¿›è¡Œé‡åŒ–</strong>ã€‚åœ¨ä»»ä½•ä¸€ç§æƒ…å†µä¸‹ï¼Œæ¯”ä¾‹ç²¾åº¦éƒ½æ˜¯ FP32ã€‚<strong>æ¿€æ´»åªèƒ½ä½¿ç”¨æ¯å¼ é‡é‡åŒ–æ¥é‡åŒ–</strong>ã€‚é€šè¿‡æ˜¾å¼é‡åŒ–ï¼Œæƒé‡å¯ä»¥ä½¿ç”¨æ¯å¼ é‡é‡åŒ–è¿›è¡Œé‡åŒ–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ¯é€šé“é‡åŒ–è¿›è¡Œé‡åŒ–ã€‚åœ¨ä»»ä½•ä¸€ç§æƒ…å†µä¸‹ï¼Œæ¯”ä¾‹ç²¾åº¦éƒ½æ˜¯ FP32ã€‚æ¿€æ´»åªèƒ½ä½¿ç”¨æ¯å¼ é‡é‡åŒ–æ¥é‡åŒ–ã€‚</p>
<p><strong>å½“ä½¿ç”¨æ¯é€šé“é‡åŒ–æ—¶ï¼Œé‡åŒ–è½´å¿…é¡»æ˜¯è¾“å‡ºé€šé“è½´</strong>ã€‚ä¾‹å¦‚ï¼Œå½“ä½¿ç”¨<code>KCRS</code>è¡¨ç¤ºæ³•æè¿° 2D å·ç§¯çš„æƒé‡æ—¶ï¼Œ Kæ˜¯è¾“å‡ºé€šé“è½´ï¼Œæƒé‡é‡åŒ–å¯ä»¥æè¿°ä¸ºï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">For each k <span class="keyword">in</span> K:</span><br><span class="line">    For each c <span class="keyword">in</span> C:</span><br><span class="line">        For each r <span class="keyword">in</span> R:</span><br><span class="line">            For each s <span class="keyword">in</span> S:</span><br><span class="line">                output[k,c,r,s] := clamp(<span class="built_in">round</span>(<span class="built_in">input</span>[k,c,r,s] / scale[k]))		<span class="comment">#é‡åŒ–è½´æ˜¯kè¡¨ç¤ºä»¥kçš„å°ºåº¦ä¸ºæ ‡å‡†</span></span><br></pre></td></tr></table></figure></div>

<p><strong>æ¯”ä¾‹å°ºæ˜¯ä¸€ä¸ªç³»æ•°å‘é‡ï¼Œå¿…é¡»ä¸é‡åŒ–è½´å…·æœ‰ç›¸åŒçš„å¤§å°</strong>ã€‚é‡åŒ–å°ºåº¦å¿…é¡»ç”±æ‰€æœ‰æ­£æµ®ç‚¹ç³»æ•°ç»„æˆã€‚å››èˆäº”å…¥æ–¹æ³•æ˜¯å››èˆäº”å…¥åˆ°æœ€è¿‘çš„å…³ç³»åˆ°å¶æ•°ï¼Œå¹¶ä¸”é’³ä½åœ¨[-128, 127]èŒƒå›´å†…ã€‚</p>
<p>é™¤äº†å®šä¹‰ä¸ºçš„é€ç‚¹æ“ä½œå¤–ï¼Œåé‡åŒ–çš„æ‰§è¡Œæ–¹å¼ç±»ä¼¼ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">output[k,c,r,s] := <span class="built_in">input</span>[k,c,r,s] * scale[k]</span><br></pre></td></tr></table></figure></div>

<p><strong>TensorRT ä»…æ”¯æŒ<code>æ¿€æ´»å¼ é‡</code>çš„æ¯å¼ é‡é‡åŒ–ï¼Œä½†æ”¯æŒå·ç§¯ã€åå·ç§¯ã€å…¨è¿æ¥å±‚å’Œ MatMul çš„æ¯é€šé“æƒé‡é‡åŒ–ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªè¾“å…¥æ˜¯å¸¸æ•°ä¸”ä¸¤ä¸ªè¾“å…¥çŸ©é˜µéƒ½æ˜¯äºŒç»´çš„ã€‚</strong></p>
<h2 id="Setting-Dynamic-Range"><a href="#Setting-Dynamic-Range" class="headerlink" title="Setting Dynamic Range"></a>Setting Dynamic Range</h2><p>TensorRT æä¾› API æ¥ç›´æ¥<strong>è®¾ç½®åŠ¨æ€èŒƒå›´ï¼ˆå¿…é¡»ç”±é‡åŒ–å¼ é‡è¡¨ç¤ºçš„èŒƒå›´ï¼‰ï¼Œä»¥æ”¯æŒåœ¨ TensorRT ä¹‹å¤–è®¡ç®—è¿™äº›å€¼çš„éšå¼é‡åŒ–ã€‚</strong> API å…è®¸ä½¿ç”¨æœ€å°å€¼å’Œæœ€å¤§å€¼è®¾ç½®å¼ é‡çš„åŠ¨æ€èŒƒå›´ã€‚ç”±äº TensorRT ç›®å‰ä»…æ”¯æŒå¯¹ç§°èŒƒå›´ï¼Œå› æ­¤ä½¿ç”¨<code>max(abs(min_float), abs(max_float))</code>è®¡ç®—æ¯”ä¾‹ã€‚<strong>è¯·æ³¨æ„ï¼Œå½“<code>abs(min_float) != abs(max_float)</code>æ—¶ï¼ŒTensorRT ä½¿ç”¨æ¯”é…ç½®æ›´å¤§çš„åŠ¨æ€èŒƒå›´ï¼Œè¿™å¯èƒ½ä¼šå¢åŠ èˆå…¥è¯¯å·®ã€‚</strong></p>
<p><strong>å°†åœ¨ INT8 ä¸­æ‰§è¡Œçš„æ“ä½œçš„æ‰€æœ‰æµ®ç‚¹è¾“å…¥å’Œè¾“å‡ºéƒ½éœ€è¦åŠ¨æ€èŒƒå›´ã€‚</strong></p>
<p>æ‚¨å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼è®¾ç½®å¼ é‡çš„åŠ¨æ€èŒƒå›´ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tensor.dynamic_range = (min_float, max_float)</span><br></pre></td></tr></table></figure></div>

<h2 id="Post-Training-Quantization-using-Calibration"><a href="#Post-Training-Quantization-using-Calibration" class="headerlink" title="Post-Training Quantization using Calibration"></a>Post-Training Quantization using Calibration</h2><p><strong>åœ¨è®­ç»ƒåé‡åŒ–ä¸­ï¼ŒTensorRT è®¡ç®—ç½‘ç»œä¸­æ¯ä¸ªå¼ é‡çš„æ¯”ä¾‹å€¼ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºæ ¡å‡†</strong>ï¼Œéœ€è¦æ‚¨æä¾›æœ‰ä»£è¡¨æ€§çš„è¾“å…¥æ•°æ®ï¼ŒTensorRT åœ¨å…¶ä¸Šè¿è¡Œç½‘ç»œä»¥æ”¶é›†æ¯ä¸ªæ¿€æ´»å¼ é‡çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</p>
<p>æ‰€éœ€çš„è¾“å…¥æ•°æ®é‡å–å†³äºåº”ç”¨ç¨‹åºï¼Œä½†å®éªŒè¡¨æ˜å¤§çº¦ 500 å¼ å›¾åƒè¶³ä»¥æ ¡å‡† ImageNet åˆ†ç±»ç½‘ç»œã€‚</p>
<p>ç»™å®šæ¿€æ´»å¼ é‡çš„ç»Ÿè®¡æ•°æ®ï¼Œå†³å®šæœ€ä½³å°ºåº¦å€¼å¹¶ä¸æ˜¯ä¸€é—¨ç²¾ç¡®çš„ç§‘å­¦â€”â€”å®ƒéœ€è¦å¹³è¡¡é‡åŒ–è¡¨ç¤ºä¸­çš„ä¸¤ä¸ªè¯¯å·®æºï¼š<strong>ç¦»æ•£åŒ–è¯¯å·®</strong>ï¼ˆéšç€æ¯ä¸ªé‡åŒ–å€¼è¡¨ç¤ºçš„èŒƒå›´å˜å¤§è€Œå¢åŠ ï¼‰å’Œ<strong>æˆªæ–­è¯¯å·®</strong>ï¼ˆå…¶ä¸­å€¼è¢«é™åˆ¶åœ¨å¯è¡¨ç¤ºèŒƒå›´çš„æé™ï¼Œ<strong>å¤„äºæé™æ— æ³•æ›´æ”¹</strong>ï¼‰ã€‚<strong>å› æ­¤ï¼ŒTensorRT æä¾›äº†å¤šä¸ªä¸åŒçš„æ ¡å‡†å™¨ï¼Œå®ƒä»¬ä»¥ä¸åŒçš„æ–¹å¼è®¡ç®—æ¯”ä¾‹ã€‚</strong>è¾ƒæ—§çš„æ ¡å‡†å™¨è¿˜ä¸º GPU æ‰§è¡Œå±‚èåˆï¼Œä»¥åœ¨æ‰§è¡Œæ ¡å‡†ä¹‹å‰ä¼˜åŒ–æ‰ä¸éœ€è¦çš„å¼ é‡ã€‚è¿™åœ¨ä½¿ç”¨ DLA æ—¶å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œå…¶ä¸­èåˆæ¨¡å¼å¯èƒ½ä¸åŒï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨<code>kCALIBRATE_BEFORE_FUSION</code>é‡åŒ–æ ‡å¿—è¦†ç›–ã€‚</p>
<p><strong>IInt8EntropyCalibrator2</strong></p>
<p><strong>ç†µæ ¡å‡†é€‰æ‹©å¼ é‡çš„æ¯”ä¾‹å› å­æ¥ä¼˜åŒ–é‡åŒ–å¼ é‡çš„ä¿¡æ¯è®ºå†…å®¹ï¼Œé€šå¸¸ä¼šæŠ‘åˆ¶åˆ†å¸ƒä¸­çš„å¼‚å¸¸å€¼</strong>ã€‚è¿™æ˜¯å½“å‰<strong>æ¨è</strong>çš„ç†µæ ¡å‡†å™¨ï¼Œæ˜¯ DLA æ‰€å¿…éœ€çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ ¡å‡†å‘ç”Ÿåœ¨å›¾å±‚èåˆä¹‹å‰ã€‚æ¨èç”¨äºåŸºäº CNN çš„ç½‘ç»œã€‚</p>
<p><strong>IInt8MinMaxCalibrator</strong></p>
<p><strong>è¯¥æ ¡å‡†å™¨ä½¿ç”¨æ¿€æ´»åˆ†å¸ƒçš„æ•´ä¸ªèŒƒå›´æ¥ç¡®å®šæ¯”ä¾‹å› å­</strong>ã€‚å®ƒä¼¼ä¹æ›´é€‚åˆ NLP ä»»åŠ¡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ ¡å‡†å‘ç”Ÿåœ¨å›¾å±‚èåˆä¹‹å‰ã€‚æ¨èç”¨äº NVIDIA BERTï¼ˆè°·æ­Œå®˜æ–¹å®ç°çš„ä¼˜åŒ–ç‰ˆæœ¬ï¼‰ç­‰ç½‘ç»œã€‚</p>
<p><strong>IInt8EntropyCalibrator</strong></p>
<p>è¿™æ˜¯åŸå§‹çš„ç†µæ ¡å‡†å™¨ã€‚å®ƒçš„ä½¿ç”¨æ²¡æœ‰<code> LegacyCalibrator</code> å¤æ‚ï¼Œé€šå¸¸ä¼šäº§ç”Ÿæ›´å¥½çš„ç»“æœã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ ¡å‡†å‘ç”Ÿåœ¨å›¾å±‚èåˆä¹‹åã€‚</p>
<p><strong>IInt8LegacyCalibrator</strong></p>
<p>è¯¥æ ¡å‡†å™¨ä¸ TensorRT 2.0 EA å…¼å®¹ã€‚æ­¤æ ¡å‡†å™¨éœ€è¦ç”¨æˆ·å‚æ•°åŒ–ï¼Œ<strong>å¹¶ä¸”åœ¨å…¶ä»–æ ¡å‡†å™¨äº§ç”Ÿä¸è‰¯ç»“æœæ—¶ä½œä¸ºå¤‡ç”¨é€‰é¡¹æä¾›</strong>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ ¡å‡†å‘ç”Ÿåœ¨å›¾å±‚èåˆä¹‹åã€‚æ‚¨å¯ä»¥è‡ªå®šä¹‰æ­¤æ ¡å‡†å™¨ä»¥å®ç°æœ€å¤§ç™¾åˆ†æ¯”ï¼Œä¾‹å¦‚ï¼Œè§‚å¯Ÿåˆ° 99.99% çš„æœ€å¤§ç™¾åˆ†æ¯”å¯¹äº NVIDIA BERT å…·æœ‰æœ€ä½³ç²¾åº¦ã€‚</p>
<p><strong>æ„å»º INT8 å¼•æ“æ—¶ï¼Œæ„å»ºå™¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</strong></p>
<ol>
<li>æ„å»ºä¸€ä¸ª 32 ä½å¼•æ“ï¼Œåœ¨æ ¡å‡†é›†ä¸Šè¿è¡Œå®ƒï¼Œå¹¶ä¸ºæ¿€æ´»å€¼åˆ†å¸ƒçš„æ¯ä¸ªå¼ é‡è®°å½•ä¸€ä¸ªç›´æ–¹å›¾ã€‚</li>
<li>ä»ç›´æ–¹å›¾æ„å»ºä¸€ä¸ªæ ¡å‡†è¡¨ï¼Œä¸ºæ¯ä¸ªå¼ é‡æä¾›ä¸€ä¸ªæ¯”ä¾‹å€¼ã€‚</li>
<li>æ ¹æ®æ ¡å‡†è¡¨å’Œç½‘ç»œå®šä¹‰æ„å»º INT8 å¼•æ“ã€‚</li>
</ol>
<p><strong>æ ¡å‡†å¯èƒ½å¾ˆæ…¢ï¼Œå› æ­¤æ­¥éª¤ 2 çš„è¾“å‡ºï¼ˆæ ¡å‡†è¡¨ï¼‰å¯ä»¥è¢«ç¼“å­˜å’Œé‡ç”¨</strong>ã€‚è¿™åœ¨å¤šæ¬¡æ„å»ºç›¸åŒçš„ç½‘ç»œæ—¶éå¸¸æœ‰ç”¨ï¼Œä¾‹å¦‚ï¼Œåœ¨å¤šä¸ªå¹³å°ä¸Š â€“ ç‰¹åˆ«æ˜¯ï¼Œå®ƒå¯ä»¥ç®€åŒ–å·¥ä½œæµç¨‹ï¼Œåœ¨å…·æœ‰ç¦»æ•£ GPU çš„æœºå™¨ä¸Šæ„å»ºæ ¡å‡†è¡¨ï¼Œç„¶ååœ¨åµŒå…¥å¼å¹³å°ä¸Šé‡ç”¨å®ƒã€‚å¯åœ¨æ­¤å¤„æ‰¾åˆ°æ ·æœ¬æ ¡å‡†è¡¨ã€‚ <strong>åœ¨è¿è¡Œæ ¡å‡†ä¹‹å‰ï¼ŒTensorRT ä¼šæŸ¥è¯¢æ ¡å‡†å™¨å®ç°ä»¥æŸ¥çœ‹å®ƒæ˜¯å¦æœ‰æƒè®¿é—®ç¼“å­˜è¡¨ã€‚å¦‚æœæ˜¯è¿™æ ·ï¼Œå®ƒç›´æ¥è¿›è¡Œåˆ°ä¸Šé¢çš„æ­¥éª¤ 3</strong>ã€‚ç¼“å­˜æ•°æ®ä½œä¸ºæŒ‡é’ˆå’Œé•¿åº¦ä¼ é€’ã€‚</p>
<p><strong>åªè¦æ ¡å‡†å‘ç”Ÿåœ¨å±‚èåˆä¹‹å‰ï¼Œæ ¡å‡†ç¼“å­˜æ•°æ®å°±å¯ä»¥åœ¨å¹³å°ä¹‹é—´ä»¥åŠä¸ºä¸åŒè®¾å¤‡æ„å»ºå¼•æ“æ—¶ç§»æ¤ã€‚</strong>è¿™æ„å‘³ç€åœ¨é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨<code>IInt8EntropyCalibrator2æˆ–IInt8MinMaxCalibrator</code>æ ¡å‡†å™¨æˆ–è®¾ç½®<code>QuantizationFlag::kCALIBRATE_BEFORE_FUSION</code>æ—¶ï¼Œæ ¡å‡†ç¼“å­˜æ˜¯å¯ç§»æ¤çš„ã€‚ä¸èƒ½ä¿è¯è·¨å¹³å°æˆ–è®¾å¤‡çš„èåˆæ˜¯ç›¸åŒçš„ï¼Œå› æ­¤åœ¨å±‚èåˆä¹‹åè¿›è¡Œæ ¡å‡†å¯èƒ½ä¸ä¼šäº§ç”Ÿä¾¿æºå¼æ ¡å‡†ç¼“å­˜ã€‚ é™¤äº†é‡åŒ–æ¿€æ´»ï¼ŒTensorRT è¿˜å¿…é¡»é‡åŒ–æƒé‡ã€‚å®ƒä½¿ç”¨å¯¹ç§°é‡åŒ–å’Œä½¿ç”¨æƒé‡å¼ é‡ä¸­æ‰¾åˆ°çš„æœ€å¤§ç»å¯¹å€¼è®¡ç®—çš„é‡åŒ–æ¯”ä¾‹ã€‚å¯¹äºå·ç§¯ã€åå·ç§¯å’Œå…¨è¿æ¥æƒé‡ï¼Œå°ºåº¦æ˜¯æ¯ä¸ªé€šé“çš„ã€‚</p>
<p>æ³¨æ„ï¼šå½“æ„å»ºå™¨é…ç½®ä¸ºä½¿ç”¨ INT8 I&#x2F;O æ—¶ï¼ŒTensorRT ä»å¸Œæœ›æ ¡å‡†æ•°æ®ä½äº <code>FP32</code> ä¸­ã€‚æ‚¨å¯ä»¥é€šè¿‡å°† INT8 I&#x2F;O æ ¡å‡†æ•°æ®è½¬æ¢ä¸º <code>FP32</code> ç²¾åº¦æ¥åˆ›å»º <code>FP32</code> æ ¡å‡†æ•°æ®ã€‚æ‚¨è¿˜å¿…é¡»ç¡®ä¿ <code>FP32 </code>æŠ•å°„æ ¡å‡†æ•°æ®åœ¨<code>[-128.0F, 127.0F]</code>èŒƒå›´å†…ï¼Œ<strong>å› æ­¤å¯ä»¥è½¬æ¢ä¸º <code>INT8</code> æ•°æ®è€Œä¸ä¼šé€ æˆä»»ä½•ç²¾åº¦æŸå¤±ã€‚</strong></p>
<p>INT8 æ ¡å‡†å¯ä¸åŠ¨æ€èŒƒå›´ API ä¸€èµ·ä½¿ç”¨ã€‚<strong>æ‰‹åŠ¨è®¾ç½®åŠ¨æ€èŒƒå›´ä¼šè¦†ç›– INT8 æ ¡å‡†ç”Ÿæˆçš„åŠ¨æ€èŒƒå›´ã€‚</strong></p>
<p>æ³¨æ„ï¼šæ ¡å‡†æ˜¯ç¡®å®šæ€§çš„â€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ‚¨åœ¨åŒä¸€è®¾å¤‡ä¸Šä»¥ç›¸åŒçš„é¡ºåºä¸º TensorRT æä¾›ç›¸åŒçš„æ ¡å‡†è¾“å…¥ï¼Œåˆ™ç”Ÿæˆçš„æ¯”ä¾‹åœ¨ä¸åŒçš„è¿è¡Œä¸­å°†æ˜¯ç›¸åŒçš„ã€‚å½“æä¾›ç›¸åŒçš„æ ¡å‡†è¾“å…¥æ—¶ï¼Œå½“ä½¿ç”¨å…·æœ‰ç›¸åŒæ‰¹é‡å¤§å°çš„ç›¸åŒè®¾å¤‡ç”Ÿæˆæ—¶ï¼Œæ ¡å‡†ç¼“å­˜ä¸­çš„æ•°æ®å°†æŒ‰ä½ç›¸åŒã€‚å½“ä½¿ç”¨ä¸åŒçš„è®¾å¤‡ã€ä¸åŒçš„æ‰¹é‡å¤§å°æˆ–ä½¿ç”¨ä¸åŒçš„æ ¡å‡†è¾“å…¥ç”Ÿæˆæ ¡å‡†ç¼“å­˜æ—¶ï¼Œä¸èƒ½ä¿è¯æ ¡å‡†ç¼“å­˜ä¸­çš„ç¡®åˆ‡æ•°æ®æŒ‰ä½ç›¸åŒã€‚</p>
<h3 id="Calibration-Using-Python"><a href="#Calibration-Using-Python" class="headerlink" title="Calibration Using Python"></a>Calibration Using Python</h3><p>ä»¥ä¸‹æ­¥éª¤è¯´æ˜äº†å¦‚ä½•ä½¿ç”¨ Python API åˆ›å»º INT8 æ ¡å‡†å™¨å¯¹è±¡ã€‚ ç¨‹åº</p>
<ol>
<li>å¯¼å…¥ TensorRTï¼š</li>
</ol>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import tensorrt as trt</span><br></pre></td></tr></table></figure></div>

<ol start="2">
<li>ä¸æµ‹è¯•&#x2F;éªŒè¯æ•°æ®é›†ç±»ä¼¼ï¼Œä½¿ç”¨ä¸€ç»„è¾“å…¥æ–‡ä»¶ä½œä¸ºæ ¡å‡†æ•°æ®é›†ã€‚ç¡®ä¿æ ¡å‡†æ–‡ä»¶ä»£è¡¨æ•´ä¸ªæ¨ç†æ•°æ®æ–‡ä»¶ã€‚ä¸ºäº†è®© TensorRT ä½¿ç”¨æ ¡å‡†æ–‡ä»¶ï¼Œæ‚¨å¿…é¡»åˆ›å»ºä¸€ä¸ªæ‰¹å¤„ç†æµå¯¹è±¡ã€‚æ‰¹å¤„ç†æµå¯¹è±¡ç”¨äºé…ç½®æ ¡å‡†å™¨ã€‚</li>
</ol>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NUM_IMAGES_PER_BATCH = <span class="number">5</span></span><br><span class="line">batchstream = ImageBatchStream(NUM_IMAGES_PER_BATCH, calibration_files)</span><br></pre></td></tr></table></figure></div>

<ol start="3">
<li>ä½¿ç”¨è¾“å…¥èŠ‚ç‚¹åç§°å’Œæ‰¹å¤„ç†æµåˆ›å»ºä¸€ä¸ªInt8_calibratorå¯¹è±¡ï¼š</li>
</ol>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Int8_calibrator = EntropyCalibrator([<span class="string">&quot;input_node_name&quot;</span>], batchstream)</span><br></pre></td></tr></table></figure></div>

<ol start="4">
<li>è®¾ç½® INT8 æ¨¡å¼å’Œ INT8 æ ¡å‡†å™¨ï¼š</li>
</ol>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config.set_flag(trt.BuilderFlag.INT8)</span><br><span class="line">config.int8_calibrator = Int8_calibrator</span><br></pre></td></tr></table></figure></div>

<h2 id="Explicit-Quantization"><a href="#Explicit-Quantization" class="headerlink" title="Explicit Quantization"></a>Explicit Quantization</h2><p><strong>å½“ TensorRT æ£€æµ‹åˆ°ç½‘ç»œä¸­å­˜åœ¨ Q&#x2F;DQ å±‚æ—¶ï¼Œå®ƒä¼šä½¿ç”¨æ˜¾å¼ç²¾åº¦å¤„ç†é€»è¾‘æ„å»ºä¸€ä¸ªå¼•æ“ã€‚</strong></p>
<p><strong>AQ&#x2F;DQ ç½‘ç»œå¿…é¡»åœ¨å¯ç”¨ INT8 ç²¾åº¦æ„å»ºå™¨æ ‡å¿—çš„æƒ…å†µä¸‹æ„å»ºï¼š</strong></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config-&gt;setFlag(BuilderFlag::kINT8);</span><br></pre></td></tr></table></figure></div>

<p>åœ¨æ˜¾å¼é‡åŒ–ä¸­ï¼Œè¡¨ç¤ºä¸ INT8 ä¹‹é—´çš„ç½‘ç»œå˜åŒ–æ˜¯æ˜¾å¼çš„ï¼Œå› æ­¤ï¼ŒINT8 ä¸èƒ½ç”¨ä½œç±»å‹çº¦æŸã€‚</p>
<h3 id="Quantized-Weights"><a href="#Quantized-Weights" class="headerlink" title="Quantized Weights"></a>Quantized Weights</h3><p><strong>Q&#x2F;DQ æ¨¡å‹çš„æƒé‡å¿…é¡»ä½¿ç”¨ <code>FP32</code> æ•°æ®ç±»å‹æŒ‡å®šã€‚</strong> TensorRT ä½¿ç”¨å¯¹æƒé‡è¿›è¡Œæ“ä½œçš„<code>IQuantizeLayer</code>çš„æ¯”ä¾‹å¯¹æƒé‡è¿›è¡Œé‡åŒ–ã€‚<strong>é‡åŒ–çš„æƒé‡å­˜å‚¨åœ¨å¼•æ“æ–‡ä»¶ä¸­</strong>ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨é¢„é‡åŒ–æƒé‡ï¼Œä½†å¿…é¡»ä½¿ç”¨ <code>FP32</code> æ•°æ®ç±»å‹æŒ‡å®šã€‚ Q èŠ‚ç‚¹çš„ <code>scale</code> å¿…é¡»è®¾ç½®ä¸º<code>1.0F</code> ï¼Œä½† <code>DQ</code> èŠ‚ç‚¹å¿…é¡»æ˜¯çœŸå®çš„ <code>scale</code> å€¼</p>
<h3 id="ONNX-Support"><a href="#ONNX-Support" class="headerlink" title="ONNX Support"></a>ONNX Support</h3><p>å½“ä½¿ç”¨ <code>Quantization Aware Training (QAT)</code> åœ¨ PyTorch æˆ– TensorFlow ä¸­è®­ç»ƒçš„æ¨¡å‹å¯¼å‡ºåˆ° ONNX æ—¶ï¼Œæ¡†æ¶å›¾ä¸­çš„æ¯ä¸ªä¼ªé‡åŒ–æ“ä½œéƒ½ä¼šå¯¼å‡ºä¸ºä¸€å¯¹<code>QuantizeLinear</code>å’Œ<code>DequantizeLinear</code> ONNX è¿ç®—ç¬¦ã€‚</p>
<p>å½“ TensorRT å¯¼å…¥ ONNX æ¨¡å‹æ—¶ï¼ŒONNX <code>QuantizeLinear</code>ç®—å­ä½œä¸º<code>IQuantizeLayer</code>å®ä¾‹å¯¼å…¥ï¼ŒONNX <code>DequantizeLinear</code>ç®—å­ä½œä¸º<code>IDequantizeLayer</code>å®ä¾‹å¯¼å…¥ã€‚</p>
<p>è­¦å‘Šï¼š <strong>ONNX GEMM ç®—å­æ˜¯ä¸€ä¸ªå¯ä»¥æŒ‰é€šé“é‡åŒ–çš„ç¤ºä¾‹ã€‚</strong> PyTorch <code>torch.nn.Linear</code>å±‚å¯¼å‡ºä¸º ONNX GEMM ç®—å­ï¼Œå…·æœ‰<code>(K, C)</code>æƒé‡å¸ƒå±€å¹¶å¯ç”¨äº†<code>transB</code> GEMM å±æ€§ï¼ˆè¿™ä¼šåœ¨æ‰§è¡Œ GEMM æ“ä½œä¹‹å‰è½¬ç½®æƒé‡ï¼‰ã€‚å¦ä¸€æ–¹é¢ï¼ŒTensorFlowåœ¨ ONNX å¯¼å‡ºä¹‹å‰é¢„è½¬ç½®æƒé‡<code>(C, K)</code> ï¼š</p>
<p>PyTorch: $y &#x3D; xW^T$</p>
<p>TensorFlow: $y &#x3D; xW$</p>
<p><strong>PyTorch æƒé‡ç”± TensorRT è½¬ç½®</strong>ã€‚æƒé‡åœ¨è½¬ç½®ä¹‹å‰ç”± TensorRT è¿›è¡Œé‡åŒ–ï¼Œæºè‡ªä» PyTorch å¯¼å‡ºçš„ ONNX QAT æ¨¡å‹çš„ GEMM å±‚ä½¿ç”¨ç»´åº¦0è¿›è¡Œæ¯é€šé“é‡åŒ–ï¼ˆè½´K &#x3D; 0 ï¼‰ï¼›è€Œæºè‡ª TensorFlow çš„æ¨¡å‹ä½¿ç”¨ç»´åº¦1 ï¼ˆè½´K &#x3D; 1 ï¼‰ã€‚</p>
<p><strong>TensorRT ä¸æ”¯æŒä½¿ç”¨ INT8 å¼ é‡æˆ–é‡åŒ–è¿ç®—ç¬¦çš„é¢„é‡åŒ– ONNX æ¨¡å‹ã€‚</strong>å…·ä½“æ¥è¯´ï¼Œä»¥ä¸‹ ONNX é‡åŒ–è¿ç®—ç¬¦ä¸å—æ”¯æŒï¼Œå¦‚æœåœ¨ TensorRT å¯¼å…¥ ONNX æ¨¡å‹æ—¶é‡åˆ°å®ƒä»¬ï¼Œåˆ™ä¼šç”Ÿæˆå¯¼å…¥é”™è¯¯ï¼š</p>
<ul>
<li>QLinearConv&#x2F;QLinearMatmul</li>
<li>ConvInteger&#x2F;MatmulInteger</li>
</ul>
<h3 id="TensorRT-Processing-Of-Q-x2F-DQ-Networks"><a href="#TensorRT-Processing-Of-Q-x2F-DQ-Networks" class="headerlink" title="TensorRT Processing Of Q&#x2F;DQ Networks"></a>TensorRT Processing Of Q&#x2F;DQ Networks</h3><p>å½“ TensorRT åœ¨ Q&#x2F;DQ æ¨¡å¼ä¸‹ä¼˜åŒ–ç½‘ç»œæ—¶ï¼Œä¼˜åŒ–è¿‡ç¨‹ä»…é™äºä¸æ”¹å˜ç½‘ç»œç®—æœ¯æ­£ç¡®æ€§çš„ä¼˜åŒ–ã€‚ç”±äºæµ®ç‚¹è¿ç®—çš„é¡ºåºä¼šäº§ç”Ÿä¸åŒçš„ç»“æœï¼ˆä¾‹å¦‚ï¼Œé‡å†™ $a * s + b * s$ ä¸º $(a + b) * s$æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ä¼˜åŒ–ï¼‰ã€‚å…è®¸è¿™äº›å·®å¼‚é€šå¸¸æ˜¯åç«¯ä¼˜åŒ–çš„åŸºç¡€ï¼Œè¿™ä¹Ÿé€‚ç”¨äºå°†å…·æœ‰ <code>Q/DQ</code> å±‚çš„å›¾è½¬æ¢ä¸ºä½¿ç”¨ INT8 è®¡ç®—ã€‚</p>
<p><strong>Q&#x2F;DQ å±‚æ§åˆ¶ç½‘ç»œçš„è®¡ç®—å’Œæ•°æ®ç²¾åº¦</strong>ã€‚ <code>IQuantizeLayer</code>å®ä¾‹é€šè¿‡é‡åŒ–å°† <code>FP32</code> å¼ é‡è½¬æ¢ä¸º <code>INT8</code> å¼ é‡ï¼Œ <code>IDequantizeLayer</code>å®ä¾‹é€šè¿‡åé‡åŒ–å°†INT8å¼ é‡è½¬æ¢ä¸º FP32 å¼ é‡ã€‚ TensorRT æœŸæœ›é‡åŒ–å±‚çš„æ¯ä¸ªè¾“å…¥ä¸Šéƒ½æœ‰ä¸€ä¸ª <code>Q/DQ</code> å±‚å¯¹ã€‚é‡åŒ–å±‚æ˜¯æ·±åº¦å­¦ä¹ å±‚ï¼Œå¯ä»¥é€šè¿‡ä¸<code>IQuantizeLayer</code>å’Œ<code>IDequantizeLayer</code>å®ä¾‹èåˆæ¥è½¬æ¢ä¸ºé‡åŒ–å±‚ã€‚å½“ TensorRT æ‰§è¡Œè¿™äº›èåˆæ—¶ï¼Œå®ƒä¼šå°†å¯é‡åŒ–å±‚æ›¿æ¢ä¸ºå®é™…ä½¿ç”¨ INT8 è®¡ç®—æ“ä½œå¯¹ INT8 æ•°æ®è¿›è¡Œæ“ä½œçš„é‡åŒ–å±‚ã€‚</p>
<p>ä¸‹å›¾. å¯é‡åŒ–çš„<code>AveragePool</code>å±‚ï¼ˆè“è‰²ï¼‰ä¸ <code>DQ</code> å±‚å’Œ <code>Q</code> å±‚èåˆã€‚æ‰€æœ‰ä¸‰å±‚éƒ½è¢«é‡åŒ–çš„<code>AveragePool</code>å±‚ï¼ˆç»¿è‰²ï¼‰æ›¿æ¢ã€‚</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230224092537580-168493652323435.png"
                      class="" title="image-20230224092537580"
                >

<p>åœ¨ç½‘ç»œä¼˜åŒ–æœŸé—´ï¼ŒTensorRT åœ¨ç§°ä¸º <code>Q/DQ</code> ä¼ æ’­çš„è¿‡ç¨‹ä¸­ç§»åŠ¨ <code>Q/DQ</code> å±‚ã€‚<strong>ä¼ æ’­çš„ç›®æ ‡æ˜¯æœ€å¤§åŒ–ä»¥ä½ç²¾åº¦å¤„ç†çš„å›¾çš„æ¯”ä¾‹</strong>ã€‚<strong>å› æ­¤ï¼ŒTensorRT å‘åä¼ æ’­ Q èŠ‚ç‚¹ï¼ˆä»¥ä¾¿å°½å¯èƒ½æ—©åœ°è¿›è¡Œé‡åŒ–ï¼‰å’Œå‘å‰ä¼ æ’­ DQ èŠ‚ç‚¹ï¼ˆä»¥ä¾¿å°½å¯èƒ½æ™šåœ°è¿›è¡Œå»é‡åŒ–ï¼‰</strong>ã€‚ Q-layers å¯ä»¥ä¸ <code>commute-with-Quantization</code> å±‚äº¤æ¢ä½ç½®ï¼ŒDQ-layers å¯ä»¥ä¸ <code>commute-with-Dequantization</code> å±‚äº¤æ¢ä½ç½®ã€‚</p>
<p>ä¸‹å›¾è¯´æ˜äº† DQ å‰å‘ä¼ æ’­å’Œ Q åå‘ä¼ æ’­ã€‚è¿™äº›æ˜¯å¯¹æ¨¡å‹çš„åˆæ³•é‡å†™ï¼Œå› ä¸º <code>Max Pooling</code> å…·æœ‰ INT8 å®ç°ï¼Œå¹¶ä¸”å› ä¸º Max Pooling ä¸ DQ å’Œ Q é€šè®¯ã€‚</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230224093014841-168493652323436.png"
                      class="" title="image-20230224093014841"
                >

<p><strong>é‡åŒ–å±‚å’Œäº¤æ¢å±‚çš„å¤„ç†æ–¹å¼æ˜¯æœ‰åŒºåˆ«çš„ï¼Œå¯é‡åŒ–å±‚èåˆï¼Œä¸å¯é‡åŒ–å±‚äº¤æ¢</strong>ä¸¤ç§ç±»å‹çš„å±‚éƒ½å¯ä»¥åœ¨ INT8 ä¸­è®¡ç®—ï¼Œä½†å¯é‡åŒ–å±‚ä¹Ÿä¸ DQ è¾“å…¥å±‚å’Œ Q è¾“å‡ºå±‚èåˆã€‚ä¾‹å¦‚ï¼Œ <code>AveragePooling</code>å±‚ï¼ˆå¯é‡åŒ–ï¼‰ä¸ä¸ Q æˆ– DQ äº¤æ¢ï¼Œå› æ­¤ä½¿ç”¨ <code>Q/DQ</code> èåˆå¯¹å…¶è¿›è¡Œé‡åŒ–ï¼Œå¦‚ç¬¬ä¸€å¼ å›¾æ‰€ç¤ºã€‚è¿™ä¸å¦‚ä½•é‡åŒ– <code>Max Pooling</code>ï¼ˆäº¤æ¢ï¼‰å½¢æˆå¯¹æ¯”ã€‚</p>
<h3 id="Q-x2F-DQ-Layer-Placement-Recommendations"><a href="#Q-x2F-DQ-Layer-Placement-Recommendations" class="headerlink" title="Q&#x2F;DQ Layer-Placement Recommendations"></a>Q&#x2F;DQ Layer-Placement Recommendations</h3><p><strong>Q&#x2F;DQ å±‚åœ¨ç½‘ç»œä¸­çš„æ”¾ç½®ä¼šå½±å“æ€§èƒ½å’Œå‡†ç¡®æ€§ã€‚</strong>ç”±äºé‡åŒ–å¼•å…¥çš„è¯¯å·®ï¼Œæ¿€è¿›é‡åŒ–ä¼šå¯¼è‡´æ¨¡å‹ç²¾åº¦ä¸‹é™ã€‚ä½†é‡åŒ–ä¹Ÿå¯ä»¥å‡å°‘å»¶è¿Ÿã€‚æ­¤å¤„åˆ—å‡ºäº†åœ¨ç½‘ç»œä¸­æ”¾ç½® Q&#x2F;DQ å±‚çš„ä¸€äº›å»ºè®®ã€‚</p>
<p>é‡åŒ–åŠ æƒè¿ç®—ï¼ˆå·ç§¯ã€è½¬ç½®å·ç§¯å’Œ GEMMï¼‰çš„æ‰€æœ‰è¾“å…¥ã€‚<strong>æƒé‡å’Œæ¿€æ´»çš„é‡åŒ–é™ä½äº†å¸¦å®½éœ€æ±‚</strong>ï¼Œè¿˜ä½¿ INT8 è®¡ç®—èƒ½å¤ŸåŠ é€Ÿå¸¦å®½å—é™å’Œè®¡ç®—å—é™çš„å±‚ã€‚</p>
<p>ä¸‹å›¾ TensorRT å¦‚ä½•èåˆå·ç§¯å±‚çš„ä¸¤ä¸ªç¤ºä¾‹ã€‚åœ¨å·¦è¾¹ï¼Œåªæœ‰è¾“å…¥è¢«é‡åŒ–ã€‚åœ¨å³è¾¹ï¼Œè¾“å…¥å’Œè¾“å‡ºéƒ½è¢«é‡åŒ–äº†ã€‚</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230224094858275-168493652323437.png"
                      class="" title="image-20230224094858275"
                >

<p><strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸é‡åŒ–åŠ æƒè¿ç®—çš„è¾“å‡ºã€‚ä¿ç•™æ›´é«˜ç²¾åº¦çš„å»é‡åŒ–è¾“å‡ºæœ‰æ—¶å¾ˆæœ‰ç”¨</strong>ã€‚ä¾‹å¦‚ï¼Œå¦‚æœçº¿æ€§è¿ç®—åé¢è·Ÿç€ä¸€ä¸ªæ¿€æ´»å‡½æ•°ï¼ˆSiLUï¼Œä¸‹å›¾ä¸­ï¼‰ï¼Œå®ƒéœ€è¦æ›´é«˜çš„ç²¾åº¦è¾“å…¥æ‰èƒ½äº§ç”Ÿå¯æ¥å—çš„ç²¾åº¦ã€‚</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230224095026719-168493652323438.png"
                      class="" title="image-20230224095026719"
                >]

<p><strong>ä¸è¦åœ¨è®­ç»ƒæ¡†æ¶ä¸­æ¨¡æ‹Ÿæ‰¹é‡å½’ä¸€åŒ–å’Œ ReLU èåˆ</strong>ï¼Œå› ä¸º TensorRT ä¼˜åŒ–ä¿è¯ä¿ç•™è¿™äº›æ“ä½œçš„ç®—æœ¯è¯­ä¹‰ã€‚</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230224095059801-168493652323439.png"
                      class="" title="image-20230224095059801"
                >

<p>TensorRT å¯ä»¥åœ¨åŠ æƒå±‚ä¹‹åèåˆelement-wise additionï¼Œè¿™å¯¹äºåƒ ResNet å’Œ EfficientNet è¿™æ ·å…·æœ‰è·³è·ƒè¿æ¥çš„æ¨¡å‹å¾ˆæœ‰ç”¨ã€‚<strong>element-wise additionå±‚çš„ç¬¬ä¸€ä¸ªè¾“å…¥çš„ç²¾åº¦å†³å®šäº†èåˆè¾“å‡ºçš„ç²¾åº¦ã€‚</strong></p>
<p>æ¯”å¦‚ä¸‹å›¾ä¸­ï¼Œ$x_f^1$çš„ç²¾åº¦æ˜¯æµ®ç‚¹æ•°ï¼Œæ‰€ä»¥èåˆå·ç§¯çš„è¾“å‡ºä»…é™äºæµ®ç‚¹æ•°ï¼Œåé¢çš„Qå±‚ä¸èƒ½å’Œå·ç§¯èåˆã€‚</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230224095136553-168493652323541.png"
                      class="" title="image-20230224095136553"
                >

<p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œå½“$x_f^1$é‡åŒ–ä¸º INT8 æ—¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œèåˆå·ç§¯çš„è¾“å‡ºä¹Ÿæ˜¯ INT8ï¼Œå°¾éƒ¨çš„ Q å±‚ä¸å·ç§¯èåˆã€‚</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230224095222434-168493652323540.png"
                      class="" title="image-20230224095222434"
                >

<p>ä¸ºäº†è·å¾—é¢å¤–çš„æ€§èƒ½ï¼Œè¯·å°è¯•ä½¿ç”¨ Q&#x2F;DQ é‡åŒ–ä¸äº¤æ¢çš„å±‚ã€‚ç›®å‰ï¼Œå…·æœ‰ INT8 è¾“å…¥çš„éåŠ æƒå±‚ä¹Ÿéœ€è¦ INT8 è¾“å‡ºï¼Œå› æ­¤å¯¹è¾“å…¥å’Œè¾“å‡ºéƒ½è¿›è¡Œé‡åŒ–ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://github.com/HeKun-NVIDIA/TensorRT-Developer_Guide_in_Chinese/blob/main/7.TensorRT%E4%B8%AD%E7%9A%84INT8/q-dq-placement6.png"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://github.com/HeKun-NVIDIA/TensorRT-Developer_Guide_in_Chinese/raw/main/7.TensorRT%E4%B8%AD%E7%9A%84INT8/q-dq-placement6.png"
                      alt="img"
                ></a></p>
<p>å¦‚æœ TensorRT æ— æ³•å°†æ“ä½œä¸å‘¨å›´çš„ Q&#x2F;DQ å±‚èåˆï¼Œåˆ™æ€§èƒ½å¯èƒ½ä¼šé™ä½ï¼Œå› æ­¤åœ¨æ·»åŠ  Q&#x2F;DQ èŠ‚ç‚¹æ—¶è¦ä¿å®ˆï¼Œå¹¶ç‰¢è®°å‡†ç¡®æ€§å’Œ TensorRT æ€§èƒ½è¿›è¡Œè¯•éªŒã€‚</p>
<p>ä¸‹å›¾æ˜¯é¢å¤– Q&#x2F;DQ æ“ä½œå¯èƒ½å¯¼è‡´çš„æ¬¡ä¼˜èåˆç¤ºä¾‹ï¼ˆçªå‡ºæ˜¾ç¤ºçš„æµ…ç»¿è‰²èƒŒæ™¯çŸ©å½¢ï¼‰ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://github.com/HeKun-NVIDIA/TensorRT-Developer_Guide_in_Chinese/blob/main/7.TensorRT%E4%B8%AD%E7%9A%84INT8/sub-optimal.png"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://github.com/HeKun-NVIDIA/TensorRT-Developer_Guide_in_Chinese/raw/main/7.TensorRT%E4%B8%AD%E7%9A%84INT8/sub-optimal.png"
                      alt="img"
                ></a></p>
<p><strong>å¯¹æ¿€æ´»ä½¿ç”¨é€å¼ é‡é‡åŒ–ï¼›å’Œæ¯ä¸ªé€šé“çš„æƒé‡é‡åŒ–ã€‚è¿™ç§é…ç½®å·²ç»è¢«ç»éªŒè¯æ˜å¯ä»¥å¸¦æ¥æœ€ä½³çš„é‡åŒ–ç²¾åº¦ã€‚</strong></p>
<p>æ‚¨å¯ä»¥é€šè¿‡å¯ç”¨ <code>FP16</code> è¿›ä¸€æ­¥ä¼˜åŒ–å¼•æ“å»¶è¿Ÿã€‚ TensorRT å°½å¯èƒ½å°è¯•ä½¿ç”¨ <code>FP16</code> è€Œä¸æ˜¯ <code>FP32</code>ï¼ˆç›®å‰å¹¶éæ‰€æœ‰å±‚ç±»å‹éƒ½æ”¯æŒï¼‰</p>
<h3 id="Q-x2F-DQ-Limitations"><a href="#Q-x2F-DQ-Limitations" class="headerlink" title="Q&#x2F;DQ Limitations"></a>Q&#x2F;DQ Limitations</h3><p>TensorRT æ‰§è¡Œçš„ä¸€äº› Q&#x2F;DQ å›¾é‡å†™ä¼˜åŒ–æ¯”è¾ƒä¸¤ä¸ªæˆ–å¤šä¸ª Q&#x2F;DQ å±‚ä¹‹é—´çš„é‡åŒ–å°ºåº¦å€¼ï¼Œå¹¶ä¸”ä»…åœ¨æ¯”è¾ƒçš„é‡åŒ–å°ºåº¦ç›¸ç­‰æ—¶æ‰æ‰§è¡Œå›¾é‡å†™ã€‚æ”¹è£…å¯æ”¹è£…çš„ TensorRT å¼•æ“æ—¶ï¼Œå¯ä»¥ä¸º Q&#x2F;DQ èŠ‚ç‚¹çš„å°ºåº¦åˆ†é…æ–°å€¼ã€‚åœ¨ Q&#x2F;DQ å¼•æ“çš„æ”¹è£…æ“ä½œæœŸé—´ï¼ŒTensorRT æ£€æŸ¥æ˜¯å¦ä¸ºå‚ä¸å°ºåº¦ç›¸å…³ä¼˜åŒ–çš„ Q&#x2F;DQ å±‚åˆ†é…äº†ç ´åé‡å†™ä¼˜åŒ–çš„æ–°å€¼ï¼Œå¦‚æœä¸ºçœŸåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>ä¸‹æ¯”è¾ƒ Q1 å’Œ Q2 çš„å°ºåº¦æ˜¯å¦ç›¸ç­‰çš„ç¤ºä¾‹ï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™å…è®¸å®ƒä»¬å‘åä¼ æ’­ã€‚å¦‚æœä½¿ç”¨ Q1 å’Œ Q2 çš„æ–°å€¼å¯¹å¼•æ“è¿›è¡Œæ”¹è£…ï¼Œä½¿å¾—<code>Q1 != Q2</code> ï¼Œåˆ™å¼‚å¸¸ä¸­æ­¢æ”¹è£…è¿‡ç¨‹ã€‚</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230224100753426-168493652323542.png"
                      class="" title="image-20230224100753426"
                >

<h3 id="QAT-Networks-Using-PyTorch"><a href="#QAT-Networks-Using-PyTorch" class="headerlink" title="QAT Networks Using PyTorch"></a>QAT Networks Using PyTorch</h3><p>PyTorch 1.8.0 å’Œå‰ç‰ˆæ”¯æŒ ONNX <a class="link"   target="_blank" rel="noopener" href="https://github.com/onnx/onnx/blob/master/docs/Operators.md#QuantizeLinear" >QuantizeLinear <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> &#x2F; <a class="link"   target="_blank" rel="noopener" href="https://github.com/onnx/onnx/blob/master/docs/Operators.md#dequantizelinear" >DequantizeLinear <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> ï¼Œæ”¯æŒæ¯é€šé“ç¼©æ”¾ã€‚æ‚¨å¯ä»¥ä½¿ç”¨<a class="link"   target="_blank" rel="noopener" href="https://github.com/NVIDIA/TensorRT/tree/main/tools/pytorch-quantization" >pytorch-quantization <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>è¿›è¡Œ INT8 æ ¡å‡†ï¼Œè¿è¡Œé‡åŒ–æ„ŸçŸ¥å¾®è°ƒï¼Œç”Ÿæˆ ONNXï¼Œæœ€åä½¿ç”¨ TensorRT åœ¨æ­¤ ONNX æ¨¡å‹ä¸Šè¿è¡Œæ¨ç†ã€‚</p>
<h1 id="TensorRT-ä¸­çš„åŠ¨æ€å½¢çŠ¶"><a href="#TensorRT-ä¸­çš„åŠ¨æ€å½¢çŠ¶" class="headerlink" title="TensorRT ä¸­çš„åŠ¨æ€å½¢çŠ¶"></a>TensorRT ä¸­çš„åŠ¨æ€å½¢çŠ¶</h1><p><strong>åŠ¨æ€å½¢çŠ¶(Dynamic Shapes)</strong> æ˜¯å»¶è¿ŸæŒ‡å®šéƒ¨åˆ†æˆ–å…¨éƒ¨å¼ é‡ç»´åº¦ç›´åˆ°è¿è¡Œæ—¶çš„èƒ½åŠ›ã€‚åŠ¨æ€å½¢çŠ¶å¯ä»¥é€šè¿‡ C++ å’Œ Python æ¥å£ä½¿ç”¨ã€‚ ä»¥ä¸‹éƒ¨åˆ†æä¾›äº†æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼›ä½†æ˜¯ï¼Œè¿™é‡Œæ¦‚è¿°äº†æ„å»ºå…·æœ‰åŠ¨æ€å½¢çŠ¶çš„å¼•æ“çš„æ­¥éª¤ï¼š</p>
<p>1**.ç½‘ç»œå®šä¹‰ä¸å¾—å…·æœ‰éšå¼æ‰¹æ¬¡ç»´åº¦ã€‚**</p>
<p>é€šè¿‡è°ƒç”¨åˆ›å»ºtensorrt.INetworkDefinition</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create_network(<span class="number">1</span> &lt;&lt; </span><br><span class="line">        <span class="built_in">int</span>(tensorrt.NetworkDefinitionCreationFlag.EXPLICIT_BATCH))		<span class="comment">#è¿™äº›è°ƒç”¨è¦æ±‚ç½‘ç»œæ²¡æœ‰éšå¼æ‰¹å¤„ç†ç»´åº¦ã€‚</span></span><br></pre></td></tr></table></figure></div>

<ol start="2">
<li><code>-1</code>ä½œä¸ºç»´åº¦çš„å ä½ç¬¦æ¥æŒ‡å®šè¾“å…¥å¼ é‡çš„æ¯ä¸ªè¿è¡Œæ—¶ç»´åº¦ã€‚</li>
<li>æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªä¼˜åŒ–é…ç½®æ–‡ä»¶ï¼Œä¸ºå…·æœ‰è¿è¡Œæ—¶ç»´åº¦çš„è¾“å…¥æŒ‡å®šå…è®¸çš„ç»´åº¦èŒƒå›´ï¼Œä»¥åŠè‡ªåŠ¨è°ƒæ•´å™¨å°†ä¼˜åŒ–çš„ç»´åº¦ã€‚</li>
<li>è¦ä½¿ç”¨å¼•æ“ï¼š<ul>
<li>ä»å¼•æ“åˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä¸æ²¡æœ‰åŠ¨æ€å½¢çŠ¶çš„æƒ…å†µç›¸åŒã€‚</li>
<li>æŒ‡å®šæ­¥éª¤ 3 ä¸­æ¶µç›–è¾“å…¥ç»´åº¦çš„ä¼˜åŒ–é…ç½®æ–‡ä»¶ä¹‹ä¸€ã€‚</li>
<li>æŒ‡å®šæ‰§è¡Œä¸Šä¸‹æ–‡çš„è¾“å…¥ç»´åº¦ã€‚è®¾ç½®è¾“å…¥ç»´åº¦åï¼Œæ‚¨å¯ä»¥è·å¾—TensorRTé’ˆå¯¹ç»™å®šè¾“å…¥ç»´åº¦è®¡ç®—çš„è¾“å‡ºç»´åº¦ã€‚</li>
<li>Enqueue workã€‚</li>
</ul>
</li>
</ol>
<h2 id="Specifying-Runtime-Dimensions"><a href="#Specifying-Runtime-Dimensions" class="headerlink" title="Specifying Runtime Dimensions"></a>Specifying Runtime Dimensions</h2><p>æ„å»ºç½‘ç»œæ—¶ï¼Œä½¿ç”¨<code>-1</code>è¡¨ç¤ºè¾“å…¥å¼ é‡çš„è¿è¡Œæ—¶ç»´åº¦ã€‚ä¾‹å¦‚ï¼Œè¦åˆ›å»ºä¸€ä¸ªåä¸º<code>foo</code>çš„ 3D è¾“å…¥å¼ é‡ï¼Œå…¶ä¸­æœ€åä¸¤ä¸ªç»´åº¦åœ¨è¿è¡Œæ—¶æŒ‡å®šï¼Œç¬¬ä¸€ä¸ªç»´åº¦åœ¨æ„å»ºæ—¶å›ºå®šï¼Œè¯·å‘å‡ºä»¥ä¸‹å‘½ä»¤ã€‚</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">network_definition.add_input(&quot;foo&quot;, trt.float32, (3, -1, -1))</span><br></pre></td></tr></table></figure></div>

<p>åœ¨è¿è¡Œæ—¶ï¼Œæ‚¨éœ€è¦åœ¨é€‰æ‹©ä¼˜åŒ–é…ç½®æ–‡ä»¶åè®¾ç½®è¾“å…¥ç»´åº¦ï¼ˆè¯·å‚é˜…<a class="link"   target="_blank" rel="noopener" href="https://docs.nvidia.com/deeplearning/tensorrt/developer-guide/index.html#opt_profiles" >ä¼˜åŒ–é…ç½®æ–‡ä»¶ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>ï¼‰ã€‚è®¾è¾“å…¥<code>foo</code>çš„<code>bindingIndex</code>ä¸º<code>0</code> ï¼Œè¾“å…¥çš„ç»´åº¦ä¸º<code>[3,150,250]</code> ã€‚åœ¨ä¸ºå‰é¢çš„ç¤ºä¾‹è®¾ç½®ä¼˜åŒ–é…ç½®æ–‡ä»¶åï¼Œå°†è°ƒç”¨ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.set_binding_shape(0, (3, 150, 250))</span><br></pre></td></tr></table></figure></div>

<p>åœ¨è¿è¡Œæ—¶ï¼Œå‘å¼•æ“è¯¢é—®ç»‘å®šç»´åº¦ä¼šè¿”å›ç”¨äºæ„å»ºç½‘ç»œçš„ç›¸åŒç»´åº¦ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªè¿è¡Œæ—¶ç»´åº¦éƒ½ä¼šå¾—åˆ°<code>-1</code> ï¼ˆ<strong>åªæŒ‡å®šäº†ä¸ªåˆ«ç»´åº¦ï¼Œå…¶ä»–ç»´åº¦ä¸º-1</strong>ï¼‰ã€‚ä¾‹å¦‚ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">engine.get_binding_shape(<span class="number">0</span>)     <span class="comment"># returns (3, -1, -1)</span></span><br></pre></td></tr></table></figure></div>

<p>è¦è·å–ç‰¹å®šäºæ¯ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡çš„å®é™…ç»´åº¦ï¼Œè¯·æŸ¥è¯¢æ‰§è¡Œä¸Šä¸‹æ–‡ï¼š<strong>ï¼ˆ<em>ä¸Šä¸‹æ–‡</em>,<em>ä¹Ÿå°±æ˜¯æ‰§è¡Œä»»åŠ¡æ‰€éœ€è¦çš„ç›¸å…³ä¿¡æ¯</em>ã€‚è¿™ä¸ªä»»åŠ¡å¯ä»¥æ˜¯ä¸€æ®µä»£ç ,ä¸€ä¸ªçº¿ç¨‹,ä¸€ä¸ªè¿›ç¨‹,ä¸€ä¸ªå‡½æ•°ã€‚ï¼‰</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.get_binding_shape(<span class="number">0</span>)  <span class="comment"># returns (3, 150, 250).</span></span><br></pre></td></tr></table></figure></div>

<p>æ³¨æ„ï¼š<strong>è¾“å…¥çš„<code>setBindingDimensions</code>çš„è¿”å›å€¼ä»…è¡¨æ˜ä¸ä¸ºè¯¥è¾“å…¥è®¾ç½®çš„ä¼˜åŒ–é…ç½®æ–‡ä»¶ç›¸å…³çš„ä¸€è‡´æ€§</strong>ã€‚æŒ‡å®šæ‰€æœ‰è¾“å…¥ç»‘å®šç»´åº¦åï¼Œæ‚¨å¯ä»¥é€šè¿‡æŸ¥è¯¢ç½‘ç»œè¾“å‡ºç»‘å®šçš„ç»´åº¦æ¥æ£€æŸ¥æ•´ä¸ªç½‘ç»œåœ¨åŠ¨æ€è¾“å…¥å½¢çŠ¶æ–¹é¢æ˜¯å¦ä¸€è‡´ã€‚</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nvinfer1::Dims out_dim = context-&gt;getBindingDimensions(out_index);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (out_dim.nbDims == -<span class="number">1</span>) &#123;</span><br><span class="line">gLogError &lt;&lt; <span class="string">&quot;Invalid network output, this might be caused by inconsistent input shapes.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">// abort inference</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="Optimization-Profiles"><a href="#Optimization-Profiles" class="headerlink" title="Optimization Profiles"></a>Optimization Profiles</h2><p>ä¼˜åŒ–é…ç½®æ–‡ä»¶æè¿°äº†æ¯ä¸ªç½‘ç»œè¾“å…¥çš„ç»´åº¦èŒƒå›´ä»¥åŠè‡ªåŠ¨è°ƒè°å™¨å°†ç”¨äºä¼˜åŒ–çš„ç»´åº¦ã€‚<strong>ä½¿ç”¨è¿è¡Œæ—¶ç»´åº¦æ—¶ï¼Œæ‚¨å¿…é¡»åœ¨æ„å»ºæ—¶åˆ›å»ºè‡³å°‘ä¸€ä¸ªä¼˜åŒ–é…ç½®æ–‡ä»¶</strong>ã€‚ä¸¤ä¸ªé…ç½®æ–‡ä»¶å¯ä»¥æŒ‡å®šä¸ç›¸äº¤æˆ–é‡å çš„èŒƒå›´ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¸€ä¸ªé…ç½®æ–‡ä»¶å¯èƒ½æŒ‡å®šæœ€å°å°ºå¯¸<code>[3,100,200]</code> ï¼Œæœ€å¤§å°ºå¯¸<code>[3,200,300]</code>å’Œä¼˜åŒ–å°ºå¯¸<code>[3,150,250]</code>è€Œå¦ä¸€ä¸ªé…ç½®æ–‡ä»¶å¯èƒ½æŒ‡å®šæœ€å°ï¼Œæœ€å¤§å’Œä¼˜åŒ–å°ºå¯¸<code>[3,200,100] ï¼Œ [3,300,400] ï¼Œå’Œ[3,250,250]</code> ã€‚</p>
<p>è¦åˆ›å»ºä¼˜åŒ–é…ç½®æ–‡ä»¶ï¼Œé¦–å…ˆæ„é€ ä¸€ä¸ª<code>IOptimizationProfile</code> ã€‚ç„¶åè®¾ç½®æœ€å°ã€ä¼˜åŒ–å’Œæœ€å¤§ç»´åº¦ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°ç½‘ç»œé…ç½®ä¸­ã€‚ä¼˜åŒ–é…ç½®æ–‡ä»¶å®šä¹‰çš„å½¢çŠ¶å¿…é¡»ä¸ºç½‘ç»œå®šä¹‰æœ‰æ•ˆçš„è¾“å…¥å½¢çŠ¶ã€‚ä»¥ä¸‹æ˜¯å‰é¢æåˆ°çš„ç¬¬ä¸€ä¸ªé…ç½®æ–‡ä»¶å¯¹è¾“å…¥<code>foo</code>çš„è°ƒç”¨ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">profile = builder.create_optimization_profile();</span><br><span class="line">profile.set_shape(<span class="string">&quot;foo&quot;</span>, (<span class="number">3</span>, <span class="number">100</span>, <span class="number">200</span>), (<span class="number">3</span>, <span class="number">150</span>, <span class="number">250</span>), (<span class="number">3</span>, <span class="number">200</span>, <span class="number">300</span>)) </span><br><span class="line">config.add_optimization_profile(profile)</span><br></pre></td></tr></table></figure></div>

<p><strong>åœ¨è¿è¡Œæ—¶ï¼Œæ‚¨éœ€è¦åœ¨è®¾ç½®è¾“å…¥ç»´åº¦ä¹‹å‰è®¾ç½®ä¼˜åŒ–é…ç½®æ–‡ä»¶ã€‚</strong>é…ç½®æ–‡ä»¶æŒ‰ç…§æ·»åŠ çš„é¡ºåºç¼–å·ï¼Œä»0å¼€å§‹ã€‚è¯·æ³¨æ„ï¼Œ<strong>æ¯ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡å¿…é¡»ä½¿ç”¨å•ç‹¬çš„ä¼˜åŒ–é…ç½®æ–‡ä»¶ï¼Œä¸å¯ä»¥åŒæ—¶ä½¿ç”¨</strong>ã€‚ è¦é€‰æ‹©ç¤ºä¾‹ä¸­çš„ç¬¬ä¸€ä¸ªä¼˜åŒ–é…ç½®æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.set_optimization_profile_async(<span class="number">0</span>, stream)   <span class="comment">#å…¶ä¸­streamæ˜¯åœ¨æ­¤ä¸Šä¸‹æ–‡ä¸­ç”¨äºåç»­enqueue()æˆ–enqueueV2()è°ƒç”¨çš„ CUDA æµã€‚</span></span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœå…³è”çš„ CUDA å¼•æ“å…·æœ‰åŠ¨æ€è¾“å…¥ï¼Œåˆ™å¿…é¡»ä½¿ç”¨å”¯ä¸€çš„é…ç½®æ–‡ä»¶ç´¢å¼•è‡³å°‘è®¾ç½®ä¸€æ¬¡ä¼˜åŒ–é…ç½®æ–‡ä»¶ï¼Œè¯¥å”¯ä¸€é…ç½®æ–‡ä»¶ç´¢å¼•æœªè¢«å…¶ä»–æœªé”€æ¯çš„æ‰§è¡Œä¸Šä¸‹æ–‡ä½¿ç”¨ã€‚å¯¹äºä¸ºå¼•æ“åˆ›å»ºçš„ç¬¬ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œéšå¼é€‰æ‹©é…ç½®æ–‡ä»¶ 0ã€‚</p>
<p><strong>å¯ä»¥è°ƒç”¨<code>setOptimizationProfileAsync()</code>åœ¨é…ç½®æ–‡ä»¶ä¹‹é—´åˆ‡æ¢ã€‚</strong>å®ƒå¿…é¡»åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­çš„ä»»ä½•<code>enqueue()</code>æˆ–<code>enqueueV2()</code>æ“ä½œå®Œæˆåè°ƒç”¨ã€‚å½“å¤šä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡åŒæ—¶è¿è¡Œæ—¶ï¼Œå…è®¸åˆ‡æ¢åˆ°ä»¥å‰ä½¿ç”¨ä½†å·²è¢«å…·æœ‰ä¸åŒåŠ¨æ€è¾“å…¥ç»´åº¦çš„å¦ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡é‡Šæ”¾çš„é…ç½®æ–‡ä»¶ã€‚</p>
<p><strong>åœ¨ç”±å¤šä¸ªé…ç½®æ–‡ä»¶æ„å»ºçš„å¼•æ“ä¸­ï¼Œæ¯ä¸ªé…ç½®æ–‡ä»¶éƒ½æœ‰å•ç‹¬çš„ç»‘å®šç´¢å¼•ã€‚</strong>ç¬¬Kä¸ªé…ç½®æ–‡ä»¶çš„è¾“å…¥&#x2F;è¾“å‡ºå¼ é‡çš„åç§°é™„åŠ äº†<code>[profile K]</code> ï¼Œå…¶ä¸­Kä»¥åè¿›åˆ¶è¡¨ç¤ºã€‚ä¾‹å¦‚ï¼Œå¦‚æœ<code>INetworkDefinition</code>çš„åç§°ä¸ºâ€œ <code>foo </code>â€ï¼Œå¹¶ä¸”<code>bindingIndex</code>æŒ‡çš„æ˜¯ä¼˜åŒ–é…ç½®æ–‡ä»¶ä¸­ç´¢å¼•ä¸º<code>3</code>çš„å¼ é‡ï¼Œåˆ™<code>engine.getBindingName ( bindingIndex )</code> è¿”å›â€œ <code>foo [profile 3]</code> â€ã€‚</p>
<p>åŒæ ·ï¼Œå¦‚æœä½¿ç”¨<code>ICudaEngine::getBindingIndex(name)</code>è·å–ç¬¬ä¸€ä¸ªé…ç½®æ–‡ä»¶ ( <code>K=0 </code>) ä¹‹å¤–çš„é…ç½®æ–‡ä»¶ K çš„ç´¢å¼•ï¼Œè¯·å°†â€œ<code>[profile K]</code>â€é™„åŠ åˆ°<code>INetworkDefinition</code>ä¸­ä½¿ç”¨çš„åç§°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¼ é‡åœ¨ <code>INetworkDefinition</code> ä¸­è¢«ç§°ä¸ºâ€œ <code>foo</code> â€ ï¼Œåˆ™<code>engine.getBindingIndex ( â€œ foo [profile 3] â€ )</code><strong>åœ¨ä¼˜åŒ–é…ç½®æ–‡ä»¶<code>3</code>ä¸­è¿”å›å¼ é‡â€œ <code>foo</code>â€çš„ç»‘å®šç´¢å¼•ã€‚</strong>å§‹ç»ˆçœç•¥K&#x3D;0çš„åç¼€ã€‚</p>
<h3 id="Bindings-For-Multiple-Optimization-Profiles"><a href="#Bindings-For-Multiple-Optimization-Profiles" class="headerlink" title="Bindings For Multiple Optimization Profiles"></a>Bindings For Multiple Optimization Profiles</h3><p>è€ƒè™‘ä¸€ä¸ªå…·æœ‰å››ä¸ªè¾“å…¥ã€ä¸€ä¸ªè¾“å‡ºã€åœ¨<code>IBuilderConfig</code>ä¸­å…·æœ‰ä¸‰ä¸ªä¼˜åŒ–é…ç½®æ–‡ä»¶çš„ç½‘ç»œã€‚è¯¥å¼•æ“æœ‰ <code>15</code> ä¸ªç»‘å®šï¼Œæ¯ä¸ªä¼˜åŒ–é…ç½®æ–‡ä»¶æœ‰ <code>5 </code>ä¸ªï¼Œåœ¨æ¦‚å¿µä¸Šç»„ç»‡ä¸ºä¸€ä¸ªè¡¨ï¼š</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230224104755566-168493652323543.png"
                      class="" title="image-20230224104755566"
                >

<p>æ¯è¡Œéƒ½æ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚è¡¨ä¸­çš„æ•°å­—è¡¨ç¤ºç»‘å®šç´¢å¼•ã€‚ç¬¬ä¸€ä¸ªé…ç½®æ–‡ä»¶çš„ç»‘å®šç´¢å¼•ä¸º 0..4ï¼Œç¬¬äºŒä¸ªé…ç½®æ–‡ä»¶ä¸º 5..9ï¼Œç¬¬ä¸‰ä¸ªé…ç½®æ–‡ä»¶ä¸º 10..14ã€‚</p>
<p><strong>å¯¹äºç»‘å®šå±äºç¬¬ä¸€ä¸ªé…ç½®æ–‡ä»¶ä½†æŒ‡å®šäº†å¦ä¸€ä¸ªé…ç½®æ–‡ä»¶çš„æƒ…å†µï¼Œæ¥å£å…·æœ‰â€œè‡ªåŠ¨æ›´æ­£â€åŠŸèƒ½ã€‚</strong>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒTensorRT ä¼šè­¦å‘Šé”™è¯¯ï¼Œç„¶åä»åŒä¸€åˆ—ä¸­é€‰æ‹©æ­£ç¡®çš„ç»‘å®šç´¢å¼•ã€‚</p>
<h2 id="Layer-Extensions-For-Dynamic-Shapes"><a href="#Layer-Extensions-For-Dynamic-Shapes" class="headerlink" title="Layer Extensions For Dynamic Shapes"></a>Layer Extensions For Dynamic Shapes</h2><p><strong>ä¸€äº›å±‚å…·æœ‰å…è®¸æŒ‡å®šåŠ¨æ€å½¢çŠ¶ä¿¡æ¯çš„å¯é€‰è¾“å…¥ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªæ–°å±‚IShapeLayerç”¨äºåœ¨è¿è¡Œæ—¶è®¿é—®å¼ é‡çš„å½¢çŠ¶ã€‚</strong>æ­¤å¤–ï¼Œä¸€äº›å±‚å…è®¸è®¡ç®—æ–°çš„å½¢çŠ¶ã€‚ä¸‹ä¸€èŠ‚å°†è®¨è®ºè¯­ä¹‰ç»†èŠ‚å’Œé™åˆ¶ã€‚ä»¥ä¸‹æ˜¯ä¸åŠ¨æ€å½¢çŠ¶ç»“åˆä½¿ç”¨æ—¶å¯èƒ½æœ‰ç”¨çš„å†…å®¹çš„æ‘˜è¦ã€‚</p>
<p><code>IShapeLayer</code>è¾“å‡ºä¸€ä¸ªåŒ…å«è¾“å…¥å¼ é‡å°ºå¯¸çš„ä¸€ç»´å¼ é‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè¾“å…¥å¼ é‡çš„ç»´åº¦ä¸º<code>[2,3,5,7]</code> ï¼Œåˆ™è¾“å‡ºå¼ é‡æ˜¯åŒ…å«<code>&#123;2,3,5,7&#125;</code>çš„å››å…ƒç´ ä¸€ç»´å¼ é‡ã€‚å¦‚æœè¾“å…¥å¼ é‡æ˜¯æ ‡é‡ï¼Œåˆ™å®ƒçš„ç»´åº¦ä¸º[] ï¼Œè¾“å‡ºå¼ é‡æ˜¯åŒ…å«{}çš„é›¶å…ƒç´ ä¸€ç»´å¼ é‡ã€‚</p>
<p><code>IResizeLayer</code>æ¥å—åŒ…å«æ‰€éœ€è¾“å‡ºå°ºå¯¸çš„å¯é€‰ç¬¬äºŒä¸ªè¾“å…¥ã€‚</p>
<p><code>IShuffleLayer</code>æ¥å—åŒ…å«é‡å¡‘å°ºå¯¸çš„å¯é€‰ç¬¬äºŒä¸ªè¾“å…¥ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ç½‘ç»œå°†å¼ é‡Yé‡å¡‘ä¸ºä¸Xå…·æœ‰ç›¸åŒçš„ç»´åº¦ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reshape = network_definition.add_shuffle(y)</span><br><span class="line">reshape.set_input(1, network_definition.add_shape(X).get_output(0))</span><br></pre></td></tr></table></figure></div>

<p><code>ISliceLayer</code>æ¥å—å¯é€‰çš„ç¬¬äºŒã€ç¬¬ä¸‰å’Œç¬¬å››ä¸ªè¾“å…¥ï¼Œå…¶ä¸­åŒ…å«å¼€å§‹ã€å¤§å°å’Œæ­¥å¹…ã€‚</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IConcatenationLayer, IElementWiseLayer, IGatherLayer, IIdentityLayer, and IReduceLayer</span><br></pre></td></tr></table></figure></div>

<p>å¯ç”¨äºå¯¹å½¢çŠ¶è¿›è¡Œè®¡ç®—å¹¶åˆ›å»ºæ–°çš„å½¢çŠ¶å¼ é‡ã€‚</p>
<h2 id="Restrictions-For-Dynamic-Shapes"><a href="#Restrictions-For-Dynamic-Shapes" class="headerlink" title="Restrictions For Dynamic Shapes"></a>Restrictions For Dynamic Shapes</h2><p>ç”±äºå±‚çš„æƒé‡å…·æœ‰å›ºå®šå¤§å°ï¼Œå› æ­¤ä¼šå‡ºç°ä»¥ä¸‹å±‚é™åˆ¶ï¼š</p>
<ul>
<li><code>IConvolutionLayer</code>å’Œ<code>IDeconvolutionLayer</code>è¦æ±‚é€šé“ç»´åº¦æ˜¯æ„å»ºæ—¶å¸¸æ•°ã€‚</li>
<li><code>IFullyConnectedLayer</code>è¦æ±‚æœ€åä¸‰ä¸ªç»´åº¦æ˜¯æ„å»ºæ—¶å¸¸é‡ã€‚</li>
<li><code>Int8</code>è¦æ±‚é€šé“ç»´åº¦æ˜¯æ„å»ºæ—¶å¸¸æ•°ã€‚</li>
<li>æ¥å—é¢å¤–å½¢çŠ¶è¾“å…¥çš„å±‚ï¼ˆ <code>IResizeLayer</code> ã€ <code>IShuffleLayer</code> ã€ <code>ISliceLayer</code> ï¼‰è¦æ±‚é¢å¤–çš„å½¢çŠ¶è¾“å…¥ä¸æœ€å°å’Œæœ€å¤§ä¼˜åŒ–é…ç½®æ–‡ä»¶çš„å°ºå¯¸ä»¥åŠè¿è¡Œæ—¶æ•°æ®è¾“å…¥çš„å°ºå¯¸å…¼å®¹ï¼›å¦åˆ™ï¼Œå®ƒå¯èƒ½å¯¼è‡´æ„å»ºæ—¶æˆ–è¿è¡Œæ—¶é”™è¯¯ã€‚</li>
</ul>
<p>å¿…é¡»æ˜¯æ„å»ºæ—¶å¸¸é‡çš„å€¼ä¸å¿…æ˜¯ API çº§åˆ«çš„å¸¸é‡ã€‚ TensorRT çš„å½¢çŠ¶åˆ†æå™¨é€šè¿‡è¿›è¡Œå½¢çŠ¶è®¡ç®—çš„å±‚è¿›è¡Œé€ä¸ªå…ƒç´ çš„å¸¸æ•°ä¼ æ’­ã€‚å¸¸é‡ä¼ æ’­å‘ç°ä¸€ä¸ªå€¼æ˜¯æ„å»ºæ—¶å¸¸é‡å°±è¶³å¤Ÿäº†ã€‚</p>
<p>tensorRTæ˜¯NVIDIAå‘å¸ƒçš„DNNæ¨ç†å¼•æ“ï¼Œæ˜¯é’ˆå¯¹NVIDIAç³»åˆ—ç¡¬ä»¶è¿›è¡Œä¼˜åŒ–åŠ é€Ÿï¼Œå®ç°æœ€å¤§ç¨‹åº¦çš„åˆ©ç”¨GPUèµ„æºï¼Œæå‡æ¨ç†æ€§èƒ½</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230220094750628-16849365232331.png"
                      class="" title="image-20230220094750628"
                >

<h1 id="ONNX"><a href="#ONNX" class="headerlink" title="ONNX"></a>ONNX</h1><p>ONNXï¼ˆOpen Neural Network Exchangeï¼‰ï¼ŒONNXæ˜¯å¾®è½¯å’ŒFacebookæå‡ºç”¨æ¥è¡¨ç¤ºæ·±åº¦å­¦ä¹ æ¨¡å‹çš„å¼€æ”¾æ ¼å¼ã€‚æ‰€è°“å¼€æ”¾å°±æ˜¯ONNXå®šä¹‰äº†ä¸€ç»„å’Œç¯å¢ƒï¼Œå¹³å°å‡æ— å…³çš„æ ‡å‡†æ ¼å¼ï¼Œæ¥å¢å¼ºå„ç§AIæ¨¡å‹çš„å¯äº¤äº’æ€§ã€‚</p>
<p>æ¢å¥è¯è¯´ï¼Œæ— è®ºä½ ä½¿ç”¨ä½•ç§è®­ç»ƒæ¡†æ¶è®­ç»ƒæ¨¡å‹ï¼ˆæ¯”å¦‚TensorFlow&#x2F;Pytorch&#x2F;OneFlow&#x2F;Paddleï¼‰ï¼Œ<strong>åœ¨è®­ç»ƒå®Œæ¯•åä½ éƒ½å¯ä»¥å°†è¿™äº›æ¡†æ¶çš„æ¨¡å‹ç»Ÿä¸€è½¬æ¢ä¸ºONNXè¿™ç§ç»Ÿä¸€çš„æ ¼å¼è¿›è¡Œå­˜å‚¨</strong>ã€‚æ³¨æ„ONNXæ–‡ä»¶ä¸ä»…ä»…å­˜å‚¨äº†ç¥ç»ç½‘ç»œæ¨¡å‹çš„æƒé‡ï¼Œ<strong>åŒæ—¶ä¹Ÿå­˜å‚¨äº†æ¨¡å‹çš„ç»“æ„ä¿¡æ¯ä»¥åŠç½‘ç»œä¸­æ¯ä¸€å±‚çš„è¾“å…¥è¾“å‡ºå’Œä¸€äº›å…¶å®ƒçš„è¾…åŠ©ä¿¡æ¯</strong>ã€‚</p>
<p><strong>yolov3-tinyçš„onnxæ¨¡å‹</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230220101057791-16849365232332.png"
                      class="" title="image-20230220101057791"
                >

<p>åœ¨è·å¾—ONNXæ¨¡å‹ä¹‹åï¼Œæ¨¡å‹éƒ¨ç½²äººå‘˜è‡ªç„¶å°±å¯ä»¥å°†è¿™ä¸ªæ¨¡å‹éƒ¨ç½²åˆ°å…¼å®¹ONNXçš„è¿è¡Œç¯å¢ƒä¸­å»ã€‚è¿™é‡Œä¸€èˆ¬è¿˜ä¼šè®¾è®¡åˆ°é¢å¤–çš„æ¨¡å‹è½¬æ¢å·¥ä½œï¼Œå…¸å‹çš„æ¯”å¦‚åœ¨Androidç«¯åˆ©ç”¨NCNNéƒ¨ç½²ONNXæ ¼å¼æ¨¡å‹ï¼Œé‚£ä¹ˆå°±éœ€è¦å°†ONNXåˆ©ç”¨NCNNçš„è½¬æ¢å·¥å…·è½¬æ¢åˆ°NCNNæ‰€æ”¯æŒçš„<code>bin</code>å’Œ<code>param</code>æ ¼å¼ã€‚</p>
<h3 id="ProtoBufç®€ä»‹"><a href="#ProtoBufç®€ä»‹" class="headerlink" title="ProtoBufç®€ä»‹"></a>ProtoBufç®€ä»‹</h3><p>ONNXä½¿ç”¨çš„æ˜¯<strong>Protobuf</strong>è¿™ä¸ªåºåˆ—åŒ–æ•°æ®ç»“æ„å»å­˜å‚¨ç¥ç»ç½‘ç»œçš„æƒé‡ä¿¡æ¯ã€‚Protobufæ˜¯ä¸€ç§è½»ä¾¿é«˜æ•ˆçš„ç»“æ„åŒ–æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œå¯ä»¥ç”¨äºç»“æ„åŒ–æ•°æ®<strong>ä¸²è¡ŒåŒ–</strong>ï¼Œæˆ–è€…è¯´<strong>åºåˆ—åŒ–</strong>ã€‚<strong>å®ƒå¾ˆé€‚åˆåšæ•°æ®å­˜å‚¨æˆ–æ•°æ®äº¤æ¢æ ¼å¼ã€‚</strong>å¯ç”¨äºé€šè®¯åè®®ã€æ•°æ®å­˜å‚¨ç­‰é¢†åŸŸçš„è¯­è¨€æ— å…³ã€å¹³å°æ— å…³ã€å¯æ‰©å±•çš„åºåˆ—åŒ–ç»“æ„æ•°æ®æ ¼å¼ã€‚</p>
<p>Protobufåè®®æ˜¯ä¸€ä¸ªä»¥<code>*.proto</code>åç¼€æ–‡ä»¶ä¸ºåŸºç¡€çš„ï¼Œè¿™ä¸ªæ–‡ä»¶æè¿°äº†ç”¨æˆ·è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„ã€‚ONNXæ˜¯åŸºäºProtobufæ¥åšæ•°æ®å­˜å‚¨å’Œä¼ è¾“ï¼Œé‚£ä¹ˆè‡ªç„¶<code>onnx.proto</code>å°±æ˜¯ONNXæ ¼å¼æ–‡ä»¶äº†</p>
<h3 id="ONNXæ ¼å¼åˆ†æ"><a href="#ONNXæ ¼å¼åˆ†æ" class="headerlink" title="ONNXæ ¼å¼åˆ†æ"></a>ONNXæ ¼å¼åˆ†æ</h3><p>ONNXä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†å°±æ˜¯<code>onnx.proto</code>ï¼ˆ<code>https://github.com/onnx/onnx/blob/master/onnx/onnx.proto</code>ï¼‰è¿™ä¸ªæ–‡ä»¶ï¼Œå®ƒå®šä¹‰äº†ONNXè¿™ä¸ªæ•°æ®åè®®çš„è§„åˆ™å’Œä¸€äº›å…¶å®ƒä¿¡æ¯ã€‚åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢ä»¥<code>message</code>å…³é”®å­—å¼€å¤´çš„å¯¹è±¡æ˜¯æˆ‘ä»¬éœ€è¦å…³å¿ƒçš„ã€‚</p>
<p>å½“æˆ‘ä»¬åŠ è½½äº†ä¸€ä¸ªONNXä¹‹åï¼Œæˆ‘ä»¬è·å¾—çš„å°±æ˜¯ä¸€ä¸ª<code>ModelProto</code>ï¼Œå®ƒåŒ…å«äº†ä¸€äº›ç‰ˆæœ¬ä¿¡æ¯ï¼Œç”Ÿäº§è€…ä¿¡æ¯å’Œä¸€ä¸ª<code>GraphProto</code>ã€‚åœ¨<code>GraphProto</code>é‡Œé¢åˆåŒ…å«äº†å››ä¸ª<code>repeated</code>æ•°ç»„ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯<code>node</code>(<code>NodeProto</code>ç±»å‹)ï¼Œ<code>input</code>(<code>ValueInfoProto</code>ç±»å‹)ï¼Œ<code>output</code>(<code>ValueInfoProto</code>ç±»å‹)å’Œ<code>initializer</code>(<code>TensorProto</code>ç±»å‹)ï¼Œå…¶ä¸­<code>node</code>ä¸­å­˜æ”¾äº†æ¨¡å‹ä¸­æ‰€æœ‰çš„è®¡ç®—èŠ‚ç‚¹ï¼Œ<code>input</code>å­˜æ”¾äº†æ¨¡å‹çš„è¾“å…¥èŠ‚ç‚¹ï¼Œ<code>output</code>å­˜æ”¾äº†æ¨¡å‹ä¸­æ‰€æœ‰çš„è¾“å‡ºèŠ‚ç‚¹ï¼Œ**<code>initializer</code>å­˜æ”¾äº†æ¨¡å‹çš„æ‰€æœ‰æƒé‡å‚æ•°ã€‚**</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230220103617774-16849365232333.png"
                      class="" title="image-20230220103617774"
                >

<p>æˆ‘ä»¬çŸ¥é“è¦å®Œæ•´çš„è¡¨è¾¾ä¸€ä¸ªç¥ç»ç½‘ç»œï¼Œä¸ä»…ä»…è¦çŸ¥é“ç½‘ç»œçš„å„ä¸ªèŠ‚ç‚¹ä¿¡æ¯ï¼Œè¿˜è¦çŸ¥é“å®ƒä»¬çš„æ‹“æ‰‘å…³ç³»ã€‚è¿™ä¸ªæ‹“æ‰‘å…³ç³»åœ¨ONNXä¸­æ˜¯å¦‚ä½•è¡¨ç¤ºçš„å‘¢ï¼ŸONNXçš„æ¯ä¸ªè®¡ç®—èŠ‚ç‚¹éƒ½ä¼šæœ‰<code>input</code>å’Œ<code>output</code>ä¸¤ä¸ªæ•°ç»„ï¼Œè¿™ä¸¤ä¸ªæ•°ç»„æ˜¯stringç±»å‹ï¼Œé€šè¿‡<code>input</code>å’Œ<code>output</code>çš„æŒ‡å‘å…³ç³»ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ä¸Šè¿°ä¿¡æ¯å¿«é€Ÿæ„å»ºå‡ºä¸€ä¸ªæ·±åº¦å­¦ä¹ æ¨¡å‹çš„æ‹“æ‰‘å›¾ã€‚è¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹ï¼Œ**<code>GraphProto</code>ä¸­çš„<code>input</code>æ•°ç»„ä¸ä»…åŒ…å«æˆ‘ä»¬ä¸€èˆ¬ç†è§£ä¸­çš„å›¾ç‰‡è¾“å…¥çš„é‚£ä¸ªèŠ‚ç‚¹ï¼Œè¿˜åŒ…å«äº†æ¨¡å‹ä¸­æ‰€æœ‰çš„æƒé‡ã€‚ï¼ˆæ‰€æœ‰çš„èŠ‚ç‚¹çš„æƒé‡æ˜¯ä¿å­˜åœ¨initializerä¸­çš„ï¼‰**ä¾‹å¦‚ï¼Œ<code>Conv</code>å±‚é‡Œé¢çš„<code>W</code>æƒé‡å®ä½“æ˜¯ä¿å­˜åœ¨<code>initializer</code>ä¸­çš„ï¼Œé‚£ä¹ˆç›¸åº”çš„ä¼šæœ‰ä¸€ä¸ªåŒåçš„è¾“å…¥åœ¨<code>input</code>ä¸­ï¼Œå…¶èƒŒåçš„é€»è¾‘åº”è¯¥æ˜¯æŠŠæƒé‡ä¹Ÿçœ‹æˆæ¨¡å‹çš„è¾“å…¥ï¼Œå¹¶é€šè¿‡<code>initializer</code>ä¸­çš„æƒé‡å®ä½“æ¥å¯¹è¿™ä¸ªè¾“å…¥åšåˆå§‹åŒ–ï¼Œå³ä¸€ä¸ªèµ‹å€¼çš„è¿‡ç¨‹ã€‚</p>
<p>æœ€åï¼Œæ¯ä¸ªè®¡ç®—èŠ‚ç‚¹ä¸­è¿˜åŒ…å«äº†ä¸€ä¸ª<code>AttributeProto</code>æ•°ç»„ï¼Œç”¨æ¥æè¿°è¯¥èŠ‚ç‚¹çš„å±æ€§ï¼Œæ¯”å¦‚<code>Conv</code>èŠ‚ç‚¹æˆ–è€…è¯´å·ç§¯å±‚çš„å±æ€§åŒ…å«<code>group</code>ï¼Œ<code>pad</code>ï¼Œ<code>strides</code>ç­‰ç­‰</p>
<h3 id="onnx-helper"><a href="#onnx-helper" class="headerlink" title="onnx.helper"></a>onnx.helper</h3><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“ONNXæ˜¯æŠŠä¸€ä¸ªç½‘ç»œçš„æ¯ä¸€å±‚æˆ–è€…è¯´ä¸€ä¸ªç®—å­å½“æˆèŠ‚ç‚¹<code>node</code>ï¼Œä½¿ç”¨è¿™äº›<code>Node</code>å»æ„å»ºä¸€ä¸ª<code>Graph</code>ï¼Œå³ä¸€ä¸ªç½‘ç»œã€‚æœ€åå°†<code>Graph</code>å’Œå…¶å®ƒçš„ç”Ÿäº§è€…ä¿¡æ¯ï¼Œç‰ˆæœ¬ä¿¡æ¯ç­‰åˆå¹¶åœ¨ä¸€èµ·ç”Ÿæˆä¸€ä¸ª<code>Model</code>ï¼Œä¹Ÿå³æ˜¯æœ€ç»ˆçš„ONNXæ¨¡å‹æ–‡ä»¶ã€‚ åœ¨æ„å»ºONNXæ¨¡å‹çš„æ—¶å€™ï¼Œ<code>https://github.com/onnx/onnx/blob/master/onnx/helper.py</code>è¿™ä¸ªæ–‡ä»¶éå¸¸é‡è¦ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒæä¾›çš„<code>make_node</code>ï¼Œ<code>make_graph</code>ï¼Œ<code>make_tensor</code>ç­‰ç­‰æ¥å£å®Œæˆä¸€ä¸ªONNXæ¨¡å‹çš„æ„å»ºï¼Œä¸€ä¸ªç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> onnx</span><br><span class="line"><span class="keyword">from</span> onnx <span class="keyword">import</span> helper</span><br><span class="line"><span class="keyword">from</span> onnx <span class="keyword">import</span> AttributeProto, TensorProto, GraphProto</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># The protobuf definition can be found here:</span></span><br><span class="line"><span class="comment"># https://github.com/onnx/onnx/blob/master/onnx/onnx.proto</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create one input (ValueInfoProto)</span></span><br><span class="line">X = helper.make_tensor_value_info(<span class="string">&#x27;X&#x27;</span>, TensorProto.FLOAT, [<span class="number">3</span>, <span class="number">2</span>])</span><br><span class="line">pads = helper.make_tensor_value_info(<span class="string">&#x27;pads&#x27;</span>, TensorProto.FLOAT, [<span class="number">1</span>, <span class="number">4</span>])           <span class="comment">#padding</span></span><br><span class="line"></span><br><span class="line">value = helper.make_tensor_value_info(<span class="string">&#x27;value&#x27;</span>, AttributeProto.FLOAT, [<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create one output (ValueInfoProto)</span></span><br><span class="line">Y = helper.make_tensor_value_info(<span class="string">&#x27;Y&#x27;</span>, TensorProto.FLOAT, [<span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a node (NodeProto) - This is based on Pad-11</span></span><br><span class="line">node_def = helper.make_node(</span><br><span class="line">    <span class="string">&#x27;Pad&#x27;</span>, <span class="comment"># node name</span></span><br><span class="line">    [<span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;pads&#x27;</span>, <span class="string">&#x27;value&#x27;</span>], <span class="comment"># inputs</span></span><br><span class="line">    [<span class="string">&#x27;Y&#x27;</span>], <span class="comment"># outputs</span></span><br><span class="line">    mode=<span class="string">&#x27;constant&#x27;</span>, <span class="comment"># attributes</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the graph (GraphProto)</span></span><br><span class="line">graph_def = helper.make_graph(</span><br><span class="line">    [node_def],</span><br><span class="line">    <span class="string">&#x27;test-model&#x27;</span>,</span><br><span class="line">    [X, pads, value],</span><br><span class="line">    [Y],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the model (ModelProto)</span></span><br><span class="line">model_def = helper.make_model(graph_def, producer_name=<span class="string">&#x27;onnx-example&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;The model is:\n&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(model_def))</span><br><span class="line">onnx.checker.check_model(model_def)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;The model is checked!&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p><strong>è¾“å…¥æ•°æ®æ˜¯ä¸€ä¸ªä¸€ç»´Tensorï¼Œåˆå§‹ç»´åº¦ä¸º<code>[2]</code>ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç»è¿‡ç»´åº¦ä¸º<code>[1,4]</code>çš„Padæ“ä½œä¹‹åè·å¾—çš„è¾“å‡ºTensorç»´åº¦ä¸º<code>[3,4]</code>ã€‚</strong>ä¸Šä¾‹ä¸­çš„Padæ“ä½œæ˜¯æ²¡æœ‰å¸¦ä»»ä½•æƒé‡ä¿¡æ¯çš„ï¼Œæ‰€ä»¥å½“ä½ æ‰“å°ONNXæ¨¡å‹æ—¶ï¼Œ<code>ModelProto</code>çš„<code>GraphProto</code>æ˜¯æ²¡æœ‰<code>initializer</code>è¿™ä¸ªå±æ€§çš„ã€‚</p>
<h1 id="è°ƒç”¨TensorRTçš„æ–¹æ¡ˆ"><a href="#è°ƒç”¨TensorRTçš„æ–¹æ¡ˆ" class="headerlink" title="è°ƒç”¨TensorRTçš„æ–¹æ¡ˆ"></a>è°ƒç”¨TensorRTçš„æ–¹æ¡ˆ</h1><p><strong>åŸºäºC++</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221082244538-16849365232334.png"
                      class="" title="image-20230221082244538"
                >

<p><strong>åŸºäºpython</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221082316063-16849365232335.png"
                      class="" title="image-20230221082316063"
                >

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221082544827-16849365232336.png"
                      class="" title="image-20230221082544827"
                >

<p><strong>repo1</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221083048073-16849365232337.png"
                      class="" title="image-20230221083048073"
                >

<p>ä½¿ç”¨ä½œè€…å®šä¹‰çš„gen_wts.pyå‚¨å­˜æƒé‡ï¼Œä½¿ç”¨C++ç¡¬ä»£ç è°ƒç”¨TensorRTåŸºäºC++çš„apiæ„å»ºæ¨¡å‹ç»“æ„ï¼ŒåŠ è½½gen_wts.pyäº§ç”Ÿçš„æƒé‡ç»„æˆå®Œæ•´æ¨¡å‹</p>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å¯ä»¥æ§åˆ¶æ¯ä¸ªlayerçš„ç»†èŠ‚å’Œæƒé‡ï¼Œç›´æ¥é¢å¯¹TensorRTçš„api</li>
<li>è¿™ç§æ–¹æ¡ˆä¸å­˜åœ¨ç®—å­é—®é¢˜ï¼Œå¦‚æœå­˜åœ¨ä¸æ”¯æŒçš„ç®—å­ï¼Œå¯ä»¥è‡ªè¡Œå¢åŠ æ’ä»¶ï¼Œçµæ´»æ€§æœ€é«˜</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ–°æ¨¡å‹éœ€è¦ä¸€ä¸ªlayerä¸€ä¸ªlayerå†™ï¼Œä¸å…·æœ‰é€šç”¨æ€§</li>
<li>ä½œè€…æä¾›çš„æ¨ç†ä»£ç æ˜¯demoçº§ï¼Œä½¿ç”¨é˜¶æ®µéœ€è¦ä¿®æ”¹å¤ªå¤š</li>
<li>éƒ¨ç½²æ—¶æ— æ³•æŸ¥çœ‹ç½‘ç»œç»“æ„è¿›è¡Œåˆ†æå’Œæ’æŸ¥</li>
</ul>
<p><strong>repo2</strong></p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221085107849-16769406687161-16849365232338.png"
                      class="" title="image-20230221085107849"
                >

<p>åŸºäºPytorchçš„ç®—å­ï¼Œä¸ºæ¯ä¸ªç®—å­å†™Converterï¼Œä¸ºæ¯ä¸ªæ“ä½œçš„forwardåå°„åˆ°è‡ªå®šä¹‰å‡½æ•°ï¼›é€šè¿‡åå°„torchçš„forwardæ“ä½œæ•è·æ¨¡å—çš„æƒé‡ï¼Œè°ƒç”¨python apiå®ç°æ¨¡å‹åˆ›å»º</p>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>ç›´æ¥é›†æˆpythonã€pytorchã€å¯ä»¥å®ç°pytorchæ¨¡å‹åˆ°tensorRTæ¨¡å‹çš„ç®€å•è½¬æ¢</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ— C++æ–¹æ¡ˆ</li>
<li>æ–°çš„ç®—å­éœ€è¦è‡ªå·±å®ç°Converterï¼Œéœ€è¦ç»´æŠ¤æ–°çš„ç®—å­åº“</li>
<li>è·¨è®¾å¤‡éœ€è¦é‡æ–°å®‰è£…pytorchï¼Œçµæ´»åº¦ä¸åˆ©äºéƒ¨ç½²</li>
<li>éƒ¨ç½²æ—¶æ— æ³•æŸ¥çœ‹ç½‘ç»œç»“æ„è¿›è¡Œåˆ†æå’Œæ’æŸ¥</li>
</ul>
<p><strong>repo3ï¼ˆæ¨èï¼‰</strong></p>
<p>åŸºäºONNXè·¯çº¿ï¼Œæä¾›C++ã€Pythonæ¥å£ï¼Œæ·±åº¦å®šåˆ¶ONNXParrserï¼Œä½è€¦åˆå°è£…ï¼Œå®ç°å¸¸ç”¨æ¨¡å‹YoloXã€YoloV5ã€RetinaFaceã€Arcfaceã€SCRFDã€DeepSORTç®—å­ç”±å®˜æ–¹ç»´æŠ¤ï¼Œæ¨¡å‹ç›´æ¥å¯¼å‡º</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221090526167-16849365232339.png"
                      class="" title="image-20230221090526167"
                >

<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>é›†æˆå·¥ä¸šçº§æ¨ç†æ–¹æ¡ˆã€æ”¯æŒtensorRTä»æ¨¡å‹å¯¼å‡ºåˆ°åº”ç”¨åˆ°é¡¹ç›®ä¸­çš„å…¨éƒ¨å·¥ä½œ</li>
<li>æ¡ˆä¾‹æœ‰YoloV5ç­‰ï¼Œæ¯ä¸ªåº”ç”¨å‡ä¸ºé«˜æ€§èƒ½å·¥ä¸šçº§ä½¿ç”¨</li>
<li>å…·æœ‰ç®€å•çš„æ¨¡å‹å¯¼å‡ºæ–¹æ³•å’ŒONNXé—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œå°è£…tensorRTç»†èŠ‚ï¼Œæ”¯æŒæ’ä»¶</li>
<li>æ”¯æŒpythonæ¥å£å¯¼å‡ºæ¨¡å‹å’Œæ¨ç†æ¥å£</li>
</ul>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221090939235-168493652323310.png"
                      class="" title="image-20230221090939235"
                >

<h1 id="å¯¼å‡ºONNXæ³¨æ„çš„é—®é¢˜"><a href="#å¯¼å‡ºONNXæ³¨æ„çš„é—®é¢˜" class="headerlink" title="å¯¼å‡ºONNXæ³¨æ„çš„é—®é¢˜"></a>å¯¼å‡ºONNXæ³¨æ„çš„é—®é¢˜</h1><ol>
<li>å¯¹äºä»»ä½•ç”¨åˆ°shapeã€sizeè¿”å›å€¼å‚æ•°æ—¶ï¼Œä¸ºäº†é¿å…shapeã€sizeçš„è·Ÿè¸ªï¼Œäº§ç”Ÿé¢å¤–çš„æ•°å€¼ï¼ŒåŠ ä¸Šintè½¬æ¢ã€‚å¦‚<code> tensor.view(tensor,size(0),-1)</code></li>
<li>å¯¹äºnn.Upsampleæˆ–nn.functional.interpolateå‡½æ•°ï¼Œä½¿ç”¨<strong>scale_factor</strong>æŒ‡å®šå€ç‡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨sizeå‚æ•°æŒ‡å®šå¤§å°</li>
<li>å¯¹äºreshapeã€viewæ“ä½œæ—¶ï¼Œ-1çš„æŒ‡å®šè¦æ”¾åˆ°batchç»´åº¦ï¼Œå…¶ä»–ç»´åº¦å¯ä»¥ç›´æ¥è®¡ç®—ã€‚batchç»´åº¦ç¦æ­¢æŒ‡å®šä¸ºå¤§äº-1çš„æ˜ç¡®æ•°å­—</li>
<li>torch.onnx.exportæŒ‡å®šdynamic_axeså‚æ•°ï¼Œå¹¶ä¸”åªæŒ‡å®šbatchç»´åº¦ï¼Œä¸æŒ‡å®šå…¶ä»–ç»´åº¦ã€‚</li>
</ol>
<p>è¿™äº›åšæ³•çš„å¿…è¦æ€§ä½“ç°åœ¨ï¼Œç®€åŒ–è¿‡ç¨‹çš„å¤æ‚åº¦ï¼Œå»æ‰gatherã€shapeç±»çš„èŠ‚ç‚¹</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221092555385-168493652323411.png"
                      class="" title="image-20230221092555385"
                >

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221092623949-168493652323412.png"
                      class="" title="image-20230221092623949"
                >

<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221092806781-168493652323413.png"
                      class="" title="image-20230221092806781"
                >

<h1 id="åŠ¨æ€batchå’ŒåŠ¨æ€å®½é«˜"><a href="#åŠ¨æ€batchå’ŒåŠ¨æ€å®½é«˜" class="headerlink" title="åŠ¨æ€batchå’ŒåŠ¨æ€å®½é«˜"></a>åŠ¨æ€batchå’ŒåŠ¨æ€å®½é«˜</h1><p><strong>åŠ¨æ€batch</strong></p>
<p>æºè‡ªtensorRTç¼–è¯‘æ—¶å¯¹batchçš„å¤„ç†ï¼Œé™æ€batchè¡¨ç¤ºæ— è®ºæœ‰å¤šå°‘å¼ å›¾ï¼Œéƒ½æŒ‰ç…§å›ºå®šå¤§å°batchæ¨ç†ï¼Œè€—æ—¶æ˜¯å›ºå®šçš„</p>
<ol>
<li>å¯¼å‡ºæ¨¡å‹æ—¶ï¼Œæ³¨æ„viewæ“ä½œä¸èƒ½å›ºå®šbatchç»´åº¦æ•°å€¼ï¼Œé€šå¸¸å†™-1</li>
<li>å¯¼å‡ºæ¨¡å‹æ—¶ï¼Œé€šå¸¸å¯ä»¥æŒ‡å®šdynamic_axesï¼ˆå¯ä»¥ä¸æŒ‡å®šï¼‰</li>
</ol>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221095444973-168493652323414.png"
                      class="" title="image-20230221095444973"
                >

<p><strong>åŠ¨æ€å®½é«˜</strong></p>
<p>ONNXå¯¼å‡ºæ—¶æŒ‡å®šçš„å®½é«˜æ˜¯å›ºå®šçš„ï¼ŒTRTç¼–è¯‘æ—¶ä¹Ÿå¾—åˆ°å›ºå®šå¤§å°å¼•æ“ï¼ŒåŠ¨æ€å®½é«˜å¯ä»¥å¾—åˆ°å¤§å°ä¸åŒçš„å¼•æ“ï¼ˆä¸€ä¸ªå¼•æ“æœ€å¥½å¯¹åº”ä¸€é’Ÿåˆ†è¾¨ç‡çš„å›¾ç‰‡ï¼‰ã€‚è€Œä½¿ç”¨TRTçš„åŠ¨æ€å®½é«˜ä¼šå¸¦æ¥å¤ªå¤šä¸å¿…è¦çš„å¤æ‚åº¦ï¼Œä½¿ç”¨ä¸­é—´æ–¹æ¡ˆï¼Œç¼–è¯‘æ—¶ä¿®æ”¹ONNXè¾“å…¥å®ç°ç›¸å¯¹åŠ¨æ€</p>
<ol>
<li>ä¸å»ºè®®æ”¹å˜batch_size</li>
<li>éœ€è¦ä¿®æ”¹ONNXçš„è¾“å…¥shape<ul>
<li>ä½¿ç”¨TRT::compileå‡½æ•°çš„inputDimsSetupå‚æ•°é‡å®šä¹‰è¾“å…¥çš„shape</li>
<li>ä½¿ç”¨TRT::set_layer_hook_reshapeé’©å­åŠ¨æ€ä¿®æ”¹reshapeçš„å‚æ•°å®ç°é€‚é…</li>
</ul>
</li>
</ol>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221095945685-168493652323415.png"
                      class="" title="image-20230221095945685"
                >

<p>ä¿®æ”¹ONNXçš„è¾“å…¥åï¼Œå…¶ä¸­çš„reshapeä¼šå—åˆ°æ–°çš„å®½åº¦è€Œæ”¹å˜ï¼Œé€šè¿‡hooké’©å­ä¿®å‡½reshapeçš„å‚æ•°ï¼Œå®ç°ç›¸å¯¹åŠ¨æ€</p>
<h1 id="å®ç°ä¸€ä¸ªè‡ªå®šä¹‰æ’ä»¶"><a href="#å®ç°ä¸€ä¸ªè‡ªå®šä¹‰æ’ä»¶" class="headerlink" title="å®ç°ä¸€ä¸ªè‡ªå®šä¹‰æ’ä»¶"></a>å®ç°ä¸€ä¸ªè‡ªå®šä¹‰æ’ä»¶</h1><p>å¯¼å‡ºç¯èŠ‚ï¼š</p>
<ol>
<li>å¯¹äºéœ€è¦æ’ä»¶çš„layerï¼Œåˆ›å»ºä¸€ä¸ªç±»Aç»§æ‰¿è‡ªtorch.autograd.Function</li>
<li>ç±»Aå¢åŠ symbolicé™æ€æ–¹æ³•ï¼Œå…¶ä¸­è¿”å›g.op()ï¼Œåç§°ä¸ºPlugin_name_sæ’ä»¶åç§°ï¼Œinfoå¯ä»¥å¸¦ä¸Šstringç±»å‹ä¿¡æ¯</li>
<li>ä¸ºç±»Aå¢åŠ forwardé™æ€æ–¹æ³•ï¼Œæ­¤æ—¶çš„forwardçš„ä»»ä½•æ“ä½œä¸ä¼šè·Ÿè¸ªå¹¶è®°å½•åˆ°ONNXä¸­</li>
<li>å®ç°ä¸€ä¸ªOPç±»ï¼Œç»§æ‰¿è‡ªnn.Moduleï¼Œåœ¨OP.forwardä¸­è°ƒç”¨A.apply</li>
<li>å°†OPé›†æˆåˆ°æ¨¡å‹ä¸­</li>
</ol>
<p>ç¼–è¯‘&#x2F;æ¨ç†ç¯èŠ‚ï¼š</p>
<ol>
<li>åœ¨Pluginsæ–‡ä»¶å¤¹ä¸­æ–°å»ºcuå’Œhppæ–‡ä»¶</li>
<li>å†™è‡ªå®šä¹‰configï¼Œç”¨äºé…ç½®æ”¯æŒçš„æ•°æ®ç±»å‹ç­‰</li>
<li>å®ç°ç±»ç»§æ‰¿è‡ªTRTPluginï¼Œä¸»è¦å®ç°configç”¨äºè¿”å›è‡ªå®šä¹‰configç±»ã€getOutputDimensionsè¿”å›layerå¤„ç†åçš„tensorå¤§å°</li>
<li>enqueueå®ç°æ¨ç†å·¥ä½œ</li>
</ol>
<h1 id="å°è£…"><a href="#å°è£…" class="headerlink" title="å°è£…"></a>å°è£…</h1><h2 id="Tensorå°è£…"><a href="#Tensorå°è£…" class="headerlink" title="Tensorå°è£…"></a><strong>Tensorå°è£…</strong></h2><p><strong>å®ç°å¼ é‡çš„å†…å­˜ç®¡ç†ã€ç»´åº¦ç®¡ç†ã€åç§»é‡è®¡ç®—ã€cpu&#x2F;gpuç›¸äº’è‡ªåŠ¨æ‹·è´ã€‚é¿å…æ‰‹åŠ¨ç®¡ç†å†…å­˜ã€è®¡ç®—åç§»é‡</strong></p>
<ol>
<li>CPU&#x2F;GPUå†…å­˜è‡ªåŠ¨åˆ†é…é‡Šæ”¾ï¼Œå†…å­˜å¤ç”¨ã€‚Tensorä½¿ç”¨MixMemoryç®¡ç†å†…å­˜</li>
</ol>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221105750138-168493652323416.png"
                      class="" title="image-20230221105750138"
                >

<ol start="2">
<li>CPU&#x2F;GPUä¹‹é—´è‡ªåŠ¨å†…å­˜å¤åˆ¶</li>
</ol>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221110212885-168493652323417.png"
                      class="" title="image-20230221110212885"
                >

<ol start="3">
<li>è®¡ç®—ç»´åº¦çš„åç§»é‡</li>
</ol>
 <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221141202162-168493652323418.png"
                      class="" title="image-20230221141202162"
                >

<h2 id="Builderå°è£…"><a href="#Builderå°è£…" class="headerlink" title="Builderå°è£…"></a>Builderå°è£…</h2><p><strong>å®ç°onnxåˆ°å¼•æ“è½¬æ¢çš„å°è£…ï¼Œint8å°è£…ï¼Œå°‘æ•°å‡ è¡Œä»£ç å®ç°éœ€æ±‚</strong></p>
<ol>
<li><p>æ¨¡å‹ç¼–è¯‘æ¥å£</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221141607655-168493652323419.png"
                      class="" title="image-20230221141607655"
                >
</li>
<li><p>Int8 Calibratoræ•°æ®å¤„ç†ï¼šInt8ä¼šå‹ç¼©æƒé‡è¿›è¡Œå‚¨å­˜ï¼Œé€šè¿‡Calibratoræ•°æ®å¤„ç†å°±ä¼šå¾—åˆ°ç›¸åº”çš„æƒé‡</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221141916977-168493652323420.png"
                      class="" title="image-20230221141916977"
                >
</li>
<li><p>æ’ä»¶å¤„ç†ï¼Œè‡ªå®šä¹‰æ’ä»¶æ”¯æŒ</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221142034328-168493652323421.png"
                      class="" title="image-20230221142034328"
                >
</li>
<li><p>ç‰¹æ®Šå¤„ç†ï¼Œreshapeé’©å­ï¼Œå®šåˆ¶onnxçš„è¾“å…¥èŠ‚ç‚¹shape</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/02/20/TensorRT/image-20230221142046759-168493652323422.png"
                      class="" title="image-20230221142046759"
                ></li>
</ol>
<h2 id="Inferå°è£…"><a href="#Inferå°è£…" class="headerlink" title="Inferå°è£…"></a>Inferå°è£…</h2><p><strong>å®ç°tensorRTå¼•æ“çš„æ¨ç†ç®¡ç†ï¼Œè‡ªåŠ¨å…³è”å¼•æ“çš„è¾“å…¥è¾“å‡ºæˆ–è€…æ˜ å°„ï¼Œç®¡ç†ä¸Šä¸‹æ–‡ï¼Œæ’ä»¶</strong></p>
<ol>
<li>æŠ½è±¡inputå’Œoutputå…³ç³»ï¼Œé¿å…æ‰‹åŠ¨å»æ“ä½œbinding</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image-20230221142725737-168493652323423.png"
                      alt="image-20230221142725737"
                ></p>

            </div>

            
                <div class="post-copyright-info">
                    <div class="article-copyright-info-container">
    <ul>
        <li><strong>æ ‡é¢˜:</strong> TensorRT</li>
        <li><strong>ä½œè€…:</strong> Airex Yu</li>
        <li><strong>åˆ›å»ºäº:</strong> 2023-02-20 13:39:03</li>
        
            <li>
                <strong>æ›´æ–°äº:</strong> 2023-05-30 22:00:08
            </li>
        
        <li>
            <strong>é“¾æ¥:</strong> http://example.com/2023/02/20/TensorRT/
        </li>
        <li>
            <strong>ç‰ˆæƒå£°æ˜:</strong> æœ¬æ–‡ç« é‡‡ç”¨ <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a> è¿›è¡Œè®¸å¯ã€‚
        </li>
    </ul>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/ONNX/">#ONNX</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/TensorRT/">#TensorRT</a>&nbsp;
                        </li>
                    
                </ul>
            

            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="/2023/02/20/GPU%E7%BC%96%E7%A8%8B/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">GPUç¼–ç¨‹</span>
                                    <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="/2023/02/06/opencv/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">opencv</span>
                                    <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
                <div class="comment-container">
                    <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fa-solid fa-comments"></i>&nbsp;è¯„è®º
    </div>
    

        
            
 
    <div id="waline"></div>
    <script type="module"  data-pjax>
        import { init } from 'https://evan.beee.top/js/waline.mjs';

        function loadWaline() {
            init({
                el: '#waline',
                serverURL: 'https://example.example.com',
                lang: 'zh-CN',
                dark: 'body[class~="dark-mode"]',
                requiredMeta: ['nick','mail'], // cannot customize by theme config, change it yourself
            });
        }

        if ('true') {
            const loadWalineTimeout = setTimeout(() => {
                loadWaline();
                clearTimeout(loadWalineTimeout);
            }, 1000);
        } else {
            window.addEventListener('DOMContentLoaded', loadWaline);
        }
        
    </script>



        
    
</div>

                </div>
            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">æ­¤é¡µç›®å½•</div>
        <div class="page-title">TensorRT</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#TensorRT"><span class="nav-text">TensorRT</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#TensorRT%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-text">TensorRTæ˜¯ä»€ä¹ˆ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%AD%E7%BB%83%E5%92%8C%E6%8E%A8%E7%90%86"><span class="nav-text">è®­ç»ƒå’Œæ¨ç†</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TensorRT%E5%8A%A0%E9%80%9F%E5%8E%9F%E7%90%86"><span class="nav-text">TensorRTåŠ é€ŸåŸç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%82%E9%97%B4%E8%9E%8D%E5%90%88%E6%88%96%E5%BC%A0%E9%87%8F%E8%9E%8D%E5%90%88%EF%BC%88Layer-amp-Tensor-Fusion%EF%BC%89"><span class="nav-text">å±‚é—´èåˆæˆ–å¼ é‡èåˆï¼ˆLayer&amp;Tensor Fusionï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%B2%BE%E5%BA%A6%E6%A0%A1%E5%87%86"><span class="nav-text">æ•°æ®ç²¾åº¦æ ¡å‡†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kernel-Auto-Tuning"><span class="nav-text">Kernel Auto-Tuning</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dynamic-Tensor-Memory"><span class="nav-text">Dynamic Tensor Memory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Multi-Stream-Execution"><span class="nav-text">Multi-Stream Execution</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TensorRT%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="nav-text">TensorRTä½¿ç”¨æµç¨‹</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AF%BC%E5%87%BAONNX%E6%A8%A1%E5%9E%8B"><span class="nav-text">å¯¼å‡ºONNXæ¨¡å‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BC%E5%87%BAonnx%E6%96%87%E4%BB%B6"><span class="nav-text">å¯¼å‡ºonnxæ–‡ä»¶</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TensorRT%E6%8E%A8%E7%90%86%E9%98%B6%E6%AE%B5"><span class="nav-text">TensorRTæ¨ç†é˜¶æ®µ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#trtexec-exe%E5%AE%9E%E7%8E%B0%E9%A2%84%E6%8E%A8%E7%90%86%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="nav-text">trtexec.exeå®ç°é¢„æ¨ç†ï¼ˆæ¨èï¼‰</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#python%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%E9%A2%84%E6%8E%A8%E7%90%86"><span class="nav-text">pythonä»£ç å®ç°é¢„æ¨ç†</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TensorRt%E9%83%A8%E7%BD%B2%E9%98%B6%E6%AE%B5"><span class="nav-text">TensorRtéƒ¨ç½²é˜¶æ®µ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TensorRT%E5%AE%9E%E7%8E%B0batch%E6%89%B9%E5%A4%84%E7%90%86"><span class="nav-text">TensorRTå®ç°batchæ‰¹å¤„ç†</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BC%E5%87%BAONNX"><span class="nav-text">å¯¼å‡ºONNX</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E6%9E%84%E9%80%A0%E9%98%B6%E6%AE%B5"><span class="nav-text">æ¨¡å‹æ„é€ é˜¶æ®µ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E9%98%B6%E6%AE%B5"><span class="nav-text">æ‰§è¡Œé˜¶æ®µ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TensorRT%E5%AE%98%E6%A1%A3%E4%BB%8B%E7%BB%8D"><span class="nav-text">TensorRTå®˜æ¡£ä»‹ç»</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Programming-Model"><span class="nav-text">The Programming Model</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#The-Runtime-Phase"><span class="nav-text">The Runtime Phase</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Plugins"><span class="nav-text">Plugins</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Types-and-Precision"><span class="nav-text">Types and Precision</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Quantization"><span class="nav-text">Quantization</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tensors-and-Data-Formats"><span class="nav-text">Tensors and Data Formats</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dynamic-Shapes"><span class="nav-text">Dynamic Shapes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DLA"><span class="nav-text">DLA</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Updating-Weights"><span class="nav-text">Updating Weights</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B7%A5%E5%85%B7"><span class="nav-text">å·¥å…·</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#trtexec"><span class="nav-text">trtexec</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Polygraphy"><span class="nav-text">Polygraphy</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TensorRT%E7%9A%84C-%E6%8E%A5%E5%8F%A3%E8%A7%A3%E6%9E%90"><span class="nav-text">TensorRTçš„C++æ¥å£è§£æ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Build-Phase"><span class="nav-text">The Build Phase</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-a-Network-Definition"><span class="nav-text">Creating a Network Definition</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Importing-a-Model-using-the-ONNX-Parser"><span class="nav-text">Importing a Model using the ONNX Parser</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Building-an-Engine"><span class="nav-text">Building an Engine</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Deserializing-a-Plan"><span class="nav-text">Deserializing a Plan</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performing-Inference"><span class="nav-text">Performing Inference</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TensorRT-%E7%9A%84-Python-%E6%8E%A5%E5%8F%A3%E8%A7%A3%E6%9E%90"><span class="nav-text">TensorRT çš„ Python æ¥å£è§£æ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Build-Phase-1"><span class="nav-text">The Build Phase</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-a-Network-Definition-in-Python"><span class="nav-text">Creating a Network Definition in Python</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Importing-a-Model-using-the-ONNX-Parser-1"><span class="nav-text">Importing a Model using the ONNX Parser</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Building-an-Engine-1"><span class="nav-text">Building an Engine</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Performing-Inference-1"><span class="nav-text">Performing Inference</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TensorRT%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C"><span class="nav-text">TensorRTå¦‚ä½•å·¥ä½œ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Object-Lifetimes"><span class="nav-text">Object Lifetimes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Error-Handling-and-Logging"><span class="nav-text">Error Handling and Logging</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Memory"><span class="nav-text">Memory</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#The-Build-Phase-2"><span class="nav-text">The Build Phase</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-Runtime-Phase-1"><span class="nav-text">The Runtime Phase</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Threading"><span class="nav-text">Threading</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Determinism"><span class="nav-text">Determinism</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TensorRT-%E8%BF%9B%E9%98%B6%E7%94%A8%E6%B3%95"><span class="nav-text">TensorRT è¿›é˜¶ç”¨æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Timing-Cache"><span class="nav-text">The Timing Cache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Refitting-An-Engine"><span class="nav-text">Refitting An Engine</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Algorithm-Selection-and-Reproducible-Builds"><span class="nav-text">Algorithm Selection and Reproducible Builds</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Creating-A-Network-Definition-From-Scratch"><span class="nav-text">Creating A Network Definition From Scratch</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Python"><span class="nav-text">Python</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reduced-Precision"><span class="nav-text">Reduced Precision</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Network-level-Control-of-Precision"><span class="nav-text">Network-level Control of Precision</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Layer-level-Control-of-Precision"><span class="nav-text">Layer-level Control of Precision</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Enabling-TF32-Inference-Using-C"><span class="nav-text">Enabling TF32 Inference Using C++</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#I-x2F-O-Formats"><span class="nav-text">I&#x2F;O Formats</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Compatibility-of-Serialized-Engines"><span class="nav-text">Compatibility of Serialized Engines</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Explicit-vs-Implicit-Batch"><span class="nav-text">Explicit vs Implicit Batch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sparsity"><span class="nav-text">Sparsity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Empty-Tensors"><span class="nav-text">Empty Tensors</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reusing-Input-Buffers"><span class="nav-text">Reusing Input Buffers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Engine-Inspector"><span class="nav-text">Engine Inspector</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Quantization-1"><span class="nav-text">Quantization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Quantization-Workflows"><span class="nav-text">Quantization Workflows</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Explicit-vs-Implicit-Quantization"><span class="nav-text">Explicit vs Implicit Quantization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Per-Tensor-and-Per-Channel-Quantization"><span class="nav-text">Per-Tensor and Per-Channel Quantization</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Setting-Dynamic-Range"><span class="nav-text">Setting Dynamic Range</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Post-Training-Quantization-using-Calibration"><span class="nav-text">Post-Training Quantization using Calibration</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Calibration-Using-Python"><span class="nav-text">Calibration Using Python</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Explicit-Quantization"><span class="nav-text">Explicit Quantization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Quantized-Weights"><span class="nav-text">Quantized Weights</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ONNX-Support"><span class="nav-text">ONNX Support</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TensorRT-Processing-Of-Q-x2F-DQ-Networks"><span class="nav-text">TensorRT Processing Of Q&#x2F;DQ Networks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Q-x2F-DQ-Layer-Placement-Recommendations"><span class="nav-text">Q&#x2F;DQ Layer-Placement Recommendations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Q-x2F-DQ-Limitations"><span class="nav-text">Q&#x2F;DQ Limitations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#QAT-Networks-Using-PyTorch"><span class="nav-text">QAT Networks Using PyTorch</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TensorRT-%E4%B8%AD%E7%9A%84%E5%8A%A8%E6%80%81%E5%BD%A2%E7%8A%B6"><span class="nav-text">TensorRT ä¸­çš„åŠ¨æ€å½¢çŠ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Specifying-Runtime-Dimensions"><span class="nav-text">Specifying Runtime Dimensions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Optimization-Profiles"><span class="nav-text">Optimization Profiles</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Bindings-For-Multiple-Optimization-Profiles"><span class="nav-text">Bindings For Multiple Optimization Profiles</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Layer-Extensions-For-Dynamic-Shapes"><span class="nav-text">Layer Extensions For Dynamic Shapes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Restrictions-For-Dynamic-Shapes"><span class="nav-text">Restrictions For Dynamic Shapes</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ONNX"><span class="nav-text">ONNX</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ProtoBuf%E7%AE%80%E4%BB%8B"><span class="nav-text">ProtoBufç®€ä»‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ONNX%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90"><span class="nav-text">ONNXæ ¼å¼åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#onnx-helper"><span class="nav-text">onnx.helper</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B0%83%E7%94%A8TensorRT%E7%9A%84%E6%96%B9%E6%A1%88"><span class="nav-text">è°ƒç”¨TensorRTçš„æ–¹æ¡ˆ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AF%BC%E5%87%BAONNX%E6%B3%A8%E6%84%8F%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-text">å¯¼å‡ºONNXæ³¨æ„çš„é—®é¢˜</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8A%A8%E6%80%81batch%E5%92%8C%E5%8A%A8%E6%80%81%E5%AE%BD%E9%AB%98"><span class="nav-text">åŠ¨æ€batchå’ŒåŠ¨æ€å®½é«˜</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%92%E4%BB%B6"><span class="nav-text">å®ç°ä¸€ä¸ªè‡ªå®šä¹‰æ’ä»¶</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B0%81%E8%A3%85"><span class="nav-text">å°è£…</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Tensor%E5%B0%81%E8%A3%85"><span class="nav-text">Tensorå°è£…</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Builder%E5%B0%81%E8%A3%85"><span class="nav-text">Builderå°è£…</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Infer%E5%B0%81%E8%A3%85"><span class="nav-text">Inferå°è£…</span></a></li></ol></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>
            
            

        </div>

        <div class="main-content-footer">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2023</span>
              -
            
            2023&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Airex Yu</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        è®¿é—®äººæ•°&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        æ€»è®¿é—®é‡&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">ç”± <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="åœ–å±¤_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" href="https://hexo.io">Hexo</a> é©±åŠ¨</span>
                <br>
            <span class="theme-version-container">ä¸»é¢˜&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.1.5</a>
        </div>
        
        
        
            <div id="start_div" style="display:none">
                2023/01/05 11:45:14
            </div>
            <div>
                åšå®¢å·²è¿è¡Œ <span class="odometer" id="runtime_days" ></span> å¤© <span class="odometer" id="runtime_hours"></span> å°æ—¶ <span class="odometer" id="runtime_minutes"></span> åˆ†é’Ÿ <span class="odometer" id="runtime_seconds"></span> ç§’
            </div>
        
        
        
            <script async data-pjax>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    


</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/layouts/navbarShrink.js"></script>

<script src="/js/tools/scrollTopBottom.js"></script>

<script src="/js/tools/lightDarkSwitch.js"></script>



    
<script src="/js/tools/localSearch.js"></script>




    
<script src="/js/tools/codeBlock.js"></script>




    
<script src="/js/layouts/lazyload.js"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js"></script>




    
<script src="/js/libs/mermaid.min.js"></script>

    
<script src="/js/plugins/mermaid.js"></script>





<div class="post-scripts pjax">
    
        
<script src="/js/tools/tocToggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/layouts/toc.js"></script>

<script src="/js/plugins/tabs.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax',
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            Global.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            Global.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            Global.refresh();
        });
    });
</script>




</body>
</html>
